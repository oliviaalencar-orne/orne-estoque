<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#FFFFFF" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0A0A0A" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Orne Decor - Gestão de Estoque</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js, PapaParse, SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- PDF.js para extração de texto de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* ===== BACKGROUNDS ===== */
            --bg-primary: #FFFFFF;
            --bg-secondary: #FAFAFA;
            --bg-tertiary: #F5F5F5;
            --bg-hover: #F0F0F0;
            --bg-active: #E8E8E8;
            --bg-elevated: #FFFFFF;

            /* ===== TEXT ===== */
            --text-primary: #171717;
            --text-secondary: #525252;
            --text-tertiary: #A3A3A3;
            --text-disabled: #D4D4D4;
            --text-heading: #000000;

            /* ===== BORDERS ===== */
            --border-default: #E5E5E5;
            --border-subtle: #EBEBEB;
            --border-strong: #D4D4D4;

            /* ===== ACCENT (dessaturados) ===== */
            --accent-primary: #3B6ECC;
            --accent-primary-hover: #335EAF;
            --accent-primary-subtle: rgba(59, 110, 204, 0.08);
            --accent-success: #3D8B5F;
            --accent-success-subtle: rgba(61, 139, 95, 0.08);
            --accent-warning: #C4873B;
            --accent-warning-subtle: rgba(196, 135, 59, 0.08);
            --accent-error: #C45151;
            --accent-error-subtle: rgba(196, 81, 81, 0.08);
            --accent-info: #5B8DB8;
            --accent-info-subtle: rgba(91, 141, 184, 0.08);

            /* ===== SURFACES ===== */
            --surface-overlay: rgba(0, 0, 0, 0.4);
            --surface-card: #FFFFFF;
            --surface-input: #FFFFFF;

            /* ===== NAV ===== */
            --nav-bg: rgba(255, 255, 255, 0.85);
            --nav-border: #E5E5E5;
            --nav-icon-default: #A3A3A3;
            --nav-icon-active: #171717;
            --nav-label-active: #171717;

            /* ===== LEGACY ALIASES (compatibilidade com inline styles) ===== */
            --bg-dark: #0A0A0A;
            --bg-darker: #000000;
            --text-muted: var(--text-tertiary);
            --text-light: #CCCCCC;
            --border: var(--border-default);
            --border-light: var(--border-subtle);
            --border-focus: var(--text-primary);
            --accent: var(--accent-primary);
            --accent-light: #D3E5FF;
            --accent-dark: #335EAF;
            --accent-bg: rgba(59, 110, 204, 0.08);
            --accent-gradient: var(--accent-primary);
            --purple: #7928CA;
            --purple-light: #D8B4FE;
            --purple-bg: #F5F0FF;
            --success: var(--accent-success);
            --success-light: var(--accent-success-subtle);
            --success-dark: #2E6B48;
            --warning: var(--accent-warning);
            --warning-light: var(--accent-warning-subtle);
            --warning-dark: #9A6B2E;
            --danger: var(--accent-error);
            --danger-light: var(--accent-error-subtle);
            --danger-dark: #9A3D3D;
            --info: var(--accent-info);
            --info-light: var(--accent-info-subtle);

            /* ===== CATEGORIAS ===== */
            --cat-green: #3D8B5F;
            --cat-blue: #3B6ECC;
            --cat-purple: #7928CA;
            --cat-pink: #C45186;
            --cat-orange: #C4873B;
            --cat-teal: #0D9488;
            --cat-gray: #525252;

            /* ===== SOMBRAS ===== */
            --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
            --shadow: 0 2px 4px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.08);
            --shadow-xl: 0 12px 24px rgba(0,0,0,0.1);
            --shadow-card: 0 0 0 1px var(--border-default);
            --shadow-card-hover: 0 0 0 1px var(--border-strong);

            /* ===== RADIUS ===== */
            --radius-xs: 4px;
            --radius-sm: 6px;
            --radius: 8px;
            --radius-lg: 10px;
            --radius-xl: 12px;
            --radius-2xl: 16px;

            /* ===== TRANSITIONS ===== */
            --transition: all 0.15s ease;
            --transition-slow: all 0.25s ease;
        }

        /* ===== DARK MODE ===== */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #0A0A0A;
                --bg-secondary: #111111;
                --bg-tertiary: #171717;
                --bg-hover: #1A1A1A;
                --bg-active: #222222;
                --bg-elevated: #141414;

                --text-primary: #EDEDED;
                --text-secondary: #A1A1A1;
                --text-tertiary: #6B6B6B;
                --text-disabled: #404040;
                --text-heading: #FFFFFF;

                --border-default: #262626;
                --border-subtle: #1F1F1F;
                --border-strong: #333333;

                --accent-primary: #5B8DEF;
                --accent-primary-hover: #7AA3F5;
                --accent-primary-subtle: rgba(91, 141, 239, 0.12);
                --accent-success: #5AAE7A;
                --accent-success-subtle: rgba(90, 174, 122, 0.12);
                --accent-warning: #D9A054;
                --accent-warning-subtle: rgba(217, 160, 84, 0.12);
                --accent-error: #D97070;
                --accent-error-subtle: rgba(217, 112, 112, 0.12);
                --accent-info: #7AAFDB;
                --accent-info-subtle: rgba(122, 175, 219, 0.12);

                --surface-overlay: rgba(0, 0, 0, 0.7);
                --surface-card: #141414;
                --surface-input: #171717;

                --nav-bg: rgba(10, 10, 10, 0.88);
                --nav-border: #262626;
                --nav-icon-default: #6B6B6B;
                --nav-icon-active: #EDEDED;
                --nav-label-active: #EDEDED;

                /* Legacy aliases dark overrides */
                --bg-dark: #0A0A0A;
                --bg-darker: #000000;
                --text-light: #404040;
                --accent-light: rgba(91, 141, 239, 0.2);
                --accent-dark: #7AA3F5;
                --accent-bg: rgba(91, 141, 239, 0.12);
                --purple-light: rgba(121, 40, 202, 0.3);
                --purple-bg: rgba(121, 40, 202, 0.12);
                --success-dark: #5AAE7A;
                --warning-dark: #D9A054;
                --danger-dark: #D97070;

                --shadow-xs: none;
                --shadow-sm: none;
                --shadow: none;
                --shadow-md: none;
                --shadow-lg: none;
                --shadow-xl: none;
                --shadow-card: 0 0 0 1px var(--border-default);
                --shadow-card-hover: 0 0 0 1px var(--border-strong);

                --cat-green: #5AAE7A;
                --cat-blue: #5B8DEF;
                --cat-purple: #A855F7;
                --cat-pink: #D97090;
                --cat-orange: #D9A054;
                --cat-teal: #2DD4BF;
                --cat-gray: #A1A1A1;
            }
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* ===== CONTAINER QUERIES ===== */
        .container-component { container-type: inline-size; }
        .container-card { container-type: inline-size; container-name: card; }

        /* ===== FOCUS & ACCESSIBILITY ===== */
        :focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        :focus:not(:focus-visible) { outline: none; }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* ===== VIEW TRANSITIONS ===== */
        ::view-transition-old(root) { animation: vt-fade-out 120ms ease-out; }
        ::view-transition-new(root) { animation: vt-fade-in 120ms ease-in; }
        @keyframes vt-fade-out { from { opacity: 1; } to { opacity: 0; } }
        @keyframes vt-fade-in { from { opacity: 0; } to { opacity: 1; } }

        .icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .icon svg {
            width: 100%;
            height: 100%;
        }

        /* ===================== LOGIN ===================== */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #000000;
            padding: 20px;
        }

        .login-box {
            background: var(--bg-secondary);
            padding: 48px 40px;
            border-radius: var(--radius-2xl);
            border: 1px solid #333;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .login-logo { max-width: 100px; margin-bottom: 24px; }
        .login-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary); letter-spacing: -0.3px; }
        .login-subtitle { color: var(--text-muted); margin-bottom: 32px; font-size: 14px; font-weight: 400; line-height: 1.5; }

        .login-form { display: flex; flex-direction: column; gap: 16px; }
        .login-form .form-group { text-align: left; margin-bottom: 0; }
        .login-form .form-label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; color: var(--text-secondary); }
        .login-form .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            transition: var(--transition);
            background: var(--bg-secondary);
        }
        .login-form .form-input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 1px var(--border-focus);
        }

        .btn-login {
            width: 100%;
            padding: 10px;
            background: #0A0A0A;
            color: #FFFFFF;
            border: 1px solid #0A0A0A;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 8px;
        }
        .btn-login:hover {
            background: #333333;
            border-color: #333333;
        }
        .btn-login:disabled {
            background: var(--border);
            border-color: var(--border);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        .login-error {
            background: var(--danger-light);
            color: var(--danger-dark);
            padding: 12px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            margin-top: 12px;
            font-weight: 500;
        }

        .login-toggle { margin-top: 20px; color: var(--text-muted); font-size: 13px; }
        .login-toggle button {
            background: none;
            border: none;
            color: var(--accent);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }
        .login-toggle button:hover { color: var(--accent-dark); }

        /* ===================== LOADING ===================== */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            gap: 16px;
            background: var(--bg-primary);
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 2px solid var(--border);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===================== LAYOUT ===================== */
        .app-container { display: flex; min-height: 100vh; }

        /* ===================== SIDEBAR ===================== */
        .sidebar {
            width: 240px;
            background: #0A0A0A;
            color: white;
            padding: 24px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #1A1A1A;
        }

        .logo-container {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            margin-bottom: 8px;
            text-align: center;
        }

        .logo {
            width: 100%;
            max-width: 90px;
            filter: brightness(0) invert(1);
            margin: 0 auto;
            display: block;
        }

        .store-name {
            display: none;
        }

        .user-info {
            padding: 14px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            margin-bottom: 8px;
        }

        .user-email {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 10px;
            word-break: break-all;
            font-weight: 400;
        }

        .btn-logout {
            width: 100%;
            padding: 8px;
            background: transparent;
            color: rgba(255,255,255,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 400;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: inherit;
        }
        .btn-logout:hover { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.8); }

        .nav-menu {
            list-style: none;
            padding: 0 12px;
            flex: 1;
        }
        .nav-item { margin-bottom: 1px; }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            color: rgba(255,255,255,0.5);
            text-decoration: none;
            border-radius: var(--radius-sm);
            font-weight: 400;
            font-size: 13px;
            transition: var(--transition);
            cursor: pointer;
        }
        .nav-link:hover {
            background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.9);
        }
        .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: #FFFFFF;
            font-weight: 500;
        }

        .nav-icon { width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; color: currentColor; flex-shrink: 0; }
        .nav-icon svg { width: 16px; height: 16px; }

        .nav-section {
            font-size: 11px;
            font-weight: 600;
            color: rgba(255,255,255,0.25);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            padding: 18px 12px 6px;
            margin-top: 2px;
        }

        /* ===================== MAIN ===================== */
        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 28px 32px;
            min-height: 100vh;
            background: var(--bg-primary);
        }

        /* ===================== SYNC STATUS ===================== */
        .sync-status {
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: var(--radius);
            font-size: 11px;
            color: var(--text-muted);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 400;
        }

        .sync-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
        }
        .sync-indicator.offline { background: var(--danger); }
        .sync-indicator.syncing { background: var(--warning); animation: pulse 1s infinite; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* ===================== PAGE HEADER ===================== */
        .page-header {
            margin-bottom: 24px;
        }

        .page-header-flex {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
            letter-spacing: -0.5px;
            line-height: 1.2;
        }

        .page-subtitle {
            font-size: 14px;
            font-weight: 400;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .page-greeting {
            font-size: 13px;
            font-weight: 400;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        /* ===================== CARDS ===================== */
        .card {
            background: var(--surface-card);
            border-radius: var(--radius-xl);
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid var(--border-default);
            box-shadow: none;
            transition: var(--transition);
            container-type: inline-size;
        }

        .card:hover {
            border-color: var(--border-strong);
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            letter-spacing: -0.1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title-icon {
            width: 16px;
            height: 16px;
            display: inline-flex;
            color: var(--text-secondary);
        }

        /* ===================== STATS GRID - NOVO DESIGN ===================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--surface-card);
            padding: 20px;
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-default);
            box-shadow: none;
            transition: var(--transition);
            position: relative;
            container-type: inline-size;
            container-name: card;
        }

        .stat-card:hover {
            border-color: var(--border-strong);
        }

        .stat-card.accent {
            background: var(--surface-card);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
        }
        .stat-card.accent .stat-label { color: var(--text-tertiary); }
        .stat-card.accent .stat-value { color: var(--text-primary); }
        .stat-card.accent .stat-icon { background: var(--bg-tertiary); }
        .stat-card.accent .stat-trend { color: var(--accent-success); background: var(--accent-success-subtle); }

        .stat-card.dark {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        .stat-card.dark .stat-label { color: var(--text-muted); }
        .stat-card.dark .stat-value { color: var(--text-primary); }
        .stat-card.dark .stat-icon { background: var(--bg-tertiary); }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius);
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--text-secondary);
        }

        .stat-icon.green { background: var(--accent-success-subtle); color: var(--accent-success); }
        .stat-icon.red { background: var(--accent-error-subtle); color: var(--accent-error); }
        .stat-icon.yellow { background: var(--accent-warning-subtle); color: var(--accent-warning); }
        .stat-icon.blue { background: var(--accent-info-subtle); color: var(--accent-info); }
        .stat-icon.purple { background: rgba(123,110,237,0.08); color: #7B6EED; }

        .stat-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 999px;
            background: var(--success-light);
            color: var(--success-dark);
        }

        .stat-trend.down {
            background: var(--danger-light);
            color: var(--danger-dark);
        }

        .stat-trend.neutral {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        .stat-content {
            margin-top: auto;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.1;
            margin-bottom: 2px;
            letter-spacing: -0.5px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .stat-card.warning { border-left: 3px solid var(--accent-warning); }
        .stat-card.warning .stat-value { color: var(--text-primary); }
        .stat-card.warning .stat-icon { background: var(--accent-warning-subtle); }

        .stat-card.danger { border-left: 3px solid var(--accent-error); }
        .stat-card.danger .stat-value { color: var(--text-primary); }
        .stat-card.danger .stat-icon { background: var(--accent-error-subtle); }

        /* ===================== PERIOD TOGGLE ===================== */
        .period-toggle { display: inline-flex; gap: 4px; background: var(--bg-tertiary); border-radius: var(--radius); padding: 3px; }
        .period-btn { padding: 5px 12px; border: none; background: transparent; border-radius: var(--radius-sm); font-size: 12px; font-weight: 500; color: var(--text-tertiary); cursor: pointer; transition: var(--transition); font-family: inherit; }
        .period-btn:hover { color: var(--text-secondary); }
        .period-btn.active { background: var(--surface-card); color: var(--text-primary); box-shadow: var(--shadow-xs); }

        /* ===================== ANALYTICS GRID ===================== */
        .dashboard-analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 16px; }

        /* ===================== CLICKABLE TABLE ROW ===================== */
        .table tr.clickable-row { cursor: pointer; }
        .table tr.clickable-row:hover td { background: var(--bg-hover); }

        /* ===================== CATEGORY CARDS ===================== */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }

        .category-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 16px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
        }

        .category-card:hover {
            border-color: #CCCCCC;
        }

        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin: 0 auto 10px;
        }

        .category-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .category-count {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .category-meta {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .category-alert {
            font-size: 12px;
            color: var(--accent-warning);
            background: var(--accent-warning-subtle);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            margin-top: 8px;
            display: inline-block;
            font-weight: 600;
        }

        /* ===================== FORMS ===================== */
        .form-group { margin-bottom: 16px; }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #333333;
            margin-bottom: 6px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            transition: var(--transition);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 1px var(--border-focus);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-help {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .form-radio-group {
            display: flex;
            gap: 12px;
        }

        .form-radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            cursor: pointer;
            padding: 8px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .form-radio-label:has(input:checked) {
            border-color: var(--border-focus);
            background: var(--bg-tertiary);
        }

        .form-radio-label input { accent-color: var(--text-primary); }

        /* ===================== BUTTONS ===================== */
        .btn {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-family: inherit;
        }

        .btn-primary {
            background: #0A0A0A;
            color: #FFFFFF;
            border-color: #0A0A0A;
        }
        .btn-primary:hover {
            background: #333333;
            border-color: #333333;
        }
        .btn-primary:disabled {
            background: var(--border);
            border-color: var(--border);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: #CCCCCC;
        }

        .btn-success {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        .btn-success:hover {
            background: var(--success-dark);
            border-color: var(--success-dark);
        }

        .btn-danger {
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger-light);
        }
        .btn-danger:hover {
            background: var(--danger-light);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-lg {
            padding: 10px 24px;
            font-size: 14px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }
        .btn-icon:hover {
            background: var(--bg-tertiary);
            border-color: #CCCCCC;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* ===================== ALERTS ===================== */
        .alert {
            padding: 12px 16px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-success {
            background: var(--success-light);
            color: var(--success-dark);
            border: 1px solid #C6F6D5;
        }
        .alert-danger {
            background: var(--danger-light);
            color: var(--danger-dark);
            border: 1px solid #FED7D7;
        }
        .alert-warning {
            background: var(--warning-light);
            color: var(--warning-dark);
            border: 1px solid #FEEBC8;
        }
        .alert-info {
            background: var(--info-light);
            color: var(--accent);
            border: 1px solid var(--accent-light);
        }

        /* ===================== FILTER TABS ===================== */
        .filter-tabs {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0;
        }

        .filter-tab {
            padding: 8px 14px;
            border-radius: 0;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            margin-bottom: -1px;
        }

        .filter-tab:hover { color: var(--text-primary); }
        .filter-tab.active {
            background: transparent;
            color: var(--text-primary);
            border-bottom-color: var(--text-primary);
        }

        /* ===================== STOCK CATEGORY TABS ===================== */
        .stock-category-tabs {
            display: flex;
            gap: 0;
            overflow-x: auto;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
            border-bottom: 1px solid var(--border-default);
            margin-bottom: 16px;
        }
        .stock-category-tabs::-webkit-scrollbar { display: none; }

        .stock-category-tab {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 400;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            flex-shrink: 0;
            font-family: inherit;
        }
        .stock-category-tab:hover { background: var(--bg-hover); color: var(--text-primary); }
        .stock-category-tab.active { color: var(--text-primary); font-weight: 600; border-bottom-color: var(--accent-primary); }
        .stock-category-tab .tab-count { font-weight: 400; color: var(--text-tertiary); font-size: 12px; }
        .stock-category-tab.active .tab-count { color: var(--text-secondary); }

        /* ===================== SEARCH ===================== */
        .search-box {
            position: relative;
            margin-bottom: 16px;
        }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 14px;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px 8px 32px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 13px;
            background: var(--bg-secondary);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 1px var(--border-focus);
        }

        /* ===================== PRODUCTS GRID ===================== */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .product-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 16px;
            transition: var(--transition);
            position: relative;
        }

        .product-card:hover {
            border-color: var(--border-strong);
        }

        .product-card.low { border-left: 3px solid var(--accent-warning); }
        .product-card.empty { border-left: 3px solid var(--accent-error); }

        .product-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 2px;
            opacity: 0.5;
            transition: opacity 0.15s;
        }
        .product-card:hover .product-actions { opacity: 1; }

        .category-card-actions {
            opacity: 0.5;
            transition: opacity 0.15s;
        }
        .category-card-item:hover .category-card-actions { opacity: 1; }

        .product-category-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .product-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            line-height: 1.4;
            padding-right: 70px;
        }

        .product-sku {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
            font-family: monospace;
        }

        .product-obs {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 8px 10px;
            border-radius: var(--radius-sm);
            margin: 10px 0;
            font-style: italic;
            border-left: 2px solid var(--border);
        }

        .product-quantity {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 12px 0 6px;
        }

        .product-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-ok { background: var(--accent-success-subtle); color: var(--accent-success); }
        .status-low { background: var(--accent-warning-subtle); color: var(--accent-warning); }
        .status-empty { background: var(--accent-error-subtle); color: var(--accent-error); }

        .product-price { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
        .product-value { font-size: 13px; font-weight: 500; color: var(--text-primary); margin-top: 4px; }

        /* ===================== TABLES ===================== */
        .table-container { overflow-x: auto; }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .table th {
            text-align: left;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        .table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
        }

        .table tr:hover td { background: var(--bg-tertiary); }

        /* ===================== BADGES ===================== */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 500;
        }

        .badge-success { background: var(--accent-success-subtle); color: var(--accent-success); border: 1px solid rgba(61, 139, 95, 0.15); }
        .badge-warning { background: var(--accent-warning-subtle); color: var(--accent-warning); border: 1px solid rgba(196, 135, 59, 0.15); }
        .badge-danger { background: var(--accent-error-subtle); color: var(--accent-error); border: 1px solid rgba(196, 81, 81, 0.15); }
        .badge-info { background: var(--accent-info-subtle); color: var(--accent-info); border: 1px solid rgba(91, 141, 184, 0.15); }

        /* ===================== MODAL ===================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: 0 16px 48px rgba(0,0,0,0.2);
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: -0.2px;
        }

        .modal-subtitle {
            font-size: 13px;
            font-weight: 400;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        /* ===================== CHART ===================== */
        .chart-container {
            height: 260px;
            position: relative;
        }

        /* ===================== EMPTY STATE ===================== */
        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            margin-bottom: 16px;
            color: var(--text-light);
            display: flex;
            justify-content: center;
        }

        .empty-state h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .empty-state p {
            font-size: 13px;
        }

        /* ===================== FADE IN ===================== */
        .fade-in {
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===================== COLOR PICKER ===================== */
        .color-picker {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 24px;
            height: 24px;
            border-radius: var(--radius-xs);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .color-option:hover { transform: scale(1.1); }
        .color-option.selected { border-color: var(--text-primary); box-shadow: 0 0 0 1px var(--text-primary); }

        /* ===================== DASHBOARD GRID (extraído de inline) ===================== */
        .dashboard-main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        /* ===================== PERFORMANCE ===================== */
        .card, .stat-card, .product-card, .category-card {
            contain: layout style;
        }
        .stat-value, .product-quantity, .category-count {
            font-variant-numeric: tabular-nums;
        }

        /* ===================== SKELETON LOADING ===================== */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-secondary) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: skeleton-pulse 1.5s ease-in-out infinite;
            border-radius: var(--radius);
        }
        @keyframes skeleton-pulse {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ===================== MOBILE HEADER ===================== */
        .mobile-header { display: none; }

        /* ===================== BOTTOM NAV ===================== */
        .mobile-bottom-nav { display: none; }

        /* ===================== SIDEBAR OVERLAY ===================== */
        .sidebar-overlay {
            display: none;
        }

        /* ===================== BOTTOM SHEET ===================== */
        .bottom-sheet-overlay {
            position: fixed;
            inset: 0;
            background: var(--surface-overlay);
            z-index: 10001;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
        }
        .bottom-sheet-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-elevated);
            border-radius: 16px 16px 0 0;
            z-index: 10002;
            transform: translateY(100%);
            transition: transform 0.25s cubic-bezier(0.32, 0.72, 0, 1);
            padding-bottom: env(safe-area-inset-bottom);
            max-height: 70vh;
            overflow-y: auto;
            will-change: transform;
            border-top: 1px solid var(--border-default);
        }
        .bottom-sheet.open {
            transform: translateY(0);
        }
        .bottom-sheet-handle {
            width: 36px;
            height: 4px;
            border-radius: 2px;
            background: var(--border-strong);
            margin: 8px auto 16px;
        }
        .bottom-sheet-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            padding: 0 20px 12px;
            border-bottom: 1px solid var(--border-subtle);
            margin-bottom: 4px;
        }
        .bottom-sheet-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            border: none;
            background: none;
            width: 100%;
            font-family: inherit;
            font-size: 15px;
            color: var(--text-primary);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            text-align: left;
            transition: background 0.1s ease;
        }
        .bottom-sheet-item:active {
            background: var(--bg-hover);
        }
        .bottom-sheet-item .icon {
            color: var(--text-secondary);
        }

        /* ===================== TOAST ===================== */
        .toast-container {
            position: fixed;
            bottom: calc(80px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            z-index: 11000;
            pointer-events: none;
        }
        .toast {
            padding: 12px 20px;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            pointer-events: auto;
            animation: toast-in 0.25s ease-out;
            background: var(--text-primary);
            color: var(--bg-primary);
            will-change: opacity, transform;
            white-space: nowrap;
        }
        @keyframes toast-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===================== RESPONSIVE — MOBILE < 640px ===================== */
        @media (max-width: 639px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .stat-card { padding: 16px; }
            .stat-value { font-size: 22px; }

            .dashboard-main-grid { grid-template-columns: 1fr; }
            .dashboard-analytics-grid { grid-template-columns: 1fr; }

            .products-grid { grid-template-columns: 1fr; gap: 12px; }
            .product-card { padding: 16px; }

            .category-grid { grid-template-columns: repeat(2, 1fr); }

            .table-container {
                margin-left: -16px;
                margin-right: -16px;
                border-radius: 0;
                border-left: none;
                border-right: none;
            }
            .table th, .table td { padding: 8px 10px; font-size: 12px; }
            .table th:first-child, .table td:first-child { padding-left: 16px; }
            .table th:last-child, .table td:last-child { padding-right: 16px; }

            .form-input, .form-select, .form-textarea {
                height: 44px;
                font-size: 16px; /* previne zoom no iOS */
            }
            .form-row { grid-template-columns: 1fr; }

            .btn { min-height: 44px; }
            .btn-group { flex-direction: column; }
            .btn-group .btn { width: 100%; }

            .filter-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                flex-wrap: nowrap;
                gap: 0;
                padding: 0 16px;
                margin: 0 -16px;
            }
            .filter-tabs::-webkit-scrollbar { display: none; }
            .filter-tab { white-space: nowrap; flex-shrink: 0; }

            .stock-category-tabs { padding: 0 16px; margin: 0 -16px 16px; }
            .stock-category-tab { padding: 8px 12px; font-size: 12px; }

            .page-title { font-size: 22px; }

            .modal-overlay { align-items: flex-end; }
            .modal-content {
                max-width: 100%;
                width: 100%;
                border-radius: 16px 16px 0 0;
                max-height: 85vh;
                overflow-y: auto;
                margin: 0;
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
            }
            .modal-content::before {
                content: '';
                display: block;
                width: 36px;
                height: 4px;
                border-radius: 2px;
                background: var(--border-strong);
                margin: 0 auto 16px;
            }

            .login-container { padding: 0; }
            .login-box {
                padding: 24px 20px;
                width: 100%;
                max-width: 100%;
                border-radius: 0;
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .search-box { width: 100%; }
        }

        /* ===================== RESPONSIVE — MOBILE/TABLET < 1024px ===================== */
        @media (max-width: 1023px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
                width: 280px;
                z-index: 10000;
                transition: left 0.25s cubic-bezier(0.32, 0.72, 0, 1);
                overflow-y: auto;
                will-change: left;
            }
            .sidebar.open { left: 0; }

            .sidebar-overlay {
                display: block;
                position: fixed;
                inset: 0;
                background: var(--surface-overlay);
                z-index: 9999;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.25s ease;
            }
            .sidebar-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }

            .main-content {
                margin-left: 0 !important;
                padding: 16px !important;
                padding-top: calc(48px + env(safe-area-inset-top) + 16px) !important;
                padding-bottom: calc(64px + env(safe-area-inset-bottom) + 16px) !important;
                min-height: 100vh;
            }

            .mobile-header {
                display: flex;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 8999;
                background: var(--nav-bg);
                backdrop-filter: blur(20px) saturate(180%);
                -webkit-backdrop-filter: blur(20px) saturate(180%);
                border-bottom: 1px solid var(--nav-border);
                padding-top: env(safe-area-inset-top);
                height: calc(48px + env(safe-area-inset-top));
                align-items: center;
                justify-content: space-between;
                padding-left: 16px;
                padding-right: 16px;
            }
            .mobile-header-title {
                font-size: 18px;
                font-weight: 600;
                color: var(--text-primary);
                letter-spacing: -0.02em;
            }
            .mobile-header-actions {
                display: flex;
                gap: 12px;
                align-items: center;
            }
            .mobile-avatar {
                width: 28px;
                height: 28px;
                border-radius: 50%;
                background: var(--bg-tertiary);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 11px;
                font-weight: 600;
                color: var(--text-secondary);
                border: 1px solid var(--border-default);
            }

            .mobile-bottom-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 9000;
                background: var(--nav-bg);
                backdrop-filter: blur(20px) saturate(180%);
                -webkit-backdrop-filter: blur(20px) saturate(180%);
                border-top: 1px solid var(--nav-border);
                padding-bottom: env(safe-area-inset-bottom);
                height: calc(64px + env(safe-area-inset-bottom));
                justify-content: space-around;
                align-items: center;
            }
            .mobile-bottom-nav .nav-tab {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 2px;
                padding: 8px 0;
                min-width: 56px;
                min-height: 44px;
                background: none;
                border: none;
                cursor: pointer;
                color: var(--nav-icon-default);
                font-size: 10px;
                font-weight: 500;
                font-family: inherit;
                -webkit-tap-highlight-color: transparent;
                transition: color 0.15s ease;
                position: relative;
            }
            .mobile-bottom-nav .nav-tab.active {
                color: var(--nav-icon-active);
                font-weight: 600;
            }
            .mobile-bottom-nav .nav-tab.active::after {
                content: '';
                position: absolute;
                bottom: 6px;
                left: 50%;
                transform: translateX(-50%);
                width: 4px;
                height: 4px;
                border-radius: 50%;
                background: var(--nav-icon-active);
            }
            .mobile-bottom-nav .nav-tab.action-btn {
                color: var(--accent-primary);
            }
            .mobile-bottom-nav .nav-tab.action-btn::after { display: none; }

            .sync-status {
                bottom: calc(72px + env(safe-area-inset-bottom));
            }

            .page-header { margin-bottom: 16px; }
        }

        /* ===================== RESPONSIVE — TABLET 640-1023px ===================== */
        @media (min-width: 640px) and (max-width: 1023px) {
            .main-content { padding: 24px !important; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .products-grid { grid-template-columns: repeat(2, 1fr); }
            .dashboard-main-grid { grid-template-columns: 1fr; }
            .dashboard-analytics-grid { grid-template-columns: 1fr 1fr; }
        }

        /* ===================== DESKTOP >= 1024px ===================== */
        @media (min-width: 1024px) {
            .mobile-bottom-nav,
            .mobile-header,
            .sidebar-overlay { display: none !important; }
        }

        /* ===================== TOUCH OPTIMIZATION ===================== */
        @media (pointer: coarse) {
            .btn, .nav-link, .filter-tab, .stock-category-tab, .bottom-sheet-item { min-height: 44px; }
            .btn:active { transform: scale(0.97); transition: transform 0.1s ease; }
            .nav-tab:active { transform: scale(0.95); }
        }

        @media (hover: hover) {
            .btn-primary:hover { background: #333333; }
            .btn-secondary:hover { background: var(--bg-tertiary); }
            .btn-danger:hover { background: var(--accent-error-subtle); }
            .btn-icon:hover { background: var(--bg-tertiary); }
            .product-card:hover { box-shadow: var(--shadow-card-hover); }
            .stat-card:hover { box-shadow: var(--shadow-card-hover); }
        }
        @media (hover: none) {
            .btn-primary:hover,
            .btn-secondary:hover,
            .btn-danger:hover,
            .btn-icon:hover,
            .product-card:hover,
            .stat-card:hover { /* noop — remove hover on touch */ }
        }

        /* ===================== PERFORMANCE — LONG LISTS ===================== */
        .table tbody tr {
            content-visibility: auto;
            contain-intrinsic-size: auto 44px;
        }
        .products-grid .product-card {
            content-visibility: auto;
            contain-intrinsic-size: auto 180px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // ==========================================
        // SUPABASE CONFIG
        // ==========================================
        const SUPABASE_URL = 'https://ppslljqxsdsdmwfiayok.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwc2xsanF4c2RzZG13ZmlheW9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDUzNjQsImV4cCI6MjA4NjIyMTM2NH0.-7oJxDaw2nwc2uN410OGwavefzjZ-AjfmkK8QxpB7cM';

        let supabaseClient;
        let supabaseInitialized = false;

        try {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            supabaseInitialized = true;
        } catch (error) {
            console.error('Supabase init error:', error);
        }

        // Handle Tiny ERP OAuth callback in popup window
        (function handleTinyCallback() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            if (code && window.location.pathname === '/tiny-callback') {
                if (window.opener) {
                    window.opener.postMessage({ type: 'tiny_oauth_callback', code }, window.location.origin);
                    document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:Inter,sans-serif;color:#666">Autorizado! Fechando...</div>';
                    setTimeout(() => window.close(), 1500);
                }
            }
        })();

        // ==========================================
        // SUPABASE HELPERS
        // ==========================================
        // Mapeamento snake_case -> camelCase para leitura
        const mapProductFromDB = (row) => ({
            id: row.id, name: row.name, sku: row.sku, ean: row.ean || '',
            category: row.category || '', minStock: row.min_stock || 3,
            observations: row.observations || '', nfOrigem: row.nf_origem || '',
            unitPrice: parseFloat(row.unit_price) || 0,
            tinyId: row.tiny_id || '',
            local: row.local || '',
            createdAt: row.created_at
        });

        const formatBRL = (value) => Number(value || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const parseBRL = (str) => parseFloat((str || '0').replace(/\./g, '').replace(',', '.')) || 0;

        const mapEntryFromDB = (row) => ({
            id: row.id, type: row.type, sku: row.sku, quantity: row.quantity,
            supplier: row.supplier || '', nf: row.nf || '', localEntrada: row.local_entrada || '',
            date: row.date, userId: row.user_id || ''
        });
        const mapExitFromDB = (row) => ({
            id: row.id, type: row.type, sku: row.sku, quantity: row.quantity,
            client: row.client || '', nf: row.nf || '', nfOrigem: row.nf_origem || null,
            date: row.date, userId: row.user_id || ''
        });
        const mapShippingFromDB = (row) => ({
            id: row.id, nfNumero: row.nf_numero || '', cliente: row.cliente || '',
            destino: row.destino || '', localOrigem: row.local_origem || '',
            transportadora: row.transportadora || '', codigoRastreio: row.codigo_rastreio || '',
            linkRastreio: row.link_rastreio || '', melhorEnvioId: row.melhor_envio_id || '',
            produtos: row.produtos || [], observacoes: row.observacoes || '',
            status: row.status || 'PENDENTE', date: row.date, userId: row.user_id || '',
            ultimaAtualizacaoRastreio: row.ultima_atualizacao_rastreio || '',
            rastreioInfo: row.rastreio_info || null
        });

        // Helper generico para fetch inicial + realtime subscription (com debounce)
        function setupSupabaseCollection(tableName, setState, options = {}) {
            const { transform, filter, onLoaded, selectFields, dbFilter } = options;

            // Fetch inicial com campos específicos e filtros de banco opcionais
            let query = supabaseClient.from(tableName).select(selectFields || '*');
            if (dbFilter) query = dbFilter(query);

            query.then(({ data, error }) => {
                if (error) { console.error('Erro ao buscar ' + tableName + ':', error); return; }
                const items = transform ? data.map(transform) : data;
                const filtered = filter ? items.filter(filter) : items;
                setState(filtered);
                if (onLoaded) onLoaded(filtered, data);
            });

            // Realtime com DEBOUNCE — acumula mudanças e aplica em batch
            let pendingChanges = [];
            let debounceTimer = null;

            const applyPendingChanges = () => {
                if (pendingChanges.length === 0) return;
                const changes = [...pendingChanges];
                pendingChanges = [];

                // Muitas mudanças (sync em andamento) → refetch completo
                if (changes.length > 20) {
                    let refetchQuery = supabaseClient.from(tableName).select(selectFields || '*');
                    if (dbFilter) refetchQuery = dbFilter(refetchQuery);
                    refetchQuery.then(({ data }) => {
                        if (!data) return;
                        const items = transform ? data.map(transform) : data;
                        const filtered = filter ? items.filter(filter) : items;
                        setState(filtered);
                    });
                    return;
                }

                // Poucas mudanças: aplicar incrementalmente
                setState(prev => {
                    let updated = [...prev];
                    for (const { eventType, newRec, oldRec } of changes) {
                        if (eventType === 'INSERT') {
                            const item = transform ? transform(newRec) : newRec;
                            if (!filter || filter(item)) {
                                if (!updated.find(i => i.id === item.id)) updated.push(item);
                            }
                        } else if (eventType === 'UPDATE') {
                            const item = transform ? transform(newRec) : newRec;
                            const idx = updated.findIndex(i => i.id === item.id);
                            if (idx >= 0) updated[idx] = item;
                            else if (!filter || filter(item)) updated.push(item);
                        } else if (eventType === 'DELETE') {
                            updated = updated.filter(i => i.id !== (oldRec && oldRec.id));
                        }
                    }
                    return updated;
                });
            };

            const channel = supabaseClient
                .channel(tableName + '-realtime')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: tableName },
                    (payload) => {
                        pendingChanges.push({
                            eventType: payload.eventType,
                            newRec: payload.new,
                            oldRec: payload.old,
                        });
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(applyPendingChanges, 500);
                    }
                )
                .subscribe();

            return channel;
        }

        // Helper para buscar TODOS os registros de uma tabela (sem limite de 1000)
        async function fetchAllRows(tableName, selectFields = '*', filters = []) {
            const PAGE_SIZE = 1000;
            let allData = [];
            let from = 0;
            let hasMore = true;
            while (hasMore) {
                let query = supabaseClient.from(tableName).select(selectFields);
                for (const f of filters) query = f(query);
                query = query.range(from, from + PAGE_SIZE - 1);
                const { data, error } = await query;
                if (error) { console.error(`Erro ao buscar ${tableName}:`, error); break; }
                if (!data || data.length === 0) break;
                allData = allData.concat(data);
                if (data.length < PAGE_SIZE) break;
                from += PAGE_SIZE;
            }
            return allData;
        }

        const generateId = () => Math.random().toString(36).substr(2, 9);

        // ==========================================
        // SVG ICON SYSTEM
        // ==========================================
        const ICONS = {
            dashboard: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>',
            stock: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16.5 9.4l-9-5.19M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>',
            addProduct: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>',
            categories: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>',
            entry: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>',
            exit: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>',
            shipping: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>',
            import: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
            history: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
            edit: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
            delete: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>',
            search: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
            add: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
            close: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
            settings: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>',
            refresh: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>',
            link: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>',
            clipboard: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/><line x1="8" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="12" y2="18"/></svg>',
            filter: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>',
            download: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
            file: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
            check: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
            warning: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
            error: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
            info: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
            share: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>',
            logout: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',
            success: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
            spinner: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>',
            empty: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/></svg>',
            chart: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
            excel: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>',
            lightbulb: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18h6M10 22h4M12 2a7 7 0 00-4 12.7V17h8v-2.3A7 7 0 0012 2z"/></svg>',
            label: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>',
            boxOpen: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/><path d="M7.5 4.5L16.5 9.5"/></svg>',
            // Category icons
            catLamp: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M12 2a7 7 0 00-4 12.7V17h8v-2.3A7 7 0 0012 2z"/></svg>',
            catChandelier: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="5"/><path d="M5 5h14"/><line x1="5" y1="5" x2="5" y2="9"/><line x1="12" y1="5" x2="12" y2="9"/><line x1="19" y1="5" x2="19" y2="9"/><circle cx="5" cy="11" r="2"/><circle cx="12" cy="11" r="2"/><circle cx="19" cy="11" r="2"/></svg>',
            catWallLight: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="6" width="4" height="12" rx="1"/><path d="M7 12h3l4-6h4"/><path d="M10 12l4 6h4"/><line x1="18" y1="6" x2="18" y2="18"/></svg>',
            catPendant: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="8"/><path d="M6 8h12l-2 10H8L6 8z"/><line x1="9" y1="21" x2="15" y2="21"/></svg>',
            catCeiling: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="2" x2="20" y2="2"/><line x1="12" y1="2" x2="12" y2="6"/><ellipse cx="12" cy="10" rx="8" ry="4"/><path d="M4 10v2a8 4 0 0016 0v-2"/></svg>',
            catSpot: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 5V3"/><path d="M17 7l1.4-1.4"/><path d="M19 12h2"/><path d="M17 17l1.4 1.4"/><path d="M12 19v2"/><path d="M7 17l-1.4 1.4"/><path d="M5 12H3"/><path d="M7 7L5.6 5.6"/></svg>',
            catOther: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>',
            catStar: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
            catCircle: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>',
            catHexagon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>',
            catDiamond: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="4.5" y="4.5" width="15" height="15" rx="1" transform="rotate(45 12 12)"/></svg>',
            catTriangle: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>',
            catSquare: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>',
            // Integration icons
            tiny: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>',
            sync: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>',
            cloud: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 109 20h9a5 5 0 000-10z"/></svg>',
            plug: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v6"/><path d="M6 2v6"/><path d="M4 8h14a1 1 0 011 1v2a6 6 0 01-12 0V9a1 1 0 011-1"/><path d="M9 17v5"/></svg>',
            // Mobile nav icons (Lucide style)
            layoutDashboard: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></svg>',
            package: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>',
            plusCircle: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>',
            arrowLeftRight: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="8 3 4 7 8 11"/><line x1="4" y1="7" x2="20" y2="7"/><polyline points="16 21 20 17 16 13"/><line x1="20" y1="17" x2="4" y2="17"/></svg>',
            menuIcon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/></svg>',
            chevronRight: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>',
            bell: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>',
            user: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
            dollar: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>',
            trendingUp: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
            pause: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>',
            mapPin: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>',
        };

        function Icon({ name, size = 16, className = '', style = {} }) {
            return <span className={`icon ${className}`}
                style={{width: size, height: size, display: 'inline-flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0, ...style}}
                dangerouslySetInnerHTML={{__html: ICONS[name] || ''}} />;
        }

        // Category icon system
        const CATEGORY_ICON_OPTIONS = [
            { id: 'catLamp', label: 'Abajur' },
            { id: 'catWallLight', label: 'Arandela' },
            { id: 'catChandelier', label: 'Lustre' },
            { id: 'catPendant', label: 'Pendente' },
            { id: 'catCeiling', label: 'Plafon' },
            { id: 'catSpot', label: 'Spot' },
            { id: 'catStar', label: 'Estrela' },
            { id: 'catCircle', label: 'Círculo' },
            { id: 'catHexagon', label: 'Hexágono' },
            { id: 'catDiamond', label: 'Losango' },
            { id: 'catTriangle', label: 'Triângulo' },
            { id: 'catSquare', label: 'Quadrado' },
            { id: 'catOther', label: 'Outros' },
        ];

        // Map old unicode icons to new SVG icon IDs
        const UNICODE_TO_SVG = {
            '◐': 'catLamp', '◑': 'catWallLight', '◇': 'catPendant', '✦': 'catChandelier',
            '○': 'catCeiling', '◉': 'catSpot', '◻': 'catSquare', '△': 'catTriangle',
            '▽': 'catDiamond', '◈': 'catStar', '⬡': 'catHexagon', '▣': 'catOther',
        };

        function resolveCatIcon(icon) {
            if (!icon) return 'catSquare';
            if (ICONS[icon]) return icon;
            return UNICODE_TO_SVG[icon] || 'catSquare';
        }

        function CategoryIcon({ icon, size = 18, color, style = {} }) {
            const resolved = resolveCatIcon(icon);
            return <span className="icon"
                style={{width: size, height: size, display: 'inline-flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0, color: color || 'currentColor', ...style}}
                dangerouslySetInnerHTML={{__html: ICONS[resolved] || ''}} />;
        }

        // ==========================================
        // LOGIN SCREEN
        // ==========================================
        // ==========================================
        // PENDING APPROVAL SCREEN
        // ==========================================
        function PendingApprovalScreen({ onLogout }) {
            return (
                <div className="login-container">
                    <div className="login-box">
                        <img src="logo-orne.png" alt="Orne" className="login-logo" onError={(e) => e.target.style.display='none'} />
                        <div style={{textAlign: 'center', marginBottom: '16px'}}>
                            <div style={{width: '48px', height: '48px', borderRadius: '50%', background: 'var(--accent-warning-subtle)', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 16px'}}>
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent-warning)" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            </div>
                            <h1 className="login-title">Aguardando Aprovação</h1>
                            <p className="login-subtitle" style={{marginTop: '8px', lineHeight: '1.6'}}>
                                Seu cadastro está sendo analisado pelo administrador.
                                <br/>Você receberá acesso assim que for aprovado.
                            </p>
                        </div>
                        <button className="btn-login" onClick={onLogout} style={{background: 'var(--bg-tertiary)', color: 'var(--text-primary)', border: '1px solid var(--border-default)'}}>
                            Sair
                        </button>
                    </div>
                </div>
            );
        }

        // ==========================================
        // REJECTED SCREEN
        // ==========================================
        function RejectedScreen({ onLogout }) {
            return (
                <div className="login-container">
                    <div className="login-box">
                        <img src="logo-orne.png" alt="Orne" className="login-logo" onError={(e) => e.target.style.display='none'} />
                        <div style={{textAlign: 'center', marginBottom: '16px'}}>
                            <div style={{width: '48px', height: '48px', borderRadius: '50%', background: 'var(--accent-error-subtle)', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 16px'}}>
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent-error)" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                            </div>
                            <h1 className="login-title">Acesso Negado</h1>
                            <p className="login-subtitle" style={{marginTop: '8px', lineHeight: '1.6'}}>
                                Seu acesso foi negado pelo administrador.
                                <br/>Entre em contato caso acredite ser um erro.
                            </p>
                        </div>
                        <button className="btn-login" onClick={onLogout} style={{background: 'var(--bg-tertiary)', color: 'var(--text-primary)', border: '1px solid var(--border-default)'}}>
                            Sair
                        </button>
                    </div>
                </div>
            );
        }

        // ==========================================
        // ACCESS RESTRICTED (permission gate)
        // ==========================================
        function AccessRestricted({ message }) {
            return (
                <div style={{ textAlign: 'center', padding: '60px 20px', color: 'var(--text-secondary)' }}>
                    <div style={{ fontSize: '48px', marginBottom: '16px' }}>
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <h3 style={{ color: 'var(--text-primary)', marginBottom: '8px' }}>Acesso Restrito</h3>
                    <p>{message || 'Apenas administradores de estoque podem acessar esta funcionalidade.'}</p>
                </div>
            );
        }

        // ==========================================
        // ADMIN PANEL
        // ==========================================
        function AdminPanel({ currentUserId }) {
            const [users, setUsers] = useState([]);
            const [loadingUsers, setLoadingUsers] = useState(true);
            const [actionLoading, setActionLoading] = useState(null);

            useEffect(() => {
                loadUsers();
                const channel = supabaseClient.channel('admin-user-profiles')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'user_profiles' }, () => loadUsers())
                    .subscribe();
                return () => supabaseClient.removeChannel(channel);
            }, []);

            const loadUsers = async () => {
                const { data } = await supabaseClient.from('user_profiles').select('*').order('created_at', { ascending: false });
                if (data) setUsers(data);
                setLoadingUsers(false);
            };

            const updateUser = async (userId, updates) => {
                setActionLoading(userId);
                await supabaseClient.from('user_profiles').update({ ...updates, updated_at: new Date().toISOString() }).eq('id', userId);
                await loadUsers();
                setActionLoading(null);
            };

            const statusBadge = (status) => {
                const map = {
                    'approved': { label: 'Aprovado', cls: 'badge-success' },
                    'pending': { label: 'Pendente', cls: 'badge-warning' },
                    'rejected': { label: 'Rejeitado', cls: 'badge-danger' }
                };
                const s = map[status] || { label: status, cls: '' };
                return <span className={`badge ${s.cls}`}>{s.label}</span>;
            };

            const roleBadge = (role) => {
                return role === 'admin'
                    ? <span className="badge badge-info">Admin</span>
                    : <span className="badge" style={{background: 'var(--bg-tertiary)', color: 'var(--text-secondary)'}}>Usuário</span>;
            };

            const formatDate = (d) => d ? new Date(d).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-';

            return (
                <div>
                    <div className="page-header">
                        <h1 className="page-title">Gerenciar Usuários</h1>
                        <p className="page-subtitle">Aprove ou rejeite cadastros de novos usuários</p>
                    </div>

                    {loadingUsers ? (
                        <div style={{textAlign: 'center', padding: '40px'}}>
                            <div className="loading-spinner" style={{margin: '0 auto'}}></div>
                        </div>
                    ) : (
                        <div className="card">
                            <div className="table-container">
                                <table className="table">
                                    <thead>
                                        <tr>
                                            <th>E-mail</th>
                                            <th>Função</th>
                                            <th>Status</th>
                                            <th>Cadastro</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {users.map(u => (
                                            <tr key={u.id}>
                                                <td style={{fontWeight: 500}}>{u.email || '—'}</td>
                                                <td>{roleBadge(u.role)}</td>
                                                <td>{statusBadge(u.status)}</td>
                                                <td style={{fontSize: '12px', color: 'var(--text-secondary)'}}>{formatDate(u.created_at)}</td>
                                                <td>
                                                    <div style={{display: 'flex', gap: '6px', flexWrap: 'wrap'}}>
                                                        {u.status !== 'approved' && (
                                                            <button
                                                                className="btn btn-primary"
                                                                style={{fontSize: '12px', padding: '4px 10px', minHeight: 'auto', background: 'var(--accent-success)', borderColor: 'var(--accent-success)'}}
                                                                disabled={actionLoading === u.id}
                                                                onClick={() => updateUser(u.id, { status: 'approved' })}
                                                            >Aprovar</button>
                                                        )}
                                                        {u.status !== 'rejected' && u.id !== currentUserId && (
                                                            <button
                                                                className="btn btn-secondary"
                                                                style={{fontSize: '12px', padding: '4px 10px', minHeight: 'auto', color: 'var(--accent-error)', borderColor: 'var(--accent-error)'}}
                                                                disabled={actionLoading === u.id}
                                                                onClick={() => updateUser(u.id, { status: 'rejected' })}
                                                            >Rejeitar</button>
                                                        )}
                                                        {u.status === 'approved' && u.role !== 'admin' && (
                                                            <button
                                                                className="btn btn-secondary"
                                                                style={{fontSize: '12px', padding: '4px 10px', minHeight: 'auto'}}
                                                                disabled={actionLoading === u.id}
                                                                onClick={() => updateUser(u.id, { role: 'admin' })}
                                                            >Tornar Admin</button>
                                                        )}
                                                        {u.role === 'admin' && u.id !== currentUserId && (
                                                            <button
                                                                className="btn btn-secondary"
                                                                style={{fontSize: '12px', padding: '4px 10px', minHeight: 'auto'}}
                                                                disabled={actionLoading === u.id}
                                                                onClick={() => updateUser(u.id, { role: 'user' })}
                                                            >Remover Admin</button>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function LoginScreen({ loading }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLogin, setIsLogin] = useState(true);
            const [error, setError] = useState('');
            const [successMsg, setSuccessMsg] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="loading-spinner"></div>
                        <span style={{color: 'var(--text-muted)', fontSize: '13px'}}>Carregando...</span>
                    </div>
                );
            }

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setSuccessMsg('');
                setIsLoading(true);

                try {
                    if (isLogin) {
                        const { data, error: authError } = await supabaseClient.auth.signInWithPassword({ email, password });
                        if (authError) throw authError;
                    } else {
                        const { data, error: authError } = await supabaseClient.auth.signUp({ email, password });
                        if (authError) throw authError;
                        // Sign out so they see the success message
                        await supabaseClient.auth.signOut();
                        setSuccessMsg('Conta criada com sucesso! Aguarde a aprovação do administrador.');
                        setIsLogin(true);
                    }
                } catch (err) {
                    const messages = {
                        'invalid_credentials': 'E-mail ou senha incorretos',
                        'user_already_exists': 'E-mail já cadastrado',
                        'weak_password': 'Senha muito fraca (mínimo 6 caracteres)',
                        'invalid_email': 'E-mail inválido',
                        'email_not_confirmed': 'E-mail não confirmado',
                        'signup_disabled': 'Cadastro desabilitado'
                    };
                    setError(messages[err.code] || err.message || 'Erro ao autenticar');
                }
                setIsLoading(false);
            };

            return (
                <div className="login-container">
                    <div className="login-box">
                        <img src="logo-orne.png" alt="Orne" className="login-logo" onError={(e) => e.target.style.display='none'} />
                        <h1 className="login-title">{isLogin ? 'Entrar' : 'Criar conta'}</h1>
                        <p className="login-subtitle">Sistema de Gestão de Estoque</p>

                        {successMsg && (
                            <div style={{padding: '12px 16px', borderRadius: '8px', background: 'var(--accent-success-subtle)', color: 'var(--accent-success)', fontSize: '13px', marginBottom: '16px', lineHeight: '1.5', border: '1px solid rgba(61, 139, 95, 0.2)'}}>
                                {successMsg}
                            </div>
                        )}

                        <form className="login-form" onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">E-mail</label>
                                <input type="email" className="form-input" value={email} onChange={(e) => setEmail(e.target.value)} required />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Senha</label>
                                <input type="password" className="form-input" value={password} onChange={(e) => setPassword(e.target.value)} required />
                            </div>
                            <button type="submit" className="btn-login" disabled={isLoading}>
                                {isLoading ? 'Aguarde...' : isLogin ? 'Entrar' : 'Criar conta'}
                            </button>
                        </form>

                        {error && <div className="login-error">{error}</div>}

                        <div className="login-toggle">
                            {isLogin ? 'Não tem conta? ' : 'Já tem conta? '}
                            <button onClick={() => { setIsLogin(!isLogin); setError(''); setSuccessMsg(''); }}>
                                {isLogin ? 'Criar conta' : 'Fazer login'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // ==========================================
        // MAIN APP
        // ==========================================
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTabRaw] = useState(() => {
                try { return sessionStorage.getItem('orne_activeTab') || 'dashboard'; } catch(e) { return 'dashboard'; }
            });
            const setActiveTab = (tab) => {
                setActiveTabRaw(tab);
                try { sessionStorage.setItem('orne_activeTab', tab); } catch(e) {}
            };
            const [products, setProducts] = useState([]);
            const [entries, setEntries] = useState([]);
            const [exits, setExits] = useState([]);
            const [categories, setCategories] = useState([]);
            const [shippings, setShippings] = useState([]);
            const [locaisOrigem, setLocaisOrigem] = useState(['Loja Principal', 'Depósito 1', 'Depósito 2']);
            const [syncStatus, setSyncStatus] = useState('syncing');
            // User profile (approval system)
            const [userProfile, setUserProfile] = useState(null);
            const [profileLoading, setProfileLoading] = useState(true);

            // Permission flags
            const isStockAdmin = userProfile?.status === 'approved' &&
              ['oliviaalencar@hotmail.com', 'sac@ornestudio.com'].includes(userProfile?.email);
            const isSuperAdmin = userProfile?.status === 'approved' &&
              userProfile?.email === 'oliviaalencar@hotmail.com';

            // UI-only states (mobile navigation)
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [mobileSheet, setMobileSheet] = useState(null); // 'movimentacoes' or null
            const loadProductsRef = useRef(null);

            const tabTitles = { dashboard: 'Dashboard', stock: 'Estoque', entry: 'Entrada', exit: 'Saída', shipping: 'Despachos', history: 'Histórico', tiny: 'Tiny ERP', admin: 'Usuários' };

            const handleTabChange = (tab) => {
                if (tab === activeTab) return;
                if (document.startViewTransition) {
                    document.startViewTransition(() => { setActiveTab(tab); });
                } else {
                    setActiveTab(tab);
                }
                if (sidebarOpen) setSidebarOpen(false);
                if (mobileSheet) setMobileSheet(null);
            };
            const [searchTerm, setSearchTerm] = useState('');

            const DEFAULT_CATEGORIES = [
                { id: 'abajur', name: 'Abajur', icon: 'catLamp', color: '#E8723A' },
                { id: 'arandelas', name: 'Arandelas', icon: 'catWallLight', color: '#A52428' },
                { id: 'pendentes', name: 'Pendentes', icon: 'catPendant', color: '#7B6EED' },
                { id: 'lustres', name: 'Lustres', icon: 'catChandelier', color: '#F4A261' },
                { id: 'plafons', name: 'Plafons', icon: 'catCeiling', color: '#D4612E' },
                { id: 'spots', name: 'Spots', icon: 'catSpot', color: '#2ECC87' },
                { id: 'outros', name: 'Outros', icon: 'catOther', color: '#7A7585' }
            ];

            useEffect(() => {
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    setUser(session?.user ?? null);
                    setLoading(false);
                });
                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(
                    (_event, session) => {
                        const newUser = session?.user ?? null;
                        // Só atualizar referência se user REALMENTE mudou (login/logout/troca)
                        // TOKEN_REFRESHED com mesmo user.id mantém referência → evita cascata
                        setUser(prev => {
                            if (!prev && !newUser) return prev;
                            if (!prev || !newUser) return newUser;
                            if (prev.id === newUser.id) return prev;
                            return newUser;
                        });
                    }
                );
                return () => subscription.unsubscribe();
            }, []);

            // Fetch user profile for approval gating
            useEffect(() => {
                if (!user) { setUserProfile(null); setProfileLoading(false); return; }
                setProfileLoading(true);

                const fetchProfile = async (retries = 3) => {
                    try {
                        const { data, error: err } = await supabaseClient
                            .from('user_profiles')
                            .select('*')
                            .eq('id', user.id)
                            .single();

                        if (data && !err) {
                            setUserProfile(data);
                            setProfileLoading(false);
                            return;
                        }

                        // Profile not found yet — retry (trigger may not have fired)
                        if (retries > 0) {
                            await new Promise(r => setTimeout(r, 1500));
                            return fetchProfile(retries - 1);
                        }

                        // After all retries, set as pending (genuinely new user)
                        setUserProfile({ status: 'pending', role: 'user' });
                        setProfileLoading(false);
                    } catch (e) {
                        console.error('Error fetching profile:', e);
                        if (retries > 0) {
                            await new Promise(r => setTimeout(r, 1500));
                            return fetchProfile(retries - 1);
                        }
                        setUserProfile({ status: 'pending', role: 'user' });
                        setProfileLoading(false);
                    }
                };

                fetchProfile();
            }, [user]);

            useEffect(() => {
                if (!user || !supabaseInitialized) return;

                setSyncStatus('syncing');
                const channels = [];

                // Categories
                channels.push(setupSupabaseCollection('categories', (cats) => {
                    if (cats.length === 0) {
                        DEFAULT_CATEGORIES.forEach(cat => {
                            supabaseClient.from('categories').upsert(cat);
                        });
                        setCategories(DEFAULT_CATEGORIES);
                    } else {
                        setCategories(cats);
                    }
                }));

                // Products — sem Realtime, fetch paginado (> 1000 produtos)
                const PRODUCT_FIELDS = 'id, name, sku, ean, category, min_stock, observations, nf_origem, created_at, tiny_id, unit_price, local';
                const PRODUCT_FILTERS = [q => q.neq('sku', ''), q => q.neq('name', '')];
                const loadProducts = () => fetchAllRows('products', PRODUCT_FIELDS, PRODUCT_FILTERS)
                    .then(data => {
                        setProducts(data.map(mapProductFromDB));
                        setSyncStatus('online');
                    });
                loadProducts();
                loadProductsRef.current = loadProducts;

                // Entries
                channels.push(setupSupabaseCollection('entries', setEntries, {
                    transform: mapEntryFromDB
                }));

                // Exits
                channels.push(setupSupabaseCollection('exits', setExits, {
                    transform: mapExitFromDB
                }));

                // Shippings
                channels.push(setupSupabaseCollection('shippings', setShippings, {
                    transform: mapShippingFromDB
                }));

                // Locais de origem
                supabaseClient.from('locais_origem').select('name').order('id').then(({ data }) => {
                    if (data && data.length > 0) {
                        setLocaisOrigem(data.map(d => d.name));
                    } else {
                        const defaults = ['Loja Principal', 'Depósito 1', 'Depósito 2'];
                        defaults.forEach(name => supabaseClient.from('locais_origem').insert({ name }));
                        setLocaisOrigem(defaults);
                    }
                });
                const locaisChannel = supabaseClient
                    .channel('locais_origem-realtime')
                    .on('postgres_changes',
                        { event: '*', schema: 'public', table: 'locais_origem' },
                        () => {
                            supabaseClient.from('locais_origem').select('name').order('id')
                                .then(({ data }) => {
                                    if (data) setLocaisOrigem(data.map(d => d.name));
                                });
                        }
                    ).subscribe();
                channels.push(locaisChannel);

                setSyncStatus('online');

                return () => {
                    channels.forEach(ch => supabaseClient.removeChannel(ch));
                };
            }, [user]);

            const handleLogout = () => supabaseClient.auth.signOut();

            // Stock calculation com useMemo — O(n) apenas quando entries/exits mudam
            const stockMap = useMemo(() => {
                const entryMap = {};
                const exitMap = {};
                entries.forEach(e => {
                    if (!entryMap[e.sku]) entryMap[e.sku] = 0;
                    entryMap[e.sku] += parseInt(e.quantity) || 0;
                });
                exits.forEach(e => {
                    if (!exitMap[e.sku]) exitMap[e.sku] = 0;
                    exitMap[e.sku] += parseInt(e.quantity) || 0;
                });
                return { entryMap, exitMap };
            }, [entries, exits]);

            const currentStock = useMemo(() => {
                const { entryMap, exitMap } = stockMap;
                return products.map(p => {
                    const qty = (entryMap[p.sku] || 0) - (exitMap[p.sku] || 0);
                    const min = p.minStock || 3;
                    return { ...p, currentQuantity: qty, status: qty === 0 ? 'empty' : qty < min ? 'low' : 'ok' };
                });
            }, [products, stockMap]);

            const handleImport = async (data) => {
                if (!isStockAdmin) { alert('Sem permissão para esta ação'); return; }
                const isEntry = data.type === 'entry' || data.type === 'COMPRA' || data.type === 'DEVOLUCAO' || data.type === 'AJUSTE';
                if (isEntry) {
                    const newRecord = {
                        type: data.type, sku: data.sku, quantity: data.quantity,
                        supplier: data.supplier || '', nf: data.nf || '',
                        local_entrada: data.localEntrada || '',
                        date: new Date().toISOString(), user_id: user.email
                    };
                    const { data: inserted, error } = await supabaseClient
                        .from('entries').insert(newRecord).select().single();
                    if (error) { console.error('Erro ao importar entrada:', error); alert('Erro ao importar entrada: ' + error.message); return; }
                    if (inserted) {
                        setEntries(prev => {
                            if (prev.find(e => e.id === inserted.id)) return prev;
                            return [...prev, mapEntryFromDB(inserted)];
                        });
                    }
                    // Propagar local da entrada para o produto
                    if (newRecord.local_entrada && newRecord.local_entrada.trim() !== '') {
                        await supabaseClient
                            .from('products')
                            .update({ local: newRecord.local_entrada })
                            .eq('sku', newRecord.sku);
                        setProducts(prev => prev.map(p =>
                            p.sku === newRecord.sku ? { ...p, local: newRecord.local_entrada } : p
                        ));
                    }
                } else {
                    const newRecord = {
                        type: data.type, sku: data.sku, quantity: data.quantity,
                        client: data.client || '', nf: data.nf || '',
                        nf_origem: data.nfOrigem || null,
                        date: new Date().toISOString(), user_id: user.email
                    };
                    const { data: inserted, error } = await supabaseClient
                        .from('exits').insert(newRecord).select().single();
                    if (error) { console.error('Erro ao importar saída:', error); alert('Erro ao importar saída: ' + error.message); return; }
                    if (inserted) {
                        setExits(prev => {
                            if (prev.find(e => e.id === inserted.id)) return prev;
                            return [...prev, mapExitFromDB(inserted)];
                        });
                    }
                }
            };

            const addEntry = useCallback(async (entry) => {
                if (!isStockAdmin) { alert('Sem permissão para esta ação'); return; }
                const newRecord = {
                    type: entry.type, sku: entry.sku, quantity: entry.quantity,
                    supplier: entry.supplier || '', nf: entry.nf || '',
                    local_entrada: entry.localEntrada || '',
                    date: new Date().toISOString(), user_id: user.email
                };
                const { data, error } = await supabaseClient
                    .from('entries').insert(newRecord).select().single();
                if (error) throw error;
                // Atualizar state IMEDIATAMENTE sem esperar Realtime
                if (data) {
                    setEntries(prev => {
                        if (prev.find(e => e.id === data.id)) return prev;
                        return [...prev, mapEntryFromDB(data)];
                    });
                }
                // Propagar local, nf_origem, category e observations da entrada para o produto
                const productUpdate = {};
                if (newRecord.local_entrada && newRecord.local_entrada.trim() !== '') {
                    productUpdate.local = newRecord.local_entrada;
                }
                if (newRecord.nf && newRecord.nf.trim() !== '') {
                    productUpdate.nf_origem = newRecord.nf;
                }
                if (entry.category && entry.category.trim() !== '') {
                    productUpdate.category = entry.category.trim();
                }
                if (entry.observations && entry.observations.trim() !== '') {
                    productUpdate.observations = entry.observations.trim();
                }
                if (Object.keys(productUpdate).length > 0) {
                    await supabaseClient
                        .from('products')
                        .update(productUpdate)
                        .eq('sku', newRecord.sku);
                    setProducts(prev => prev.map(p =>
                        p.sku === newRecord.sku ? { ...p, ...productUpdate } : p
                    ));
                }
            }, [user, isStockAdmin]);

            const addExit = useCallback(async (exit) => {
                if (!isStockAdmin) { alert('Sem permissão para esta ação'); return null; }
                const newRecord = {
                    type: exit.type, sku: exit.sku, quantity: exit.quantity,
                    client: exit.client || '', nf: exit.nf || '',
                    nf_origem: exit.nfOrigem || null,
                    date: new Date().toISOString(), user_id: user.email
                };
                const { data, error } = await supabaseClient
                    .from('exits').insert(newRecord).select().single();
                if (error) throw error;
                // Atualizar state IMEDIATAMENTE sem esperar Realtime
                if (data) {
                    const mappedExit = mapExitFromDB(data);
                    setExits(prev => {
                        if (prev.find(e => e.id === data.id)) return prev;
                        return [...prev, mappedExit];
                    });
                    return mappedExit;
                }
                return null;
            }, [user, isStockAdmin]);

            const updateEntry = async (entryId, data) => {
                if (!isStockAdmin) { alert('Sem permissão para esta ação'); return; }
                const mapped = {};
                if (data.type !== undefined) mapped.type = data.type;
                if (data.sku !== undefined) mapped.sku = data.sku;
                if (data.quantity !== undefined) mapped.quantity = data.quantity;
                if (data.supplier !== undefined) mapped.supplier = data.supplier;
                if (data.nf !== undefined) mapped.nf = data.nf;
                if (data.localEntrada !== undefined) mapped.local_entrada = data.localEntrada;
                if (data.date !== undefined) mapped.date = data.date;
                const { error } = await supabaseClient.from('entries').update(mapped).eq('id', entryId);
                if (error) { console.error('Erro ao atualizar entrada:', error); alert('Erro ao atualizar entrada: ' + error.message); return; }
            };

            const deleteEntry = async (entryId) => {
                if (!isStockAdmin) { alert('Sem permissão para esta ação'); return; }
                const { error } = await supabaseClient.from('entries').delete().eq('id', entryId);
                if (error) { console.error('Erro ao excluir entrada:', error); alert('Erro ao excluir entrada: ' + error.message); return; }
            };

            const updateExit = async (exitId, data) => {
                if (!isStockAdmin) { alert('Sem permissão para esta ação'); return; }
                const mapped = {};
                if (data.type !== undefined) mapped.type = data.type;
                if (data.sku !== undefined) mapped.sku = data.sku;
                if (data.quantity !== undefined) mapped.quantity = data.quantity;
                if (data.client !== undefined) mapped.client = data.client;
                if (data.nf !== undefined) mapped.nf = data.nf;
                if (data.nfOrigem !== undefined) mapped.nf_origem = data.nfOrigem;
                if (data.date !== undefined) mapped.date = data.date;
                const { error } = await supabaseClient.from('exits').update(mapped).eq('id', exitId);
                if (error) { console.error('Erro ao atualizar saída:', error); alert('Erro ao atualizar saída: ' + error.message); return; }
            };

            const deleteExit = async (exitId) => {
                if (!isStockAdmin) { alert('Sem permissão para esta ação'); return; }
                const { error } = await supabaseClient.from('exits').delete().eq('id', exitId);
                if (error) { console.error('Erro ao excluir saída:', error); alert('Erro ao excluir saída: ' + error.message); return; }
            };

            const refetchData = async () => {
                const PRODUCT_FIELDS = 'id, name, sku, ean, category, min_stock, observations, nf_origem, created_at, tiny_id, unit_price, local';
                const PRODUCT_FILTERS = [q => q.neq('sku', ''), q => q.neq('name', '')];
                const [prodData, entRes, exitRes] = await Promise.all([
                    fetchAllRows('products', PRODUCT_FIELDS, PRODUCT_FILTERS),
                    supabaseClient.from('entries').select('*'),
                    supabaseClient.from('exits').select('*'),
                ]);
                if (prodData.length > 0) setProducts(prodData.map(mapProductFromDB));
                if (entRes.data) setEntries(entRes.data.map(mapEntryFromDB));
                if (exitRes.data) setExits(exitRes.data.map(mapExitFromDB));
            };

            const addProduct = async (product) => {
                if (!isStockAdmin) { alert('Sem permissão para esta ação'); return; }
                const newProduct = { ...product, id: product.id || generateId() };
                const { error } = await supabaseClient.from('products').upsert({
                    id: newProduct.id, name: newProduct.name, sku: newProduct.sku,
                    ean: newProduct.ean || '', category: newProduct.category || '',
                    min_stock: newProduct.minStock || 3,
                    observations: newProduct.observations || '',
                    nf_origem: newProduct.nfOrigem || '',
                    unit_price: newProduct.unitPrice || 0,
                    created_at: newProduct.createdAt || new Date().toISOString()
                });
                if (error) { console.error('Erro ao adicionar produto:', error); alert('Erro ao salvar produto: ' + error.message); return; }
                // Atualizar state local (products sem Realtime)
                setProducts(prev => {
                    const idx = prev.findIndex(p => p.id === newProduct.id);
                    if (idx >= 0) { const updated = [...prev]; updated[idx] = { ...prev[idx], ...newProduct }; return updated; }
                    return [...prev, newProduct];
                });
                return newProduct;
            };

            const updateProduct = async (productId, data) => {
                if (!isStockAdmin) { alert('Sem permissão para esta ação'); return; }
                const mapped = {};
                if (data.name !== undefined) mapped.name = data.name;
                if (data.sku !== undefined) mapped.sku = data.sku;
                if (data.ean !== undefined) mapped.ean = data.ean;
                if (data.category !== undefined) mapped.category = data.category;
                if (data.minStock !== undefined) mapped.min_stock = data.minStock;
                if (data.observations !== undefined) mapped.observations = data.observations;
                if (data.nfOrigem !== undefined) mapped.nf_origem = data.nfOrigem;
                if (data.local !== undefined) mapped.local = data.local;
                const { error } = await supabaseClient.from('products').update(mapped).eq('id', productId);
                if (error) { console.error('Erro ao atualizar produto:', error); alert('Erro ao atualizar produto: ' + error.message); return; }
                // Atualizar state local (products sem Realtime)
                setProducts(prev => prev.map(p => p.id === productId ? { ...p, ...data } : p));
            };

            const deleteProduct = async (productId) => {
                if (!isStockAdmin) { alert('Sem permissão para esta ação'); return; }
                const { error } = await supabaseClient.from('products').delete().eq('id', productId);
                if (error) { console.error('Erro ao excluir produto:', error); alert('Erro ao excluir produto: ' + error.message); return; }
                // Atualizar state local (products sem Realtime)
                setProducts(prev => prev.filter(p => p.id !== productId));
            };

            const addCategory = async (category) => {
                if (!isStockAdmin) { alert('Sem permissão para esta ação'); return; }
                const newCategory = { ...category, id: category.id || generateId() };
                const { error } = await supabaseClient.from('categories').upsert({
                    id: newCategory.id, name: newCategory.name,
                    icon: newCategory.icon || '', color: newCategory.color || ''
                });
                if (error) { console.error('Erro ao adicionar categoria:', error); alert('Erro ao salvar categoria: ' + error.message); return; }
                return newCategory;
            };

            const updateCategory = async (categoryId, data) => {
                if (!isStockAdmin) { alert('Sem permissão para esta ação'); return; }
                const { error } = await supabaseClient.from('categories').update(data).eq('id', categoryId);
                if (error) { console.error('Erro ao atualizar categoria:', error); alert('Erro ao atualizar categoria: ' + error.message); return; }
            };

            const deleteCategory = async (categoryId) => {
                if (!isStockAdmin) { alert('Sem permissão para esta ação'); return; }
                const { error } = await supabaseClient.from('categories').delete().eq('id', categoryId);
                if (error) { console.error('Erro ao excluir categoria:', error); alert('Erro ao excluir categoria: ' + error.message); return; }
            };

            const addShipping = async (shipping) => {
                if (!isStockAdmin) { alert('Sem permissão para esta ação'); return; }
                const newShipping = {
                    id: shipping.id || generateId(),
                    nf_numero: shipping.nfNumero || '',
                    cliente: shipping.cliente || '',
                    destino: shipping.destino || '',
                    local_origem: shipping.localOrigem || '',
                    transportadora: shipping.transportadora || '',
                    codigo_rastreio: shipping.codigoRastreio || '',
                    link_rastreio: shipping.linkRastreio || '',
                    melhor_envio_id: shipping.melhorEnvioId || '',
                    produtos: shipping.produtos || [],
                    observacoes: shipping.observacoes || '',
                    status: shipping.status || 'PENDENTE',
                    date: new Date().toISOString(),
                    user_id: user.email
                };
                const { error } = await supabaseClient.from('shippings').upsert(newShipping);
                if (error) { console.error('Erro ao criar despacho:', error); alert('Erro ao criar despacho: ' + error.message); return; }
                return { ...shipping, id: newShipping.id, date: newShipping.date, userId: user.email, status: newShipping.status };
            };

            const updateShipping = async (shippingId, data) => {
                if (!isStockAdmin) { alert('Sem permissão para esta ação'); return; }
                const mapped = {};
                if (data.nfNumero !== undefined) mapped.nf_numero = data.nfNumero;
                if (data.cliente !== undefined) mapped.cliente = data.cliente;
                if (data.destino !== undefined) mapped.destino = data.destino;
                if (data.localOrigem !== undefined) mapped.local_origem = data.localOrigem;
                if (data.transportadora !== undefined) mapped.transportadora = data.transportadora;
                if (data.codigoRastreio !== undefined) mapped.codigo_rastreio = data.codigoRastreio;
                if (data.linkRastreio !== undefined) mapped.link_rastreio = data.linkRastreio;
                if (data.melhorEnvioId !== undefined) mapped.melhor_envio_id = data.melhorEnvioId;
                if (data.produtos !== undefined) mapped.produtos = data.produtos;
                if (data.observacoes !== undefined) mapped.observacoes = data.observacoes;
                if (data.status !== undefined) mapped.status = data.status;
                if (data.ultimaAtualizacaoRastreio !== undefined) mapped.ultima_atualizacao_rastreio = data.ultimaAtualizacaoRastreio;
                if (data.rastreioInfo !== undefined) mapped.rastreio_info = data.rastreioInfo;
                const { error } = await supabaseClient.from('shippings').update(mapped).eq('id', shippingId);
                if (error) { console.error('Erro ao atualizar despacho:', error); alert('Erro ao atualizar despacho: ' + error.message); return; }
            };

            const deleteShipping = async (shippingId) => {
                if (!isStockAdmin) { alert('Sem permissão para esta ação'); return; }
                const { error } = await supabaseClient.from('shippings').delete().eq('id', shippingId);
                if (error) { console.error('Erro ao excluir despacho:', error); alert('Erro ao excluir despacho: ' + error.message); return; }
            };

            const updateLocaisOrigem = async (locais) => {
                if (!isStockAdmin) { alert('Sem permissão para esta ação'); return; }
                const { error: delError } = await supabaseClient.from('locais_origem').delete().neq('id', 0);
                if (delError) { console.error('Erro ao limpar locais:', delError); alert('Erro ao atualizar locais: ' + delError.message); return; }
                if (locais.length > 0) {
                    const { error: insError } = await supabaseClient.from('locais_origem').insert(
                        locais.map(name => ({ name }))
                    );
                    if (insError) { console.error('Erro ao inserir locais:', insError); alert('Erro ao salvar locais: ' + insError.message); return; }
                }
            };

            if (!user) return <LoginScreen loading={loading} />;
            if (profileLoading) return <LoginScreen loading={true} />;
            if (userProfile?.status === 'pending') return <PendingApprovalScreen onLogout={handleLogout} />;
            if (userProfile?.status === 'rejected') return <RejectedScreen onLogout={handleLogout} />;

            return (
                <div className="app-container">
                    {/* Mobile Header */}
                    <div className="mobile-header">
                        <div className="mobile-header-title">{tabTitles[activeTab] || 'Orne'}</div>
                        <div className="mobile-header-actions">
                            <div className="mobile-avatar" aria-label="Perfil">
                                {user.email ? user.email.charAt(0).toUpperCase() : 'U'}
                            </div>
                        </div>
                    </div>

                    {/* Sidebar Overlay */}
                    <div className={`sidebar-overlay ${sidebarOpen ? 'visible' : ''}`} onClick={() => setSidebarOpen(false)}></div>

                    <div className={`sidebar ${sidebarOpen ? 'open' : ''}`}>
                        <div className="logo-container">
                            <img src="logo-orne.png" alt="Orne" className="logo" onError={(e) => e.target.style.display = 'none'} />
                        </div>

                        <div className="user-info">
                            <div className="user-email">{user.email}</div>
                            <button className="btn-logout" onClick={handleLogout}>Sair</button>
                        </div>

                        <div style={{padding: '0 14px', marginBottom: '16px'}}>
                            <button
                                onClick={() => {
                                    const url = window.location.origin + '/consulta.html';
                                    navigator.clipboard.writeText(url);
                                    alert('Link copiado!\n\n' + url + '\n\nCompartilhe com sua equipe para visualização (somente leitura).');
                                }}
                                style={{
                                    width: '100%',
                                    padding: '9px',
                                    background: 'rgba(255,255,255,0.12)',
                                    border: '1px solid rgba(255,255,255,0.18)',
                                    borderRadius: '10px',
                                    color: 'rgba(255,255,255,0.85)',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    gap: '8px',
                                    fontFamily: 'inherit',
                                    fontWeight: '400',
                                    letterSpacing: '0.2px',
                                    transition: 'all 0.2s'
                                }}
                            >
                                <Icon name="share" size={14} /> Compartilhar Consulta
                            </button>
                        </div>

                        <ul className="nav-menu">
                            <li className="nav-item">
                                <a className={`nav-link ${activeTab === 'dashboard' ? 'active' : ''}`} onClick={() => handleTabChange('dashboard')}>
                                    <span className="nav-icon" dangerouslySetInnerHTML={{__html: ICONS.dashboard}}></span>Dashboard
                                </a>
                            </li>
                            <li className="nav-item">
                                <a className={`nav-link ${activeTab === 'stock' ? 'active' : ''}`} onClick={() => handleTabChange('stock')}>
                                    <span className="nav-icon" dangerouslySetInnerHTML={{__html: ICONS.stock}}></span>Estoque
                                </a>
                            </li>

                            {isStockAdmin && (<React.Fragment>
                            <div className="nav-section">Movimentações</div>
                            <li className="nav-item">
                                <a className={`nav-link ${activeTab === 'entry' ? 'active' : ''}`} onClick={() => handleTabChange('entry')}>
                                    <span className="nav-icon" dangerouslySetInnerHTML={{__html: ICONS.entry}}></span>Entrada
                                </a>
                            </li>
                            <li className="nav-item">
                                <a className={`nav-link ${activeTab === 'exit' ? 'active' : ''}`} onClick={() => handleTabChange('exit')}>
                                    <span className="nav-icon" dangerouslySetInnerHTML={{__html: ICONS.exit}}></span>Saída
                                </a>
                            </li>
                            <li className="nav-item">
                                <a className={`nav-link ${activeTab === 'shipping' ? 'active' : ''}`} onClick={() => handleTabChange('shipping')}>
                                    <span className="nav-icon" dangerouslySetInnerHTML={{__html: ICONS.shipping}}></span>Despachos
                                </a>
                            </li>

                            </React.Fragment>)}

                            <div className="nav-section">Relatórios</div>
                            <li className="nav-item">
                                <a className={`nav-link ${activeTab === 'history' ? 'active' : ''}`} onClick={() => handleTabChange('history')}>
                                    <span className="nav-icon" dangerouslySetInnerHTML={{__html: ICONS.history}}></span>Histórico
                                </a>
                            </li>

                            <div className="nav-section">Integrações</div>
                            <li className="nav-item">
                                <a className={`nav-link ${activeTab === 'tiny' ? 'active' : ''}`} onClick={() => handleTabChange('tiny')}>
                                    <span className="nav-icon" dangerouslySetInnerHTML={{__html: ICONS.tiny}}></span>Tiny ERP
                                </a>
                            </li>

                            {isSuperAdmin && (
                                <React.Fragment>
                                    <div className="nav-section">Administração</div>
                                    <li className="nav-item">
                                        <a className={`nav-link ${activeTab === 'admin' ? 'active' : ''}`} onClick={() => handleTabChange('admin')}>
                                            <span className="nav-icon" dangerouslySetInnerHTML={{__html: ICONS.user}}></span>Usuários
                                        </a>
                                    </li>
                                </React.Fragment>
                            )}
                        </ul>
                    </div>

                    <div className="main-content">
                        <div className="fade-in">
                            {/* Frequent tabs — kept mounted, hidden via display:none */}
                            <div style={{display: activeTab === 'dashboard' ? 'block' : 'none'}}>
                                <Dashboard stock={currentStock} categories={categories} isVisible={activeTab === 'dashboard'} entries={entries} exits={exits} onNavigate={handleTabChange} />
                            </div>
                            <div style={{display: activeTab === 'stock' ? 'block' : 'none'}}>
                                <StockView stock={currentStock} categories={categories} onUpdate={updateProduct} onDelete={deleteProduct} searchTerm={searchTerm} setSearchTerm={setSearchTerm} entries={entries} exits={exits} locaisOrigem={locaisOrigem} />
                            </div>
                            <div style={{display: activeTab === 'categories' ? 'block' : 'none'}}>
                                <CategoryManager categories={categories} onAdd={addCategory} onUpdate={updateCategory} onDelete={deleteCategory} products={currentStock} />
                            </div>
                            <div style={{display: activeTab === 'entry' ? 'block' : 'none'}}>
                                {isStockAdmin ? <EntryForm products={products} onSubmit={addEntry} onAddProduct={addProduct} categories={categories} locaisOrigem={locaisOrigem} onUpdateLocais={updateLocaisOrigem} entries={entries} exits={exits} stock={currentStock} onAddCategory={addCategory} onUpdateCategory={updateCategory} onDeleteCategory={deleteCategory} /> : <AccessRestricted />}
                            </div>
                            <div style={{display: activeTab === 'exit' ? 'block' : 'none'}}>
                                {isStockAdmin ? <ExitForm products={products} stock={currentStock} onSubmit={addExit} entries={entries} exits={exits} onAddProduct={addProduct} categories={categories} locaisOrigem={locaisOrigem} onUpdateLocais={updateLocaisOrigem} onAddCategory={addCategory} onUpdateCategory={updateCategory} onDeleteCategory={deleteCategory} /> : <AccessRestricted />}
                            </div>
                            <div style={{display: activeTab === 'shipping' ? 'block' : 'none'}}>
                                <ShippingManager shippings={shippings} onAdd={addShipping} onUpdate={updateShipping} onDelete={deleteShipping} stock={currentStock} products={products} onAddExit={addExit} onAddEntry={addEntry} locaisOrigem={locaisOrigem} onUpdateLocais={updateLocaisOrigem} onAddProduct={addProduct} categories={categories} entries={entries} exits={exits} isStockAdmin={isStockAdmin} onAddCategory={addCategory} onUpdateCategory={updateCategory} onDeleteCategory={deleteCategory} />
                            </div>
                            <div style={{display: activeTab === 'history' ? 'block' : 'none'}}>
                                <History entries={entries} exits={exits} products={products} shippings={shippings} onUpdateEntry={updateEntry} onDeleteEntry={deleteEntry} onUpdateExit={updateExit} onDeleteExit={deleteExit} isStockAdmin={isStockAdmin} />
                            </div>
                            {/* Tiny ERP — kept mounted to preserve connection status & sync progress */}
                            <div style={{display: activeTab === 'tiny' ? 'block' : 'none'}}>
                                <TinyERPPage user={user} onDataChanged={refetchData} products={products} entries={entries} exits={exits} stock={currentStock} onAddEntry={addEntry} onAddExit={addExit} onAddProduct={addProduct} categories={categories} locaisOrigem={locaisOrigem} onUpdateLocais={updateLocaisOrigem} onAddCategory={addCategory} onUpdateCategory={updateCategory} onDeleteCategory={deleteCategory} />
                            </div>
                            {/* Rare tabs — mounted on demand */}
                            {activeTab === 'newproduct' && <ProductForm onSubmit={addProduct} products={products} categories={categories} />}
                            {activeTab === 'import' && (isStockAdmin ? <ImportHub products={products} onImport={handleImport} onAddProduct={addProduct} categories={categories} locaisOrigem={locaisOrigem} onUpdateLocais={updateLocaisOrigem} entries={entries} exits={exits} stock={currentStock} onAddEntry={addEntry} onAddExit={addExit} /> : <AccessRestricted />)}
                            {activeTab === 'admin' && isSuperAdmin && <AdminPanel currentUserId={user.id} />}
                        </div>
                    </div>

                    <div className="sync-status">
                        <div className={`sync-indicator ${syncStatus}`}></div>
                        <span>{syncStatus === 'online' ? 'Sincronizado' : syncStatus === 'offline' ? 'Offline' : 'Sincronizando...'}</span>
                    </div>

                    {/* Mobile Bottom Navigation */}
                    <div className="mobile-bottom-nav" role="navigation" aria-label="Navegação principal">
                        <button
                            className={`nav-tab ${activeTab === 'dashboard' ? 'active' : ''}`}
                            onClick={() => handleTabChange('dashboard')}
                            aria-current={activeTab === 'dashboard' ? 'page' : undefined}
                            aria-label="Dashboard"
                        >
                            <Icon name="layoutDashboard" size={22} />
                            <span>Início</span>
                        </button>
                        <button
                            className={`nav-tab ${activeTab === 'stock' ? 'active' : ''}`}
                            onClick={() => handleTabChange('stock')}
                            aria-current={activeTab === 'stock' ? 'page' : undefined}
                            aria-label="Estoque"
                        >
                            <Icon name="package" size={22} />
                            <span>Produtos</span>
                        </button>
                        {isStockAdmin && (<button
                            className="nav-tab action-btn"
                            onClick={() => handleTabChange('entry')}
                            aria-label="Nova entrada"
                        >
                            <Icon name="plusCircle" size={26} />
                            <span>Novo</span>
                        </button>)}
                        {isStockAdmin && (<button
                            className={`nav-tab ${['entry','exit','shipping','history'].includes(activeTab) ? 'active' : ''}`}
                            onClick={() => setMobileSheet(mobileSheet === 'moves' ? null : 'moves')}
                            aria-label="Movimentações"
                            aria-expanded={mobileSheet === 'moves'}
                        >
                            <Icon name="arrowLeftRight" size={22} />
                            <span>Movimentar</span>
                        </button>)}
                        <button
                            className="nav-tab"
                            onClick={() => setSidebarOpen(true)}
                            aria-label="Menu completo"
                        >
                            <Icon name="menuIcon" size={22} />
                            <span>Mais</span>
                        </button>
                    </div>

                    {/* Bottom Sheet - Movimentações */}
                    <div className={`bottom-sheet-overlay ${mobileSheet === 'moves' ? 'visible' : ''}`} onClick={() => setMobileSheet(null)}></div>
                    <div className={`bottom-sheet ${mobileSheet === 'moves' ? 'open' : ''}`} role="dialog" aria-label="Movimentações">
                        <div className="bottom-sheet-handle"></div>
                        <div className="bottom-sheet-title">Movimentações</div>
                        <button className="bottom-sheet-item" onClick={() => handleTabChange('entry')}>
                            <span dangerouslySetInnerHTML={{__html: ICONS.entry}}></span>
                            Entrada de Estoque
                        </button>
                        <button className="bottom-sheet-item" onClick={() => handleTabChange('exit')}>
                            <span dangerouslySetInnerHTML={{__html: ICONS.exit}}></span>
                            Saída de Estoque
                        </button>
                        <button className="bottom-sheet-item" onClick={() => handleTabChange('shipping')}>
                            <span dangerouslySetInnerHTML={{__html: ICONS.shipping}}></span>
                            Despachos
                        </button>
                        <button className="bottom-sheet-item" onClick={() => handleTabChange('history')}>
                            <span dangerouslySetInnerHTML={{__html: ICONS.history}}></span>
                            Histórico
                        </button>
                    </div>
                </div>
            );
        }

        // ==========================================
        // DASHBOARD - NOVO DESIGN
        // ==========================================
        function Dashboard({ stock, categories, isVisible, entries, exits, onNavigate }) {
            // Loading state enquanto produtos ainda não carregaram
            if (stock.length === 0) {
                return (
                    <div style={{ padding: '60px 20px', textAlign: 'center' }}>
                        <div style={{
                            width: '28px', height: '28px',
                            border: '2.5px solid var(--border-default)',
                            borderTopColor: 'var(--accent-primary)',
                            borderRadius: '50%',
                            animation: 'spin 0.8s linear infinite',
                            margin: '0 auto 12px'
                        }} />
                        <p style={{ color: 'var(--text-secondary)', fontSize: '13px', margin: 0 }}>Carregando dashboard...</p>
                    </div>
                );
            }

            const chartRef = useRef(null);
            const lineChartRef = useRef(null);
            const chartInstance = useRef(null);
            const lineChartInstance = useRef(null);
            const [period, setPeriod] = useState(30);

            // === Cálculos memoizados do estoque ===
            const stockStats = useMemo(() => {
                const totalQty = stock.reduce((s, p) => s + p.currentQuantity, 0);
                const lowStock = stock.filter(p => p.status === 'low').length;
                const emptyStock = stock.filter(p => p.status === 'empty').length;
                const okStock = stock.filter(p => p.status === 'ok').length;
                const topProducts = [...stock].sort((a, b) => b.currentQuantity - a.currentQuantity).slice(0, 5);
                const alertProducts = [...stock].filter(p => p.status === 'low' || p.status === 'empty').slice(0, 5);
                const totalValue = stock.reduce((sum, p) => sum + ((p.unitPrice || 0) * (p.currentQuantity || 0)), 0);
                return { totalQty, totalProducts: stock.length, lowStock, emptyStock, okStock, topProducts, alertProducts, totalValue };
            }, [stock]);
            const { totalQty, totalProducts, lowStock, emptyStock, okStock, topProducts, alertProducts, totalValue } = stockStats;

            // Hora atual para saudação
            const hora = new Date().getHours();
            const saudacao = hora < 12 ? 'Bom dia' : hora < 18 ? 'Boa tarde' : 'Boa noite';

            const categoryStats = useMemo(() => categories.map(cat => {
                const catProducts = stock.filter(p => p.category === cat.id);
                return {
                    ...cat,
                    productCount: catProducts.length,
                    totalStock: catProducts.reduce((sum, p) => sum + (p.currentQuantity || 0), 0),
                    alertCount: catProducts.filter(p => p.status === 'low' || p.status === 'empty').length
                };
            }), [stock, categories]);

            // === Cálculos baseados em período (memoizados) ===
            const periodStats = useMemo(() => {
                const periodCutoff = new Date();
                periodCutoff.setDate(periodCutoff.getDate() - period);
                const periodCutoffISO = periodCutoff.toISOString();
                const periodEntries = (entries || []).filter(e => e.date >= periodCutoffISO);
                const periodExits = (exits || []).filter(e => e.date >= periodCutoffISO);
                const totalExitsInPeriod = periodExits.reduce((sum, e) => sum + parseInt(e.quantity || 0), 0);
                const giroEstoque = totalExitsInPeriod / Math.max(totalQty, 1);
                return { periodEntries, periodExits, totalExitsInPeriod, giroEstoque };
            }, [entries, exits, period, totalQty]);
            const { periodEntries, periodExits, totalExitsInPeriod, giroEstoque } = periodStats;

            // === Produtos parados (sem movimentação em 60 dias) ===
            const stoppedProducts = useMemo(() => {
                const stoppedCutoff = new Date();
                stoppedCutoff.setDate(stoppedCutoff.getDate() - 60);
                const stoppedCutoffISO = stoppedCutoff.toISOString();
                const activeSKUs = new Set([
                    ...(entries || []).filter(e => e.date >= stoppedCutoffISO).map(e => e.sku),
                    ...(exits || []).filter(e => e.date >= stoppedCutoffISO).map(e => e.sku)
                ]);
                return stock.filter(p => !activeSKUs.has(p.sku));
            }, [stock, entries, exits]);

            // === Últimas 5 movimentações ===
            const allMovements = useMemo(() => [
                ...(entries || []).map(e => ({ ...e, movType: 'entry' })),
                ...(exits || []).map(e => ({ ...e, movType: 'exit' }))
            ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5), [entries, exits]);

            // === Valor por categoria ===
            const categoryValues = useMemo(() => categories.map(cat => {
                const catProducts = stock.filter(p => p.category === cat.id);
                const value = catProducts.reduce((sum, p) => sum + ((p.unitPrice || 0) * (p.currentQuantity || 0)), 0);
                return { ...cat, value };
            }).filter(c => c.value > 0).sort((a, b) => b.value - a.value), [stock, categories]);

            // === Helper: agregar movimentações por dia ===
            const aggregateByDay = (items, days) => {
                const result = {};
                const now = new Date();
                for (let i = days - 1; i >= 0; i--) {
                    const d = new Date(now);
                    d.setDate(d.getDate() - i);
                    result[d.toISOString().slice(0, 10)] = 0;
                }
                items.forEach(item => {
                    const key = item.date?.slice(0, 10);
                    if (key && result[key] !== undefined) {
                        result[key] += parseInt(item.quantity || 0);
                    }
                });
                return result;
            };

            // Memoizar dados do chart para evitar recriação desnecessária
            const barChartData = useMemo(() => {
                if (stock.length === 0) return null;
                const top8 = [...stock].sort((a, b) => b.currentQuantity - a.currentQuantity).slice(0, 8);
                return {
                    labels: top8.map(p => p.name.length > 15 ? p.name.substring(0, 15) + '...' : p.name),
                    data: top8.map(p => p.currentQuantity)
                };
            }, [stock]);

            useEffect(() => {
                // Gráfico de barras — só cria quando tab visível (canvas precisa ter dimensões)
                if (!isVisible || !chartRef.current || !barChartData) return;

                // Se chart já existe, apenas atualizar dados (sem recriar = sem flicker)
                if (chartInstance.current) {
                    chartInstance.current.data.labels = barChartData.labels;
                    chartInstance.current.data.datasets[0].data = barChartData.data;
                    chartInstance.current.update('none'); // 'none' = sem animação
                    return;
                }

                chartInstance.current = new Chart(chartRef.current, {
                    type: 'bar',
                    data: {
                        labels: barChartData.labels,
                        datasets: [{
                            data: barChartData.data,
                            backgroundColor: '#F4B08A',
                            borderRadius: 6,
                            barThickness: 28
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#2C2640',
                                titleFont: { size: 12, weight: '600' },
                                bodyFont: { size: 11 },
                                padding: 12,
                                cornerRadius: 8
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: '#F3F0EC', drawBorder: false },
                                ticks: { font: { size: 11, family: 'Inter' }, color: '#7A7585' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 10, family: 'Inter' }, color: '#7A7585' }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                        chartInstance.current = null;
                    }
                };
            }, [barChartData, isVisible]);

            // Memoizar dados do gráfico de linhas
            const lineChartData = useMemo(() => {
                if (!entries?.length && !exits?.length) return null;
                const entryAgg = aggregateByDay(entries || [], period);
                const exitAgg = aggregateByDay(exits || [], period);
                const labels = Object.keys(entryAgg).map(d => {
                    const [, m, day] = d.split('-');
                    return `${day}/${m}`;
                });
                return { labels, entryData: Object.values(entryAgg), exitData: Object.values(exitAgg) };
            }, [entries, exits, period]);

            // Gráfico de linhas — movimentações por dia
            useEffect(() => {
                if (!isVisible || !lineChartRef.current || !lineChartData) return;

                // Se chart já existe, apenas atualizar dados
                if (lineChartInstance.current) {
                    lineChartInstance.current.data.labels = lineChartData.labels;
                    lineChartInstance.current.data.datasets[0].data = lineChartData.entryData;
                    lineChartInstance.current.data.datasets[1].data = lineChartData.exitData;
                    lineChartInstance.current.update('none');
                    return;
                }

                const rootStyles = getComputedStyle(document.documentElement);
                const successColor = rootStyles.getPropertyValue('--accent-success').trim() || '#22c55e';
                const errorColor = rootStyles.getPropertyValue('--accent-error').trim() || '#ef4444';
                const gridColor = rootStyles.getPropertyValue('--border-default').trim() || '#e5e5e5';
                const textColor = rootStyles.getPropertyValue('--text-tertiary').trim() || '#999';

                lineChartInstance.current = new Chart(lineChartRef.current, {
                    type: 'line',
                    data: {
                        labels: lineChartData.labels,
                        datasets: [
                            {
                                label: 'Entradas',
                                data: lineChartData.entryData,
                                borderColor: successColor,
                                backgroundColor: successColor + '18',
                                fill: true,
                                tension: 0.3,
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 4,
                                pointHoverBackgroundColor: successColor
                            },
                            {
                                label: 'Saídas',
                                data: lineChartData.exitData,
                                borderColor: errorColor,
                                backgroundColor: errorColor + '18',
                                fill: true,
                                tension: 0.3,
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 4,
                                pointHoverBackgroundColor: errorColor
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                align: 'end',
                                labels: {
                                    boxWidth: 12, boxHeight: 12, borderRadius: 3, useBorderRadius: true,
                                    font: { size: 11, family: 'Inter' },
                                    color: textColor,
                                    padding: 16
                                }
                            },
                            tooltip: {
                                backgroundColor: '#2C2640',
                                titleFont: { size: 12, weight: '600' },
                                bodyFont: { size: 11 },
                                padding: 12,
                                cornerRadius: 8
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: gridColor, drawBorder: false },
                                ticks: { font: { size: 11, family: 'Inter' }, color: textColor }
                            },
                            x: {
                                grid: { display: false },
                                ticks: {
                                    font: { size: 10, family: 'Inter' },
                                    color: textColor,
                                    maxTicksLimit: period <= 15 ? period : 10
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (lineChartInstance.current) {
                        lineChartInstance.current.destroy();
                        lineChartInstance.current = null;
                    }
                };
            }, [lineChartData, isVisible]);

            return (
                <div>
                    {/* Header com Saudação */}
                    <div className="page-header" style={{marginBottom: '32px'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                            <div>
                                <p style={{fontSize: '14px', color: 'var(--text-muted)', marginBottom: '4px'}}>
                                    {saudacao}!                                 </p>
                                <h1 className="page-title">Dashboard</h1>
                                <p className="page-subtitle">Visão geral do seu estoque em tempo real</p>
                            </div>
                            <div style={{display: 'flex', gap: '12px'}}>
                                <div style={{
                                    background: 'var(--bg-secondary)',
                                    padding: '10px 16px',
                                    borderRadius: 'var(--radius-lg)',
                                    fontSize: '13px',
                                    color: 'var(--text-secondary)',
                                    boxShadow: 'var(--shadow-card)',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}>
                                    {new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'short' })}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Cards de Estatísticas */}
                    <div className="stats-grid">
                        <div className="stat-card accent">
                            <div className="stat-header">
                                <div className="stat-icon" style={{background: 'rgba(255,255,255,0.2)'}}><Icon name="stock" size={18} /></div>
                            </div>
                            <div className="stat-content">
                                <div className="stat-value">{totalQty.toLocaleString('pt-BR')}</div>
                                <div className="stat-label">Unidades em Estoque</div>
                            </div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-header">
                                <div className="stat-icon purple"><Icon name="categories" size={18} /></div>
                            </div>
                            <div className="stat-content">
                                <div className="stat-value">{totalProducts}</div>
                                <div className="stat-label">Produtos Cadastrados</div>
                            </div>
                        </div>
                        
                        <div className="stat-card warning">
                            <div className="stat-header">
                                <div className="stat-icon yellow"><Icon name="warning" size={18} /></div>
                            </div>
                            <div className="stat-content">
                                <div className="stat-value">{lowStock}</div>
                                <div className="stat-label">Estoque Baixo</div>
                            </div>
                        </div>
                        
                        <div className="stat-card danger">
                            <div className="stat-header">
                                <div className="stat-icon red"><Icon name="error" size={18} /></div>
                            </div>
                            <div className="stat-content">
                                <div className="stat-value">{emptyStock}</div>
                                <div className="stat-label">Sem Estoque</div>
                            </div>
                        </div>

                        <div className="stat-card">
                            <div className="stat-header">
                                <div className="stat-icon green"><Icon name="dollar" size={18} /></div>
                            </div>
                            <div className="stat-content">
                                <div className="stat-value" style={{fontSize: totalValue >= 100000 ? '22px' : '28px'}}>
                                    {totalValue > 0 ? `R$ ${formatBRL(totalValue)}` : 'R$ 0,00'}
                                </div>
                                <div className="stat-label">
                                    {totalValue > 0 ? 'Valor Total em Estoque' : 'Nenhum preço sincronizado via Tiny'}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Grid Principal */}
                    <div className="dashboard-main-grid">
                        {/* Gráfico de Barras */}
                        <div className="card">
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                                <h2 className="card-title" style={{marginBottom: 0}}>
                                    <span className="card-title-icon">▥</span>
                                    Produtos com Maior Estoque
                                </h2>
                            </div>
                            <div style={{height: '280px'}}>
                                <canvas ref={chartRef}></canvas>
                            </div>
                        </div>

                        {/* Lista de Alertas */}
                        <div className="card">
                            <h2 className="card-title" style={{marginBottom: '20px'}}>
                                <Icon name="warning" size={16} className="card-title-icon" />
                                Ações Pendentes
                            </h2>

                            {alertProducts.length === 0 ? (
                                <div style={{
                                    textAlign: 'center',
                                    padding: '40px 20px',
                                    color: 'var(--text-tertiary)'
                                }}>
                                    <div style={{marginBottom: '12px'}}><Icon name="check" size={40} /></div>
                                    <div style={{fontSize: '14px'}}>Tudo em ordem!</div>
                                    <div style={{fontSize: '12px', marginTop: '4px', color: 'var(--text-tertiary)'}}>
                                        Nenhum produto com estoque crítico
                                    </div>
                                </div>
                            ) : (
                                <div style={{display: 'flex', flexDirection: 'column', gap: '8px'}}>
                                    {alertProducts.map((p, idx) => (
                                        <div key={idx} style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '12px',
                                            padding: '12px',
                                            background: 'var(--bg-secondary)',
                                            border: '1px solid var(--border-default)',
                                            borderRadius: 'var(--radius)',
                                            borderLeft: `3px solid ${p.status === 'empty' ? 'var(--accent-error)' : 'var(--accent-warning)'}`
                                        }}>
                                            <div style={{
                                                width: '32px',
                                                height: '32px',
                                                borderRadius: 'var(--radius)',
                                                background: p.status === 'empty' ? 'var(--accent-error-subtle)' : 'var(--accent-warning-subtle)',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                color: p.status === 'empty' ? 'var(--accent-error)' : 'var(--accent-warning)'
                                            }}>
                                                {p.status === 'empty' ? <Icon name="error" size={14} /> : <Icon name="warning" size={14} />}
                                            </div>
                                            <div style={{flex: 1, minWidth: 0}}>
                                                <div style={{
                                                    fontSize: '13px',
                                                    fontWeight: '500',
                                                    color: 'var(--text-primary)',
                                                    whiteSpace: 'nowrap',
                                                    overflow: 'hidden',
                                                    textOverflow: 'ellipsis'
                                                }}>
                                                    {p.name}
                                                </div>
                                                <div style={{fontSize: '12px', color: 'var(--text-tertiary)'}}>
                                                    {p.status === 'empty' ? 'Sem estoque' : `${p.currentQuantity} un. restantes`}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    {lowStock + emptyStock > 5 && (
                                        <div style={{
                                            textAlign: 'center',
                                            marginTop: '4px',
                                            fontSize: '12px',
                                            color: 'var(--text-tertiary)'
                                        }}>
                                            +{lowStock + emptyStock - 5} outros produtos
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Movimentações */}
                    <div className="card">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '12px'}}>
                            <h2 className="card-title" style={{marginBottom: 0}}>
                                <Icon name="chart" size={16} className="card-title-icon" />
                                Movimentações
                            </h2>
                            <div className="period-toggle">
                                {[7, 15, 30, 90].map(d => (
                                    <button key={d} className={`period-btn ${period === d ? 'active' : ''}`} onClick={() => setPeriod(d)}>
                                        {d}d
                                    </button>
                                ))}
                            </div>
                        </div>
                        {(entries?.length || exits?.length) ? (
                            <div style={{height: '280px'}}>
                                <canvas ref={lineChartRef}></canvas>
                            </div>
                        ) : (
                            <div style={{textAlign: 'center', padding: '40px', color: 'var(--text-tertiary)', fontSize: '13px'}}>
                                Nenhuma movimentação registrada
                            </div>
                        )}
                    </div>

                    {/* Métricas de Performance */}
                    <div className="dashboard-analytics-grid">
                        <div className="card" style={{marginBottom: 0}}>
                            <h2 className="card-title">
                                <Icon name="trendingUp" size={16} className="card-title-icon" />
                                Giro de Estoque
                            </h2>
                            <div style={{textAlign: 'center', padding: '16px 0'}}>
                                <div style={{fontSize: '36px', fontWeight: '700', color: 'var(--text-primary)', fontVariantNumeric: 'tabular-nums'}}>
                                    {giroEstoque.toFixed(2)}
                                </div>
                                <div style={{fontSize: '12px', color: 'var(--text-tertiary)', marginTop: '4px'}}>
                                    Saídas / Estoque atual em {period} dias
                                </div>
                            </div>
                        </div>

                        <div className="card" style={{marginBottom: 0}}>
                            <h2 className="card-title" style={{display: 'flex', alignItems: 'center'}}>
                                <Icon name="pause" size={16} className="card-title-icon" />
                                Produtos Parados
                                <span style={{marginLeft: 'auto', fontSize: '20px', fontWeight: '700', color: stoppedProducts.length > 0 ? 'var(--accent-warning)' : 'var(--accent-success)'}}>
                                    {stoppedProducts.length}
                                </span>
                            </h2>
                            <div style={{fontSize: '12px', color: 'var(--text-tertiary)', marginBottom: '12px'}}>
                                Sem entradas ou saídas nos últimos 60 dias
                            </div>
                            {stoppedProducts.length > 0 ? (
                                <div style={{display: 'flex', flexDirection: 'column', gap: '6px'}}>
                                    {stoppedProducts.slice(0, 5).map((p, idx) => (
                                        <div key={idx} style={{fontSize: '13px', color: 'var(--text-secondary)', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', padding: '6px 10px', background: 'var(--bg-tertiary)', borderRadius: 'var(--radius-sm)'}}>
                                            {p.name}
                                        </div>
                                    ))}
                                    {stoppedProducts.length > 5 && (
                                        <div style={{fontSize: '12px', color: 'var(--text-tertiary)', textAlign: 'center', marginTop: '4px'}}>
                                            +{stoppedProducts.length - 5} outros
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div style={{textAlign: 'center', padding: '16px', color: 'var(--accent-success)', fontSize: '13px'}}>
                                    Todos os produtos tiveram movimentação recente
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Últimas Movimentações + Valor por Categoria */}
                    <div className="dashboard-analytics-grid" style={{marginTop: '4px'}}>
                        <div className="card" style={{marginBottom: 0}}>
                            <h2 className="card-title">
                                <Icon name="history" size={16} className="card-title-icon" />
                                Últimas Movimentações
                            </h2>
                            {allMovements.length > 0 ? (
                                <div className="table-container">
                                    <table className="table">
                                        <thead>
                                            <tr>
                                                <th>Data</th>
                                                <th>Tipo</th>
                                                <th>Produto</th>
                                                <th style={{textAlign: 'right'}}>Qtd</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {allMovements.map((m, idx) => {
                                                const product = stock.find(p => p.sku === m.sku);
                                                return (
                                                    <tr key={idx} className="clickable-row" onClick={() => onNavigate && onNavigate('history')}>
                                                        <td style={{whiteSpace: 'nowrap'}}>
                                                            {new Date(m.date).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'})}
                                                            {' '}
                                                            <span style={{color: 'var(--text-tertiary)', fontSize: '11px'}}>
                                                                {new Date(m.date).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <span className={`badge ${m.movType === 'entry' ? 'badge-success' : 'badge-danger'}`}>
                                                                {m.movType === 'entry' ? 'ENTRADA' : 'SAÍDA'}
                                                            </span>
                                                        </td>
                                                        <td style={{maxWidth: '120px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                                            {product?.name || m.sku}
                                                        </td>
                                                        <td style={{textAlign: 'right', fontWeight: '600', fontVariantNumeric: 'tabular-nums'}}>
                                                            {m.movType === 'entry' ? '+' : '-'}{m.quantity}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            ) : (
                                <div style={{textAlign: 'center', padding: '32px', color: 'var(--text-tertiary)', fontSize: '13px'}}>
                                    Nenhuma movimentação registrada
                                </div>
                            )}
                        </div>

                        <div className="card" style={{marginBottom: 0}}>
                            <h2 className="card-title">
                                <Icon name="dollar" size={16} className="card-title-icon" />
                                Valor por Categoria
                            </h2>
                            {categoryValues.length > 0 ? (
                                <div style={{display: 'flex', flexDirection: 'column', gap: '10px'}}>
                                    {categoryValues.map((cat) => {
                                        const maxVal = categoryValues[0]?.value || 1;
                                        const pct = (cat.value / maxVal) * 100;
                                        return (
                                            <div key={cat.id} style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                                <div style={{width: '28px', height: '28px', flexShrink: 0, display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                                                    <CategoryIcon icon={cat.icon} size={18} color={cat.color} />
                                                </div>
                                                <div style={{flex: 1, minWidth: 0}}>
                                                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '4px'}}>
                                                        <span style={{fontSize: '13px', fontWeight: '500', color: 'var(--text-primary)', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                                            {cat.name}
                                                        </span>
                                                        <span style={{fontSize: '13px', fontWeight: '600', color: 'var(--text-primary)', fontVariantNumeric: 'tabular-nums', flexShrink: 0, marginLeft: '8px'}}>
                                                            R$ {formatBRL(cat.value)}
                                                        </span>
                                                    </div>
                                                    <div style={{height: '4px', background: 'var(--border-default)', borderRadius: '2px', overflow: 'hidden'}}>
                                                        <div style={{height: '100%', width: `${pct}%`, background: cat.color, borderRadius: '2px', transition: 'width 0.5s ease'}}></div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            ) : (
                                <div style={{textAlign: 'center', padding: '32px', color: 'var(--text-tertiary)', fontSize: '13px'}}>
                                    Sincronize os produtos via Tiny ERP para ver os valores
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Categorias */}
                    <div className="card">
                        <h2 className="card-title">
                            <Icon name="categories" size={16} className="card-title-icon" />
                            Estoque por Categoria
                        </h2>
                        <div className="category-grid">
                            {categoryStats.map(cat => (
                                <div key={cat.id} className="category-card">
                                    <div className="category-icon" style={{background: `${cat.color}08`}}>
                                        <CategoryIcon icon={cat.icon} size={20} color={cat.color} />
                                    </div>
                                    <div className="category-name">{cat.name}</div>
                                    <div className="category-count">
                                        {cat.totalStock.toLocaleString('pt-BR')}
                                    </div>
                                    <div className="category-meta">
                                        {cat.productCount} produto{cat.productCount !== 1 ? 's' : ''}
                                    </div>
                                    {cat.alertCount > 0 && (
                                        <div className="category-alert">
                                            {cat.alertCount} alerta{cat.alertCount !== 1 ? 's' : ''}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Top 5 Produtos */}
                    <div className="card">
                        <h2 className="card-title">
                            <span className="card-title-icon">◆</span>
                            Top 5 Produtos em Estoque
                        </h2>
                        <div style={{display: 'flex', flexDirection: 'column', gap: '12px'}}>
                            {topProducts.map((p, idx) => {
                                const cat = categories.find(c => c.id === p.category);
                                const maxQty = topProducts[0]?.currentQuantity || 1;
                                const percentage = (p.currentQuantity / maxQty) * 100;
                                
                                return (
                                    <div key={idx} style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '16px',
                                        padding: '16px',
                                        background: 'var(--bg-tertiary)',
                                        borderRadius: 'var(--radius-lg)',
                                        transition: 'var(--transition)'
                                    }}>
                                        <div style={{
                                            width: '36px',
                                            height: '36px',
                                            borderRadius: 'var(--radius)',
                                            background: idx === 0 ? 'var(--text-primary)' : 'var(--bg-tertiary)',
                                            color: idx === 0 ? 'white' : 'var(--text-tertiary)',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontWeight: '700',
                                            fontSize: '13px'
                                        }}>
                                            #{idx + 1}
                                        </div>
                                        <div style={{flex: 1, minWidth: 0}}>
                                            <div style={{
                                                fontWeight: '500',
                                                fontSize: '14px',
                                                marginBottom: '4px',
                                                whiteSpace: 'nowrap',
                                                overflow: 'hidden',
                                                textOverflow: 'ellipsis'
                                            }}>
                                                {p.name}
                                            </div>
                                            <div style={{
                                                height: '4px',
                                                background: 'var(--border-default)',
                                                borderRadius: '2px',
                                                overflow: 'hidden'
                                            }}>
                                                <div style={{
                                                    height: '100%',
                                                    width: `${percentage}%`,
                                                    background: idx === 0 ? 'var(--text-secondary)' : idx === 1 ? 'var(--text-tertiary)' : 'var(--border-strong)',
                                                    borderRadius: '2px',
                                                    transition: 'width 0.5s ease'
                                                }}></div>
                                            </div>
                                        </div>
                                        <div style={{textAlign: 'right'}}>
                                            <div style={{
                                                fontWeight: '700',
                                                fontSize: '20px',
                                                color: 'var(--text-primary)'
                                            }}>
                                                {p.currentQuantity.toLocaleString('pt-BR')}
                                            </div>
                                            <div style={{fontSize: '11px', color: 'var(--text-tertiary)'}}>
                                                unidades
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        // ==========================================
        // STOCK VIEW
        // ==========================================
        function StockView({ stock, categories, onUpdate, onDelete, searchTerm, setSearchTerm, entries, exits, locaisOrigem }) {
            // Loading state enquanto produtos ainda não carregaram
            if (stock.length === 0) {
                return (
                    <div style={{ padding: '60px 20px', textAlign: 'center' }}>
                        <div style={{
                            width: '28px', height: '28px',
                            border: '2.5px solid var(--border-default)',
                            borderTopColor: 'var(--accent-primary)',
                            borderRadius: '50%',
                            animation: 'spin 0.8s linear infinite',
                            margin: '0 auto 12px'
                        }} />
                        <p style={{ color: 'var(--text-secondary)', fontSize: '13px', margin: 0 }}>Carregando estoque...</p>
                    </div>
                );
            }

            const [filter, setFilter] = useState('all');
            const [editingProduct, setEditingProduct] = useState(null);
            const [editForm, setEditForm] = useState({});
            const [successMsg, setSuccessMsg] = useState('');
            const [historyProduct, setHistoryProduct] = useState(null);

            // Busca com debounce
            const [searchInput, setSearchInput] = useState(searchTerm || '');
            const [debouncedSearch, setDebouncedSearch] = useState(searchTerm || '');
            useEffect(() => {
                const timer = setTimeout(() => {
                    setDebouncedSearch(searchInput);
                    setSearchTerm(searchInput);
                }, 300);
                return () => clearTimeout(timer);
            }, [searchInput]);

            // Ordenação e filtros
            const [sortBy, setSortBy] = useState('name');
            const [sortOrder, setSortOrder] = useState('asc');
            const [hideZeroStock, setHideZeroStock] = useState(true);

            // Categorias expandidas/recolhidas
            const [expandedCategories, setExpandedCategories] = useState(() => {
                const initial = {};
                categories.forEach(cat => { initial[cat.name] = true; });
                initial['Sem categoria'] = false;
                return initial;
            });

            const toggleCategory = (catName) => {
                setExpandedCategories(prev => ({ ...prev, [catName]: !prev[catName] }));
            };

            const getCategoryName = (catId) => {
                const cat = categories.find(c => c.id === catId);
                return cat ? cat.name : 'Sem categoria';
            };

            const getCategoryColor = (catId) => {
                const cat = categories.find(c => c.id === catId);
                return cat?.color || '#6b7280';
            };

            // Função de ordenação
            const sortProducts = (prods, by, order) => {
                return [...prods].sort((a, b) => {
                    let cmp = 0;
                    switch (by) {
                        case 'name': cmp = (a.name || '').localeCompare(b.name || ''); break;
                        case 'date': cmp = new Date(a.createdAt || 0) - new Date(b.createdAt || 0); break;
                        case 'price': cmp = (a.unitPrice || 0) - (b.unitPrice || 0); break;
                        case 'quantity': cmp = (a.currentQuantity || 0) - (b.currentQuantity || 0); break;
                        default: cmp = 0;
                    }
                    return order === 'desc' ? -cmp : cmp;
                });
            };

            // Busca ativa = mostrar tudo independente do toggle
            const hasSearch = debouncedSearch.trim() !== '';

            // Produtos agrupados por categoria (PERFORMANCE: useMemo)
            const groupedProducts = useMemo(() => {
                let filtered = stock;

                // Filtro de busca
                if (hasSearch) {
                    const term = debouncedSearch.toLowerCase();
                    filtered = filtered.filter(p =>
                        (p.name || '').toLowerCase().includes(term) ||
                        (p.sku || '').toLowerCase().includes(term) ||
                        (p.ean || '').toLowerCase().includes(term) ||
                        (p.nfOrigem || '').toLowerCase().includes(term)
                    );
                }

                // Filtro de status (abas)
                if (filter !== 'all') {
                    filtered = filtered.filter(p => p.status === filter);
                }

                // Ocultar zerados (exceto se busca ativa ou aba "Zerado")
                if (hideZeroStock && !hasSearch && filter !== 'empty') {
                    filtered = filtered.filter(p => p.currentQuantity > 0);
                }

                // Agrupar por categoria
                const groups = {};
                categories.forEach(cat => { groups[cat.name] = []; });
                groups['Sem categoria'] = [];

                filtered.forEach(product => {
                    const catName = getCategoryName(product.category);
                    if (!groups[catName]) groups[catName] = [];
                    groups[catName].push(product);
                });

                // Ordenar dentro de cada grupo
                Object.keys(groups).forEach(catName => {
                    groups[catName] = sortProducts(groups[catName], sortBy, sortOrder);
                });

                return groups;
            }, [stock, categories, debouncedSearch, hideZeroStock, sortBy, sortOrder, filter]);

            // Contagem total de produtos filtrados
            const totalFiltered = useMemo(() => {
                return Object.values(groupedProducts).reduce((sum, arr) => sum + arr.length, 0);
            }, [groupedProducts]);

            // Contagens para as abas de status (sem filtro de status mas com busca e hideZeroStock)
            const statusCounts = useMemo(() => {
                let base = stock;
                if (hasSearch) {
                    const term = debouncedSearch.toLowerCase();
                    base = base.filter(p =>
                        (p.name || '').toLowerCase().includes(term) ||
                        (p.sku || '').toLowerCase().includes(term) ||
                        (p.ean || '').toLowerCase().includes(term) ||
                        (p.nfOrigem || '').toLowerCase().includes(term)
                    );
                }
                const all = hideZeroStock && !hasSearch ? base.filter(p => p.currentQuantity > 0) : base;
                return {
                    all: all.length,
                    ok: base.filter(p => p.status === 'ok').length,
                    low: base.filter(p => p.status === 'low').length,
                    empty: base.filter(p => p.status === 'empty').length,
                };
            }, [stock, debouncedSearch, hideZeroStock]);

            // Quando busca ativa, expandir tudo automaticamente
            useEffect(() => {
                if (debouncedSearch.trim() !== '') {
                    setExpandedCategories(prev => {
                        const next = { ...prev };
                        categories.forEach(cat => { next[cat.name] = true; });
                        next['Sem categoria'] = true;
                        return next;
                    });
                }
            }, [debouncedSearch]);

            const openEditModal = (product) => {
                setEditForm({
                    name: product.name || '',
                    sku: product.sku || '',
                    ean: product.ean || '',
                    category: product.category || '',
                    minStock: product.minStock || 3,
                    observations: product.observations || '',
                    nfOrigem: product.nfOrigem || '',
                    local: product.local || '',
                });
                setEditingProduct(product);
            };

            // Obter histórico de movimentações do produto
            const getProductHistory = (sku) => {
                const productEntries = (entries || []).filter(e => e.sku === sku).map(e => ({...e, movimento: 'ENTRADA'}));
                const productExits = (exits || []).filter(e => e.sku === sku).map(e => ({...e, movimento: 'SAÍDA'}));
                return [...productEntries, ...productExits].sort((a, b) => new Date(b.date) - new Date(a.date));
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                const date = new Date(dateStr);
                return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
            };

            const handleSaveEdit = async () => {
                if (!editForm.name || !editForm.sku) return;
                await onUpdate(editingProduct.id, { ...editForm });
                setEditingProduct(null);
                setSuccessMsg('Produto atualizado!');
                setTimeout(() => setSuccessMsg(''), 3000);
            };

            const handleDelete = (product) => {
                if (window.confirm(`Excluir "${product.name}"?`)) {
                    onDelete(product.id);
                }
            };

            return (
                <div>
                    <div className="page-header">
                        <h1 className="page-title">Estoque</h1>
                        <p className="page-subtitle">Visualize e gerencie seus produtos</p>
                    </div>

                    {successMsg && <div className="alert alert-success">{successMsg}</div>}

                    {/* Modal de Edição */}
                    {editingProduct && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h2 className="modal-title">Editar Produto</h2>
                                <p className="modal-subtitle">Atualize as informações do produto</p>

                                <div className="form-group">
                                    <label className="form-label">Nome do Produto</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={editForm.name}
                                        onChange={(e) => setEditForm({...editForm, name: e.target.value})}
                                    />
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">SKU</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            value={editForm.sku}
                                            onChange={(e) => setEditForm({...editForm, sku: e.target.value})}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">EAN</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            value={editForm.ean}
                                            onChange={(e) => setEditForm({...editForm, ean: e.target.value})}
                                        />
                                    </div>
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">Categoria</label>
                                        <select
                                            className="form-select"
                                            value={editForm.category}
                                            onChange={(e) => setEditForm({...editForm, category: e.target.value})}
                                        >
                                            <option value="">Sem categoria</option>
                                            {categories.map(cat => (
                                                <option key={cat.id} value={cat.id}>{cat.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Estoque Mínimo</label>
                                        <input
                                            type="number"
                                            className="form-input"
                                            value={editForm.minStock}
                                            onChange={(e) => setEditForm({...editForm, minStock: e.target.value})}
                                        />
                                    </div>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Local</label>
                                    <select
                                        className="form-select"
                                        value={editForm.local || ''}
                                        onChange={(e) => setEditForm({...editForm, local: e.target.value})}
                                    >
                                        <option value="">Selecione o local</option>
                                        {(locaisOrigem || []).map(l => (
                                            <option key={l} value={l}>{l}</option>
                                        ))}
                                    </select>
                                </div>

                                {editingProduct && editingProduct.unitPrice > 0 && (
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Preço Unitário</label>
                                            <div style={{padding: '8px 0', fontSize: '14px', color: 'var(--text-primary)'}}>
                                                R$ {formatBRL(editingProduct.unitPrice)}
                                            </div>
                                            <span style={{color: 'var(--text-tertiary)', fontSize: '11px'}}>Sincronizado via Tiny ERP</span>
                                        </div>
                                        <div className="form-group"></div>
                                    </div>
                                )}

                                <div className="form-group">
                                    <label className="form-label">NF de Origem</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={editForm.nfOrigem}
                                        onChange={(e) => setEditForm({...editForm, nfOrigem: e.target.value})}
                                        placeholder="Número da NF para localizar no estoque"
                                    />
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Observações</label>
                                    <textarea
                                        className="form-textarea"
                                        value={editForm.observations}
                                        onChange={(e) => setEditForm({...editForm, observations: e.target.value})}
                                        placeholder="Informações adicionais sobre o produto..."
                                    />
                                </div>

                                <div style={{background: 'var(--bg-primary)', padding: '12px', borderRadius: 'var(--radius)', marginBottom: '16px', fontSize: '13px'}}>
                                    <strong>Estoque atual:</strong> {editingProduct.currentQuantity} unidades
                                    <div style={{fontSize: '11px', color: 'var(--text-muted)', marginTop: '4px'}}>
                                        Para alterar quantidade, use Entrada ou Saída
                                    </div>
                                </div>

                                <div className="btn-group">
                                    <button className="btn btn-primary" onClick={handleSaveEdit}>Salvar</button>
                                    <button className="btn btn-secondary" onClick={() => setEditingProduct(null)}>Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal de Histórico de Movimentações */}
                    {historyProduct && (
                        <div className="modal-overlay">
                            <div className="modal-content" style={{maxWidth: '800px'}}>
                                <h2 className="modal-title">Histórico de Movimentações</h2>
                                <p className="modal-subtitle">{historyProduct.name}</p>

                                <div style={{background: 'var(--bg-primary)', padding: '12px', borderRadius: 'var(--radius)', marginBottom: '16px'}}>
                                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', fontSize: '13px'}}>
                                        <div><strong>SKU:</strong> {historyProduct.sku}</div>
                                        <div><strong>Estoque Atual:</strong> {historyProduct.currentQuantity} un.</div>
                                    </div>
                                </div>

                                {(() => {
                                    const history = getProductHistory(historyProduct.sku);
                                    if (history.length === 0) {
                                        return (
                                            <div style={{textAlign: 'center', padding: '24px', color: 'var(--text-muted)'}}>
                                                Nenhuma movimentação registrada
                                            </div>
                                        );
                                    }
                                    return (
                                        <div className="table-container" style={{maxHeight: '350px', overflowY: 'auto'}}>
                                            <table className="table">
                                                <thead>
                                                    <tr>
                                                        <th>Data</th>
                                                        <th>Tipo</th>
                                                        <th>Qtd</th>
                                                        <th>Local</th>
                                                        <th>NF Entrada</th>
                                                        <th>NF Saída</th>
                                                        <th>Fornecedor/Cliente</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {history.map((mov, idx) => (
                                                        <tr key={idx}>
                                                            <td style={{fontSize: '11px', whiteSpace: 'nowrap'}}>{formatDate(mov.date)}</td>
                                                            <td>
                                                                <span style={{
                                                                    background: mov.movimento === 'ENTRADA' ? 'var(--success-light)' : 'var(--danger-light)',
                                                                    color: mov.movimento === 'ENTRADA' ? 'var(--success)' : 'var(--danger)',
                                                                    padding: '2px 8px',
                                                                    borderRadius: '10px',
                                                                    fontSize: '10px',
                                                                    fontWeight: '600'
                                                                }}>
                                                                    {mov.movimento}
                                                                </span>
                                                            </td>
                                                            <td style={{fontWeight: '600'}}>{mov.quantity}</td>
                                                            <td style={{fontSize: '11px'}}>
                                                                {mov.localEntrada && (
                                                                    <span style={{
                                                                        background: 'var(--accent-bg)',
                                                                        color: 'var(--accent)',
                                                                        padding: '2px 6px',
                                                                        borderRadius: '8px',
                                                                        fontSize: '10px'
                                                                    }}>
                                                                        {mov.localEntrada}
                                                                    </span>
                                                                )}
                                                            </td>
                                                            <td style={{fontFamily: 'monospace', fontSize: '11px'}}>
                                                                {mov.movimento === 'ENTRADA' ? (mov.nf || '-') : (mov.nfOrigem || '-')}
                                                            </td>
                                                            <td style={{fontFamily: 'monospace', fontSize: '11px'}}>
                                                                {mov.movimento === 'SAÍDA' ? (mov.nf || '-') : '-'}
                                                            </td>
                                                            <td style={{fontSize: '12px'}}>{mov.supplier || mov.client || '-'}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    );
                                })()}

                                {/* Resumo por NF de entrada */}
                                {(() => {
                                    const history = getProductHistory(historyProduct.sku);
                                    const entradas = history.filter(h => h.movimento === 'ENTRADA');
                                    const saidas = history.filter(h => h.movimento === 'SAÍDA');
                                    
                                    // Calcular saldo por NF incluindo local
                                    const saldoPorNF = {};
                                    entradas.forEach(e => {
                                        const nfKey = e.nf || 'SEM_NF';
                                        if (!saldoPorNF[nfKey]) saldoPorNF[nfKey] = { entradas: 0, saidas: 0, local: e.localEntrada || '-' };
                                        saldoPorNF[nfKey].entradas += e.quantity;
                                    });
                                    saidas.forEach(s => {
                                        const nfKey = s.nfOrigem || 'SEM_NF';
                                        if (!saldoPorNF[nfKey]) saldoPorNF[nfKey] = { entradas: 0, saidas: 0, local: '-' };
                                        saldoPorNF[nfKey].saidas += s.quantity;
                                    });
                                    
                                    const nfsComSaldo = Object.entries(saldoPorNF).filter(([nf, dados]) => dados.entradas - dados.saidas > 0);
                                    
                                    if (nfsComSaldo.length === 0) return null;
                                    
                                    return (
                                        <div style={{marginTop: '16px', padding: '12px', background: 'var(--info-light)', borderRadius: 'var(--radius)'}}>
                                            <div style={{fontWeight: '600', marginBottom: '8px', fontSize: '13px'}}>Estoque por NF de Entrada:</div>
                                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px'}}>
                                                {nfsComSaldo.map(([nf, dados]) => (
                                                    <div key={nf} style={{
                                                        background: 'white',
                                                        padding: '6px 12px',
                                                        borderRadius: 'var(--radius)',
                                                        fontSize: '12px'
                                                    }}>
                                                        <strong>NF {nf === 'SEM_NF' ? '(sem NF)' : nf}:</strong> {dados.entradas - dados.saidas} un.
                                                        {dados.local && dados.local !== '-' && (
                                                            <span style={{marginLeft: '6px', color: 'var(--accent)', fontSize: '11px'}}>
                                                                {dados.local}
                                                            </span>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })()}

                                <div className="btn-group" style={{marginTop: '16px'}}>
                                    <button className="btn btn-secondary" onClick={() => setHistoryProduct(null)}>Fechar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Barra de busca */}
                    <div className="card" style={{marginBottom: '12px'}}>
                        <div className="search-box">
                            <span className="search-icon"><Icon name="search" size={14} /></span>
                            <input
                                type="text"
                                className="search-input"
                                placeholder="Buscar por nome, SKU, EAN ou NF..."
                                value={searchInput}
                                onChange={(e) => setSearchInput(e.target.value)}
                            />
                            {searchInput && (
                                <button onClick={() => { setSearchInput(''); setDebouncedSearch(''); setSearchTerm(''); }} style={{background: 'none', border: 'none', cursor: 'pointer', padding: '4px 8px', color: '#999', fontSize: '16px'}} title="Limpar busca">&times;</button>
                            )}
                        </div>

                        {/* Abas de status */}
                        <div className="filter-tabs">
                            <button className={`filter-tab ${filter === 'all' ? 'active' : ''}`} onClick={() => setFilter('all')}>
                                Todos ({statusCounts.all})
                            </button>
                            <button className={`filter-tab ${filter === 'ok' ? 'active' : ''}`} onClick={() => setFilter('ok')}>
                                OK ({statusCounts.ok})
                            </button>
                            <button className={`filter-tab ${filter === 'low' ? 'active' : ''}`} onClick={() => setFilter('low')}>
                                Baixo ({statusCounts.low})
                            </button>
                            <button className={`filter-tab ${filter === 'empty' ? 'active' : ''}`} onClick={() => setFilter('empty')}>
                                Zerado ({statusCounts.empty})
                            </button>
                        </div>
                    </div>

                    {/* Filtros: ocultar zerados + ordenação */}
                    <div style={{
                        display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                        padding: '8px 0', marginBottom: '16px', flexWrap: 'wrap', gap: '12px'
                    }}>
                        <label style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '13px', color: '#555', cursor: 'pointer' }}>
                            <input
                                type="checkbox"
                                checked={hideZeroStock}
                                onChange={e => setHideZeroStock(e.target.checked)}
                            />
                            Ocultar produtos zerados
                        </label>

                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span style={{ fontSize: '13px', color: '#555' }}>Ordenar por:</span>
                            <select
                                value={sortBy}
                                onChange={e => setSortBy(e.target.value)}
                                className="form-select"
                                style={{ fontSize: '13px', padding: '4px 8px', minWidth: 'auto', width: 'auto' }}
                            >
                                <option value="name">Nome</option>
                                <option value="date">Mais recentes</option>
                                <option value="price">Preco</option>
                                <option value="quantity">Quantidade</option>
                            </select>
                            <button
                                onClick={() => setSortOrder(prev => prev === 'asc' ? 'desc' : 'asc')}
                                className="btn btn-secondary"
                                style={{ padding: '4px 10px', fontSize: '13px', minWidth: 'auto' }}
                                title={sortOrder === 'asc' ? 'Crescente' : 'Decrescente'}
                            >
                                {sortOrder === 'asc' ? '\u2191' : '\u2193'}
                            </button>
                        </div>
                    </div>

                    {/* Seções agrupadas por categoria */}
                    {totalFiltered === 0 ? (
                        <div className="empty-state">
                            <div className="empty-state-icon"><Icon name="boxOpen" size={48} /></div>
                            <h3>Nenhum produto encontrado</h3>
                            <p>Tente ajustar os filtros ou a busca</p>
                        </div>
                    ) : (
                        Object.entries(groupedProducts).map(([catName, prods]) => {
                            if (prods.length === 0) return null;
                            const catData = categories.find(c => c.name === catName);
                            const isExpanded = expandedCategories[catName] !== false;

                            return (
                                <div key={catName} style={{ marginBottom: '16px' }}>
                                    {/* Header da seção */}
                                    <div
                                        onClick={() => toggleCategory(catName)}
                                        style={{
                                            display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                                            padding: '12px 16px', background: '#f8f8f8', borderRadius: '8px',
                                            cursor: 'pointer', userSelect: 'none',
                                            marginBottom: isExpanded ? '12px' : '0',
                                            border: '1px solid #eee'
                                        }}
                                    >
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <span style={{
                                                fontSize: '14px', transition: 'transform 0.2s',
                                                transform: isExpanded ? 'rotate(90deg)' : 'rotate(0deg)',
                                                display: 'inline-block'
                                            }}>{'\u25B6'}</span>
                                            {catData ? (
                                                <span style={{ display: 'inline-flex', alignItems: 'center', gap: '6px' }}>
                                                    <span style={{
                                                        background: catData.color || '#666', color: 'white',
                                                        width: '24px', height: '24px', borderRadius: '50%',
                                                        display: 'inline-flex', alignItems: 'center', justifyContent: 'center',
                                                        fontSize: '12px'
                                                    }}>
                                                        <CategoryIcon icon={catData.icon} size={12} />
                                                    </span>
                                                    <span style={{ fontWeight: 600, fontSize: '14px', color: '#333' }}>
                                                        {catName}
                                                    </span>
                                                </span>
                                            ) : (
                                                <span style={{ fontWeight: 600, fontSize: '14px', color: '#666' }}>{catName}</span>
                                            )}
                                            <span style={{ color: '#888', fontSize: '13px' }}>({prods.length})</span>
                                        </div>
                                    </div>

                                    {/* Grid de cards — só renderiza se expandido */}
                                    {isExpanded && (
                                        <div className="products-grid">
                                            {prods.map(p => (
                                                <div key={p.id} className={`product-card ${p.status}`}>
                                                    <div className="product-actions">
                                                        <button className="btn btn-icon btn-secondary" onClick={() => setHistoryProduct(p)} title="Ver Histórico"><Icon name="clipboard" size={14} /></button>
                                                        <button className="btn btn-icon btn-secondary" onClick={() => openEditModal(p)} title="Editar"><Icon name="edit" size={14} /></button>
                                                        <button className="btn btn-icon btn-secondary" onClick={() => handleDelete(p)} title="Excluir"><Icon name="delete" size={14} /></button>
                                                    </div>

                                                    <span className="product-category-badge" style={{color: getCategoryColor(p.category), background: getCategoryColor(p.category) + '10', border: '1px solid ' + getCategoryColor(p.category) + '20'}}>
                                                        {getCategoryName(p.category)}
                                                    </span>

                                                    <div className="product-name">{p.name}</div>
                                                    <div className="product-sku">SKU: {p.sku}</div>
                                                    {p.ean && <div className="product-sku">EAN: {p.ean}</div>}
                                                    <div className="product-price">{p.unitPrice > 0 ? `R$ ${formatBRL(p.unitPrice)}` : 'Preco: nao sincronizado'}</div>

                                                    {p.local && p.local.trim() !== '' && (
                                                        <div style={{ fontSize: '12px', color: '#666', marginTop: '4px' }}>
                                                            {'\uD83D\uDCCD'} {p.local}
                                                        </div>
                                                    )}

                                                    {p.observations && p.observations.trim() !== '' && (
                                                        <div style={{ fontSize: '12px', color: '#888', marginTop: '4px', fontStyle: 'italic' }}>
                                                            {'\uD83D\uDCAC'} {p.observations.length > 80 ? p.observations.substring(0, 80) + '...' : p.observations}
                                                        </div>
                                                    )}

                                                    <div className="product-quantity">{p.currentQuantity}</div>
                                                    {p.unitPrice > 0 && <div className="product-value">Valor: R$ {formatBRL(p.unitPrice * p.currentQuantity)}</div>}
                                                    <span className={`product-status status-${p.status}`}>
                                                        {p.status === 'ok' ? 'OK' : p.status === 'low' ? 'BAIXO' : 'ZERADO'}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            );
                        })
                    )}
                </div>
            );
        }

        // ==========================================
        // PRODUCT FORM
        // ==========================================
        function ProductForm({ onSubmit, products, categories }) {
            const [form, setForm] = useState({
                name: '', sku: '', ean: '', category: '', minStock: '3', observations: '', nfOrigem: ''
            });
            const [success, setSuccess] = useState(false);
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');

                // Verificar SKU duplicado
                const skuExists = products.some(p => p.sku.toLowerCase().trim() === form.sku.toLowerCase().trim());
                if (skuExists) {
                    setError('Já existe um produto com este SKU');
                    return;
                }

                try {
                    await onSubmit({
                        name: form.name.trim(),
                        sku: form.sku.trim(),
                        ean: form.ean.trim(),
                        category: form.category,
                        minStock: parseInt(form.minStock) || 3,
                        observations: form.observations.trim(),
                        nfOrigem: form.nfOrigem.trim(),
                        quantity: 0,
                        createdAt: new Date().toISOString()
                    });

                    setSuccess(true);
                    setForm({ name: '', sku: '', ean: '', category: '', minStock: '3', observations: '', nfOrigem: '' });
                    setTimeout(() => setSuccess(false), 3000);
                } catch (err) {
                    setError('Erro ao cadastrar produto: ' + err.message);
                }
            };

            return (
                <div>
                    <div className="page-header">
                        <h1 className="page-title">Cadastrar</h1>
                        <p className="page-subtitle">Adicione novos produtos ao estoque</p>
                    </div>

                    {success && <div className="alert alert-success">Produto cadastrado com sucesso!</div>}
                    {error && <div className="alert alert-danger">{error}</div>}

                    <div className="card">
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Nome do Produto *</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={form.name}
                                    onChange={(e) => setForm({...form, name: e.target.value})}
                                    placeholder="Ex: Luminária de Mesa LED Moderna"
                                    required
                                />
                            </div>

                            <div className="form-row">
                                <div className="form-group">
                                    <label className="form-label">SKU / Código *</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={form.sku}
                                        onChange={(e) => setForm({...form, sku: e.target.value})}
                                        placeholder="Ex: LUM-001-LED"
                                        required
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">EAN / Código de Barras</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={form.ean}
                                        onChange={(e) => setForm({...form, ean: e.target.value})}
                                        placeholder="Opcional"
                                    />
                                </div>
                            </div>

                            <div className="form-row">
                                <div className="form-group">
                                    <label className="form-label">Categoria *</label>
                                    <select
                                        className="form-select"
                                        value={form.category}
                                        onChange={(e) => setForm({...form, category: e.target.value})}
                                        required
                                    >
                                        <option value="">Selecione...</option>
                                        {categories.map(cat => (
                                            <option key={cat.id} value={cat.id}>{cat.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Estoque Mínimo</label>
                                    <input
                                        type="number"
                                        className="form-input"
                                        value={form.minStock}
                                        onChange={(e) => setForm({...form, minStock: e.target.value})}
                                        min="0"
                                    />
                                    <span className="form-help">Alerta quando estoque ficar abaixo</span>
                                </div>
                            </div>

                            <div className="form-group">
                                <label className="form-label">Nota Fiscal de Origem</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={form.nfOrigem}
                                    onChange={(e) => setForm({...form, nfOrigem: e.target.value})}
                                    placeholder="Ex: NF 12345 ou 000.123.456"
                                />
                                <span className="form-help">Número da NF para localizar o produto no estoque físico</span>
                            </div>

                            <div className="form-group">
                                <label className="form-label">Observações</label>
                                <textarea
                                    className="form-textarea"
                                    value={form.observations}
                                    onChange={(e) => setForm({...form, observations: e.target.value})}
                                    placeholder="Informações adicionais, particularidades do produto..."
                                />
                            </div>

                            <div className="btn-group">
                                <button type="submit" className="btn btn-primary">Cadastrar Produto</button>
                            </div>
                        </form>
                    </div>

                    {/* Lista de últimos produtos */}
                    <div className="card">
                        <h2 className="card-title">
                            <Icon name="clipboard" size={16} className="card-title-icon" />
                            Últimos Produtos Cadastrados
                        </h2>
                        {products.length === 0 ? (
                            <div className="empty-state">
                                <p>Nenhum produto cadastrado ainda</p>
                            </div>
                        ) : (
                            <div className="table-container">
                                <table className="table">
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>SKU</th>
                                            <th>Categoria</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {products.slice(-5).reverse().map(p => (
                                            <tr key={p.id}>
                                                <td>{p.name?.substring(0, 40)}...</td>
                                                <td style={{fontFamily: 'monospace', fontSize: '11px'}}>{p.sku}</td>
                                                <td>{categories.find(c => c.id === p.category)?.name || '-'}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ==========================================
        // CATEGORY MANAGER
        // ==========================================
        function CategoryManager({ categories, onAdd, onUpdate, onDelete, products }) {
            const [newName, setNewName] = useState('');
            const [newIcon, setNewIcon] = useState('catSquare');
            const [newColor, setNewColor] = useState('#7A7585');
            const [newObs, setNewObs] = useState('');
            const [editingCat, setEditingCat] = useState(null);
            const [editForm, setEditForm] = useState({});
            const [success, setSuccess] = useState('');
            const colors = ['#E8723A', '#A52428', '#7B6EED', '#F4A261', '#D4612E', '#2ECC87', '#F0B429', '#7A7585', '#5B9BD5', '#2EC4B6'];

            const handleAdd = async (e) => {
                e.preventDefault();
                if (!newName.trim()) return;

                const id = newName.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]/g, '-');
                
                await onAdd({
                    id,
                    name: newName.trim(),
                    icon: newIcon,
                    color: newColor,
                    observations: newObs
                });

                setNewName('');
                setNewIcon('catSquare');
                setNewColor('#6b7280');
                setNewObs('');
                setSuccess('Categoria criada!');
                setTimeout(() => setSuccess(''), 3000);
            };

            const openEditModal = (cat) => {
                setEditForm({
                    name: cat.name,
                    icon: resolveCatIcon(cat.icon),
                    color: cat.color,
                    observations: cat.observations || ''
                });
                setEditingCat(cat);
            };

            const handleSaveEdit = async () => {
                await onUpdate(editingCat.id, editForm);
                setEditingCat(null);
                setSuccess('Categoria atualizada!');
                setTimeout(() => setSuccess(''), 3000);
            };

            const handleDelete = (cat) => {
                const count = products.filter(p => p.category === cat.id).length;
                if (count > 0) {
                    alert(`Não é possível excluir. Existem ${count} produto(s) nesta categoria.`);
                    return;
                }
                if (window.confirm(`Excluir categoria "${cat.name}"?`)) {
                    onDelete(cat.id);
                }
            };

            const getCategoryStats = (catId) => {
                const catProducts = products.filter(p => p.category === catId);
                return {
                    count: catProducts.length,
                    totalStock: catProducts.reduce((sum, p) => sum + (p.currentQuantity || 0), 0)
                };
            };

            return (
                <div>
                    <div className="page-header">
                        <h1 className="page-title">Categorias</h1>
                        <p className="page-subtitle">Organize seus produtos por categorias</p>
                    </div>

                    {success && <div className="alert alert-success">{success}</div>}

                    {/* Modal de Edição */}
                    {editingCat && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h2 className="modal-title">Editar Categoria</h2>
                                <p className="modal-subtitle">Atualize as informações da categoria</p>

                                <div className="form-group">
                                    <label className="form-label">Nome</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={editForm.name}
                                        onChange={(e) => setEditForm({...editForm, name: e.target.value})}
                                    />
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">Ícone</label>
                                        <select
                                            className="form-select"
                                            value={editForm.icon}
                                            onChange={(e) => setEditForm({...editForm, icon: e.target.value})}
                                        >
                                            {CATEGORY_ICON_OPTIONS.map(opt => (
                                                <option key={opt.id} value={opt.id}>{opt.label}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Cor</label>
                                        <div className="color-picker">
                                            {colors.map(color => (
                                                <div
                                                    key={color}
                                                    className={`color-option ${editForm.color === color ? 'selected' : ''}`}
                                                    style={{background: color}}
                                                    onClick={() => setEditForm({...editForm, color})}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Observações</label>
                                    <textarea
                                        className="form-textarea"
                                        value={editForm.observations}
                                        onChange={(e) => setEditForm({...editForm, observations: e.target.value})}
                                        placeholder="Informações sobre esta categoria..."
                                    />
                                </div>

                                <div className="btn-group">
                                    <button className="btn btn-primary" onClick={handleSaveEdit}>Salvar</button>
                                    <button className="btn btn-secondary" onClick={() => setEditingCat(null)}>Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Formulário Nova Categoria */}
                    <div className="card">
                        <h2 className="card-title">
                            <Icon name="add" size={16} className="card-title-icon" />
                            Nova Categoria
                        </h2>
                        <form onSubmit={handleAdd}>
                            <div style={{display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', gap: '16px', alignItems: 'end'}}>
                                <div className="form-group" style={{marginBottom: 0}}>
                                    <label className="form-label">Nome</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={newName}
                                        onChange={(e) => setNewName(e.target.value)}
                                        placeholder="Ex: Arandelas"
                                        required
                                    />
                                </div>
                                <div className="form-group" style={{marginBottom: 0}}>
                                    <label className="form-label">Ícone</label>
                                    <select className="form-select" value={newIcon} onChange={(e) => setNewIcon(e.target.value)}>
                                        {CATEGORY_ICON_OPTIONS.map(opt => <option key={opt.id} value={opt.id}>{opt.label}</option>)}
                                    </select>
                                </div>
                                <button type="submit" className="btn btn-primary">Criar</button>
                            </div>
                            <div style={{marginTop: '12px'}}>
                                <label className="form-label">Cor</label>
                                <div className="color-picker">
                                    {colors.map(color => (
                                        <div
                                            key={color}
                                            className={`color-option ${newColor === color ? 'selected' : ''}`}
                                            style={{background: color}}
                                            onClick={() => setNewColor(color)}
                                        />
                                    ))}
                                </div>
                            </div>
                        </form>
                    </div>

                    {/* Lista de Categorias */}
                    <div className="card">
                        <h2 className="card-title">
                            <Icon name="file" size={16} className="card-title-icon" />
                            Categorias Cadastradas ({categories.length})
                        </h2>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(220px, 1fr))', gap: '12px'}}>
                            {categories.map(cat => {
                                const stats = getCategoryStats(cat.id);
                                return (
                                    <div
                                        key={cat.id}
                                        className="category-card-item"
                                        style={{
                                            background: 'var(--bg-secondary)',
                                            border: '1px solid var(--border-default)',
                                            borderRadius: 'var(--radius-lg)',
                                            padding: '16px'
                                        }}
                                    >
                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start'}}>
                                            <div>
                                                <div style={{marginBottom: '6px'}}><CategoryIcon icon={cat.icon} size={24} color={cat.color} /></div>
                                                <div style={{fontWeight: '600', marginBottom: '4px'}}>{cat.name}</div>
                                                <div style={{fontSize: '11px', color: 'var(--text-muted)'}}>
                                                    {stats.count} produto{stats.count !== 1 ? 's' : ''} • {stats.totalStock} un.
                                                </div>
                                                {cat.observations && (
                                                    <div style={{fontSize: '11px', color: 'var(--text-secondary)', marginTop: '6px', fontStyle: 'italic'}}>
                                                        {cat.observations}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="category-card-actions" style={{display: 'flex', gap: '4px'}}>
                                                <button className="btn btn-icon btn-secondary btn-sm" onClick={() => openEditModal(cat)}><Icon name="edit" size={14} /></button>
                                                <button className="btn btn-icon btn-secondary btn-sm" onClick={() => handleDelete(cat)}><Icon name="delete" size={14} /></button>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        // ==========================================
        // CATEGORY SELECT INLINE (dropdown + criar nova + gerenciar)
        // ==========================================
        function CategorySelectInline({ categories, value, onChange, onAddCategory, onUpdateCategory, onDeleteCategory, products: catProducts }) {
            const [showNewForm, setShowNewForm] = useState(false);
            const [showManager, setShowManager] = useState(false);
            const [newName, setNewName] = useState('');
            const [newColor, setNewColor] = useState('#7A7585');
            const [saving, setSaving] = useState(false);

            const handleCreateCategory = async () => {
                if (!newName.trim()) return;
                setSaving(true);
                try {
                    const id = newName.trim().toLowerCase().replace(/[^a-z0-9]+/g, '_');
                    const newCat = await onAddCategory({ id, name: newName.trim(), icon: 'catSquare', color: newColor });
                    if (newCat) onChange(newCat.id || id);
                    setNewName('');
                    setShowNewForm(false);
                } finally { setSaving(false); }
            };

            return (
                <div className="form-group">
                    <label className="form-label">Categoria *</label>
                    <div style={{display: 'flex', gap: '6px', alignItems: 'center'}}>
                        <select className="form-select" value={value} onChange={(e) => onChange(e.target.value)} style={{flex: 1}}>
                            <option value="">Selecione...</option>
                            {(categories || []).map(cat => (
                                <option key={cat.id} value={cat.id}>{cat.name}</option>
                            ))}
                        </select>
                        <button type="button" className="btn btn-secondary" onClick={() => setShowNewForm(!showNewForm)} title="Criar categoria" style={{padding: '8px 10px', minWidth: 'auto'}}>+</button>
                    </div>

                    {showNewForm && (
                        <div style={{marginTop: '8px', padding: '12px', border: '1px solid var(--border)', borderRadius: 'var(--radius)', background: 'var(--bg-secondary)'}}>
                            <div style={{display: 'flex', gap: '8px', alignItems: 'flex-end', flexWrap: 'wrap'}}>
                                <div style={{flex: 1, minWidth: '150px'}}>
                                    <label className="form-label" style={{fontSize: '11px', marginBottom: '4px'}}>Nome</label>
                                    <input className="form-input" value={newName} onChange={e => setNewName(e.target.value)} placeholder="Nova categoria" style={{fontSize: '13px'}} />
                                </div>
                                <div style={{width: '60px'}}>
                                    <label className="form-label" style={{fontSize: '11px', marginBottom: '4px'}}>Cor</label>
                                    <input type="color" value={newColor} onChange={e => setNewColor(e.target.value)} style={{width: '100%', height: '36px', border: '1px solid var(--border)', borderRadius: 'var(--radius)', cursor: 'pointer'}} />
                                </div>
                                <button type="button" className="btn btn-primary" onClick={handleCreateCategory} disabled={saving || !newName.trim()} style={{fontSize: '12px', padding: '8px 12px'}}>
                                    {saving ? '...' : 'Salvar'}
                                </button>
                                <button type="button" className="btn btn-secondary" onClick={() => { setShowNewForm(false); setNewName(''); }} style={{fontSize: '12px', padding: '8px 12px'}}>
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    )}

                    <button type="button" onClick={() => setShowManager(true)} style={{background: 'none', border: 'none', color: 'var(--accent-primary)', fontSize: '11px', cursor: 'pointer', padding: '4px 0', marginTop: '4px'}}>
                        Gerenciar categorias
                    </button>

                    {showManager && (
                        <div className="modal-overlay" onClick={() => setShowManager(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()} style={{maxWidth: '600px', maxHeight: '80vh', overflow: 'auto'}}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                                    <h3 style={{margin: 0}}>Gerenciar Categorias</h3>
                                    <button className="btn btn-icon btn-secondary" onClick={() => setShowManager(false)}>
                                        <Icon name="close" size={16} />
                                    </button>
                                </div>
                                <CategoryManager categories={categories} onAdd={onAddCategory} onUpdate={onUpdateCategory} onDelete={onDeleteCategory} products={catProducts || []} />
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ==========================================
        // CSV IMPORT TAB (Reusable for Entry, Exit, Shipping)
        // ==========================================
        function CSVImportTab({ type, products, onImport, onImportShipping, locaisOrigem, onUpdateLocais, onAddProduct, categories, onAddCategory, onUpdateCategory, onDeleteCategory }) {
            const [csvData, setCsvData] = useState(null);
            const [csvFile, setCsvFile] = useState(null);
            const [localEntrada, setLocalEntrada] = useState(locaisOrigem?.[0] || 'Loja Principal');
            const [showLocaisModal, setShowLocaisModal] = useState(false);
            const [importing, setImporting] = useState(false);
            const [importResult, setImportResult] = useState(null);
            const [showNewProductModal, setShowNewProductModal] = useState(null); // SKU string
            const [newProductData, setNewProductData] = useState({ name: '', sku: '', ean: '', category: '' });

            const isEntry = type === 'entry';
            const isExit = type === 'exit';
            const isShipping = type === 'shipping';

            const columnInfo = isEntry
                ? { required: 'sku, quantidade', optional: 'fornecedor, nf, local' }
                : isExit
                ? { required: 'sku, quantidade', optional: 'cliente, nf, nf_origem, local' }
                : { required: 'nf_numero', optional: 'cliente, destino, local_origem, transportadora, codigo_rastreio, link_rastreio, observacoes' };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setCsvFile(file.name);
                setImportResult(null);

                if (file.name.endsWith('.csv')) {
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => setCsvData(results.data.filter(r => isShipping ? r.nf_numero : r.sku))
                    });
                } else {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const wb = XLSX.read(event.target.result, {type: 'binary'});
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(ws);
                        setCsvData(json.filter(r => isShipping ? r.nf_numero : r.sku));
                    };
                    reader.readAsBinaryString(file);
                }
            };

            const handleImport = async () => {
                if (!csvData || csvData.length === 0) return;
                setImporting(true);
                let imported = 0, skipped = 0;

                try {
                    if (isEntry) {
                        for (let row of csvData) {
                            if (!row.sku || !row.quantidade) { skipped++; continue; }
                            if (!products.find(p => p.sku === row.sku)) { skipped++; continue; }
                            await onImport({
                                type: 'COMPRA',
                                sku: row.sku,
                                quantity: parseInt(row.quantidade),
                                supplier: row.fornecedor || '',
                                nf: row.nf || '',
                                localEntrada: row.local || localEntrada
                            });
                            imported++;
                        }
                    } else if (isExit) {
                        for (let row of csvData) {
                            if (!row.sku || !row.quantidade) { skipped++; continue; }
                            if (!products.find(p => p.sku === row.sku)) { skipped++; continue; }
                            await onImport({
                                type: 'VENDA',
                                sku: row.sku,
                                quantity: parseInt(row.quantidade),
                                client: row.cliente || '',
                                nf: row.nf || '',
                                nfOrigem: row.nf_origem || null
                            });
                            imported++;
                        }
                    } else if (isShipping) {
                        for (let row of csvData) {
                            if (!row.nf_numero) { skipped++; continue; }
                            await onImportShipping({
                                nfNumero: row.nf_numero,
                                cliente: row.cliente || '',
                                destino: row.destino || '',
                                localOrigem: row.local_origem || localEntrada,
                                transportadora: row.transportadora || '',
                                codigoRastreio: row.codigo_rastreio || '',
                                linkRastreio: row.link_rastreio || '',
                                produtos: [],
                                status: 'preparando',
                                observacoes: row.observacoes || ''
                            });
                            imported++;
                        }
                    }

                    setImportResult({ imported, skipped });
                    if (imported > 0) setCsvData(null);
                } catch (err) {
                    setImportResult({ error: err.message });
                } finally {
                    setImporting(false);
                }
            };

            const previewColumns = csvData && csvData.length > 0 ? Object.keys(csvData[0]) : [];

            // Count missing products in CSV
            const missingSKUs = !isShipping && csvData ? csvData.filter(r => r.sku && !products.find(p => p.sku === r.sku)).map(r => r.sku) : [];
            const uniqueMissingSKUs = [...new Set(missingSKUs)];

            const handleCreateProduct = async () => {
                if (!newProductData.name || !newProductData.sku || !newProductData.category) return;
                await onAddProduct({
                    name: newProductData.name,
                    sku: newProductData.sku,
                    ean: newProductData.ean || '',
                    category: newProductData.category,
                    minStock: 3
                });
                setShowNewProductModal(null);
                setNewProductData({ name: '', sku: '', ean: '', category: '' });
            };

            return (
                <div className="card">
                    <h2 className="card-title" style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <Icon name="import" size={16} />
                        Importar {isEntry ? 'Entradas' : isExit ? 'Saídas' : 'Despachos'} via CSV
                    </h2>

                    <div style={{background: 'var(--bg-primary)', padding: '12px', borderRadius: 'var(--radius)', marginBottom: '16px', fontSize: '12px'}}>
                        <strong>Colunas obrigatórias:</strong> {columnInfo.required}<br/>
                        <strong>Colunas opcionais:</strong> {columnInfo.optional}
                    </div>

                    {(isEntry || isShipping) && (
                        <div className="form-group">
                            <label className="form-label">Local {isEntry ? 'de Entrada' : 'de Origem'} Padrão</label>
                            <div style={{display: 'flex', gap: '8px'}}>
                                <select className="form-select" value={localEntrada} onChange={(e) => setLocalEntrada(e.target.value)} style={{flex: 1}}>
                                    {(locaisOrigem || ['Loja Principal']).map((local, idx) => (
                                        <option key={idx} value={local}>{local}</option>
                                    ))}
                                </select>
                                <button type="button" className="btn btn-secondary" onClick={() => setShowLocaisModal(true)} title="Gerenciar locais" style={{padding: '8px 12px'}}>
                                    <Icon name="settings" size={14} />
                                </button>
                            </div>
                            <span className="form-help">Usado quando a planilha não tiver coluna "{isEntry ? 'local' : 'local_origem'}"</span>
                        </div>
                    )}

                    {showLocaisModal && (
                        <LocaisModal locaisOrigem={locaisOrigem} onUpdateLocais={onUpdateLocais} onClose={() => setShowLocaisModal(false)} />
                    )}

                    <div className="form-group">
                        <label className="form-label">Arquivo Excel ou CSV</label>
                        <input type="file" className="form-input" accept=".xlsx,.xls,.csv" onChange={handleFileUpload} />
                    </div>

                    {importResult && (
                        <div className={`alert ${importResult.error ? 'alert-danger' : 'alert-success'}`} style={{marginBottom: '16px'}}>
                            {importResult.error
                                ? `Erro na importação: ${importResult.error}`
                                : `Importação concluída! ${importResult.imported} registro(s) importado(s)${importResult.skipped > 0 ? `, ${importResult.skipped} pulado(s)` : ''}.`
                            }
                        </div>
                    )}

                    {csvData && csvData.length > 0 && (
                        <div>
                            <div style={{marginBottom: '12px', fontSize: '13px', fontWeight: '500'}}>
                                {csvData.length} linha(s) encontrada(s) {csvFile && <span style={{color: 'var(--text-muted)'}}>— {csvFile}</span>}
                            </div>

                            {!isShipping && uniqueMissingSKUs.length > 0 && (
                                <div className="alert alert-warning" style={{marginBottom: '16px'}}>
                                    <strong>{uniqueMissingSKUs.length} SKU(s) não encontrado(s) no sistema</strong> — serão pulados na importação.
                                    <div style={{marginTop: '8px', display: 'flex', flexWrap: 'wrap', gap: '4px'}}>
                                        {uniqueMissingSKUs.slice(0, 10).map(sku => (
                                            <span key={sku} style={{display: 'inline-flex', alignItems: 'center', gap: '4px', background: 'var(--bg-primary)', padding: '2px 8px', borderRadius: '4px', fontSize: '11px'}}>
                                                {sku}
                                                {onAddProduct && (
                                                    <button type="button" onClick={() => { setNewProductData({ name: '', sku, ean: '', category: '' }); setShowNewProductModal(sku); }} style={{background: 'none', border: 'none', color: 'var(--accent-primary)', cursor: 'pointer', fontSize: '11px', padding: '0 2px', fontWeight: '600'}}>
                                                        + cadastrar
                                                    </button>
                                                )}
                                            </span>
                                        ))}
                                        {uniqueMissingSKUs.length > 10 && <span style={{fontSize: '11px', color: 'var(--text-muted)'}}>... e mais {uniqueMissingSKUs.length - 10}</span>}
                                    </div>
                                </div>
                            )}

                            <div className="table-container" style={{border: '1px solid var(--border)', borderRadius: 'var(--radius)', overflow: 'hidden', marginBottom: '16px', maxHeight: '300px', overflowY: 'auto'}}>
                                <table className="table" style={{fontSize: '12px'}}>
                                    <thead>
                                        <tr>
                                            {!isShipping && <th>Status</th>}
                                            {previewColumns.map(col => <th key={col}>{col}</th>)}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {csvData.slice(0, 10).map((row, i) => {
                                            const found = isShipping || products.find(p => p.sku === row.sku);
                                            return (
                                                <tr key={i} style={!found ? {background: 'var(--danger-bg, #fff5f5)'} : undefined}>
                                                    {!isShipping && (
                                                        <td>
                                                            {found
                                                                ? <span className="badge badge-success" style={{fontSize: '10px'}}>OK</span>
                                                                : <span className="badge badge-danger" style={{fontSize: '10px'}}>Não encontrado</span>
                                                            }
                                                        </td>
                                                    )}
                                                    {previewColumns.map(col => (
                                                        <td key={col} style={{maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>{row[col] || ''}</td>
                                                    ))}
                                                </tr>
                                            );
                                        })}
                                        {csvData.length > 10 && (
                                            <tr><td colSpan={previewColumns.length + (isShipping ? 0 : 1)} style={{textAlign: 'center', color: 'var(--text-muted)', fontStyle: 'italic'}}>... e mais {csvData.length - 10} linha(s)</td></tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>

                            <div className="btn-group">
                                <button className="btn btn-primary" onClick={handleImport} disabled={importing}>
                                    {importing ? 'Importando...' : `Importar ${csvData.length - missingSKUs.length} registro(s)`}
                                </button>
                                <button className="btn btn-secondary" onClick={() => { setCsvData(null); setCsvFile(null); setImportResult(null); }}>
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Modal Cadastrar Produto */}
                    {showNewProductModal && onAddProduct && (
                        <div className="modal-overlay" onClick={() => setShowNewProductModal(null)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()} style={{maxWidth: '500px'}}>
                                <h3 style={{margin: '0 0 16px'}}>Cadastrar Produto</h3>
                                <div className="form-group">
                                    <label className="form-label">Nome *</label>
                                    <input className="form-input" value={newProductData.name} onChange={e => setNewProductData({...newProductData, name: e.target.value})} />
                                </div>
                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">SKU *</label>
                                        <input className="form-input" value={newProductData.sku} onChange={e => setNewProductData({...newProductData, sku: e.target.value})} />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">EAN</label>
                                        <input className="form-input" value={newProductData.ean} onChange={e => setNewProductData({...newProductData, ean: e.target.value})} />
                                    </div>
                                </div>
                                {onAddCategory ? (
                                    <CategorySelectInline
                                        categories={categories}
                                        value={newProductData.category}
                                        onChange={(val) => setNewProductData({...newProductData, category: val})}
                                        onAddCategory={onAddCategory}
                                        onUpdateCategory={onUpdateCategory}
                                        onDeleteCategory={onDeleteCategory}
                                        products={products}
                                    />
                                ) : (
                                    <div className="form-group">
                                        <label className="form-label">Categoria *</label>
                                        <select className="form-select" value={newProductData.category} onChange={e => setNewProductData({...newProductData, category: e.target.value})}>
                                            <option value="">Selecione...</option>
                                            {(categories || []).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                        </select>
                                    </div>
                                )}
                                <div className="btn-group" style={{marginTop: '16px'}}>
                                    <button className="btn btn-primary" onClick={handleCreateProduct} disabled={!newProductData.name || !newProductData.sku || !newProductData.category}>Cadastrar</button>
                                    <button className="btn btn-secondary" onClick={() => setShowNewProductModal(null)}>Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ==========================================
        // ENTRY FORM
        // ==========================================
        function EntryForm({ products, onSubmit, onAddProduct, categories, locaisOrigem, onUpdateLocais, entries, exits, stock, onAddCategory, onUpdateCategory, onDeleteCategory }) {
            const [entryMode, setEntryMode] = useState('manual'); // 'manual', 'tiny', or 'csv'
            const [type, setType] = useState('COMPRA');
            const [sku, setSku] = useState('');
            const [quantity, setQuantity] = useState('');
            const [supplier, setSupplier] = useState('');
            const [nf, setNf] = useState('');
            const [localEntrada, setLocalEntrada] = useState(locaisOrigem?.[0] || 'Loja Principal');
            const [category, setCategory] = useState('');
            const [success, setSuccess] = useState(false);
            const [showNewProductModal, setShowNewProductModal] = useState(false);
            const [newProductData, setNewProductData] = useState({ name: '', sku: '', ean: '', category: '', observations: '', nfOrigem: '' });
            const [productSearch, setProductSearch] = useState('');
            const [showLocaisModal, setShowLocaisModal] = useState(false);

            // Filtrar produtos pela busca
            const filteredProducts = [...products]
                .filter(p => {
                    if (!productSearch) return true;
                    const search = productSearch.toLowerCase();
                    return (p.name || '').toLowerCase().includes(search) || 
                           (p.sku || '').toLowerCase().includes(search);
                })
                .sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit({ type, sku, quantity: parseInt(quantity), supplier, nf, localEntrada, category });
                setSuccess(true);
                setSku('');
                setQuantity('');
                setSupplier('');
                setNf('');
                setCategory('');
                setProductSearch('');
                setTimeout(() => setSuccess(false), 3000);
            };

            const handleProductChange = (value) => {
                if (value === '__NEW__') {
                    // Preenche automaticamente a NF de origem com a NF da entrada
                    setNewProductData({...newProductData, nfOrigem: nf});
                    setShowNewProductModal(true);
                } else {
                    setSku(value);
                    setProductSearch('');
                    // Preencher categoria do produto selecionado
                    const selectedProduct = products.find(p => p.sku === value);
                    if (selectedProduct?.category) {
                        setCategory(selectedProduct.category);
                    }
                }
            };

            const handleCreateProduct = async () => {
                if (!newProductData.name || !newProductData.sku || !newProductData.category) return;
                
                await onAddProduct({
                    name: newProductData.name.trim(),
                    sku: newProductData.sku.trim(),
                    ean: newProductData.ean?.trim() || '',
                    category: newProductData.category,
                    observations: newProductData.observations?.trim() || '',
                    nfOrigem: newProductData.nfOrigem?.trim() || nf || '',
                    quantity: 0,
                    createdAt: new Date().toISOString()
                });

                setSku(newProductData.sku.trim());
                setShowNewProductModal(false);
                setNewProductData({ name: '', sku: '', ean: '', category: '', observations: '', nfOrigem: '' });
            };

            return (
                <div>
                    <div className="page-header">
                        <h1 className="page-title">Entrada</h1>
                        <p className="page-subtitle">Registre entradas de produtos no estoque</p>
                    </div>

                    <div className="card" style={{marginBottom: '16px'}}>
                        <div className="filter-tabs">
                            <button className={`filter-tab ${entryMode === 'manual' ? 'active' : ''}`} onClick={() => setEntryMode('manual')}>
                                Entrada Manual
                            </button>
                            <button className={`filter-tab ${entryMode === 'tiny' ? 'active' : ''}`} onClick={() => setEntryMode('tiny')}>
                                Importar do Tiny
                            </button>
                            <button className={`filter-tab ${entryMode === 'csv' ? 'active' : ''}`} onClick={() => setEntryMode('csv')}>
                                Importar CSV
                            </button>
                        </div>
                    </div>

                    {entryMode === 'tiny' && (
                        <TinyNFeImport
                            products={products}
                            onSubmitEntry={onSubmit}
                            onSubmitExit={() => {}}
                            onAddProduct={onAddProduct}
                            categories={categories}
                            locaisOrigem={locaisOrigem}
                            onUpdateLocais={onUpdateLocais}
                            entries={entries || []}
                            exits={exits || []}
                            stock={stock || []}
                            mode="entry"
                            onAddCategory={onAddCategory}
                            onUpdateCategory={onUpdateCategory}
                            onDeleteCategory={onDeleteCategory}
                        />
                    )}

                    {entryMode === 'csv' && (
                        <CSVImportTab
                            type="entry"
                            products={products}
                            onImport={onSubmit}
                            locaisOrigem={locaisOrigem}
                            onUpdateLocais={onUpdateLocais}
                            onAddProduct={onAddProduct}
                            categories={categories}
                            onAddCategory={onAddCategory}
                            onUpdateCategory={onUpdateCategory}
                            onDeleteCategory={onDeleteCategory}
                        />
                    )}

                    {entryMode === 'manual' && (<React.Fragment>
                    {success && <div className="alert alert-success">Entrada registrada!</div>}

                    {/* Modal Novo Produto */}
                    {showNewProductModal && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h2 className="modal-title">Cadastrar Novo Produto</h2>
                                <p className="modal-subtitle">Preencha os dados do produto</p>

                                <div className="form-group">
                                    <label className="form-label">Nome do Produto *</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={newProductData.name}
                                        onChange={(e) => setNewProductData({...newProductData, name: e.target.value})}
                                        placeholder="Ex: Luminária LED Moderna"
                                    />
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">SKU *</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            value={newProductData.sku}
                                            onChange={(e) => setNewProductData({...newProductData, sku: e.target.value})}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">EAN</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            value={newProductData.ean}
                                            onChange={(e) => setNewProductData({...newProductData, ean: e.target.value})}
                                        />
                                    </div>
                                </div>

                                <CategorySelectInline
                                    categories={categories}
                                    value={newProductData.category}
                                    onChange={(val) => setNewProductData({...newProductData, category: val})}
                                    onAddCategory={onAddCategory}
                                    onUpdateCategory={onUpdateCategory}
                                    onDeleteCategory={onDeleteCategory}
                                    products={stock}
                                />

                                <div className="form-group">
                                    <label className="form-label">NF de Origem</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={newProductData.nfOrigem}
                                        onChange={(e) => setNewProductData({...newProductData, nfOrigem: e.target.value})}
                                        placeholder="Número da NF para localizar no estoque"
                                    />
                                    <span className="form-help">Preenchido automaticamente com a NF da entrada</span>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Observações</label>
                                    <textarea
                                        className="form-textarea"
                                        value={newProductData.observations}
                                        onChange={(e) => setNewProductData({...newProductData, observations: e.target.value})}
                                        placeholder="Informações adicionais..."
                                    />
                                </div>

                                <div className="btn-group">
                                    <button className="btn btn-success" onClick={handleCreateProduct}>Cadastrar</button>
                                    <button className="btn btn-secondary" onClick={() => setShowNewProductModal(false)}>Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="card">
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Tipo</label>
                                <div className="form-radio-group">
                                    <label className="form-radio-label">
                                        <input type="radio" value="COMPRA" checked={type === 'COMPRA'} onChange={(e) => setType(e.target.value)} />
                                        <span>Compra</span>
                                    </label>
                                    <label className="form-radio-label">
                                        <input type="radio" value="DEVOLUCAO" checked={type === 'DEVOLUCAO'} onChange={(e) => setType(e.target.value)} />
                                        <span>Devolução</span>
                                    </label>
                                </div>
                            </div>

                            <div className="form-group">
                                <label className="form-label">Produto ({products.length} cadastrados)</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    placeholder="Buscar produto por nome ou SKU..."
                                    value={productSearch}
                                    onChange={(e) => setProductSearch(e.target.value)}
                                    style={{marginBottom: '8px'}}
                                />
                                <select className="form-select" value={sku} onChange={(e) => handleProductChange(e.target.value)} required>
                                    <option value="">Selecione... ({filteredProducts.length} encontrados)</option>
                                    <option value="__NEW__" style={{fontWeight: '600', color: 'var(--accent)'}}>+ Cadastrar novo produto</option>
                                    {filteredProducts.length > 0 && (
                                        <optgroup label="Produtos">
                                            {filteredProducts.map(p => (
                                                <option key={p.id} value={p.sku}>{p.name}</option>
                                            ))}
                                        </optgroup>
                                    )}
                                </select>
                                {products.length === 0 && (
                                    <span className="form-help" style={{color: 'var(--warning)'}}>
                                        Nenhum produto cadastrado. Clique em "+ Cadastrar novo produto".
                                    </span>
                                )}
                            </div>

                            <div className="form-row">
                                <div className="form-group">
                                    <label className="form-label">Quantidade</label>
                                    <input type="number" className="form-input" value={quantity} onChange={(e) => setQuantity(e.target.value)} min="1" required />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Fornecedor</label>
                                    <input type="text" className="form-input" value={supplier} onChange={(e) => setSupplier(e.target.value)} />
                                </div>
                            </div>

                            <div className="form-group">
                                <label className="form-label">Nota Fiscal</label>
                                <input type="text" className="form-input" value={nf} onChange={(e) => setNf(e.target.value)} />
                            </div>

                            <div className="form-group">
                                <label className="form-label">Local de Entrada *</label>
                                <div style={{display: 'flex', gap: '8px'}}>
                                    <select 
                                        className="form-select" 
                                        value={localEntrada} 
                                        onChange={(e) => setLocalEntrada(e.target.value)}
                                        required
                                        style={{flex: 1}}
                                    >
                                        {(locaisOrigem || ['Loja Principal', 'Depósito 1', 'Depósito 2']).map((local, idx) => (
                                            <option key={idx} value={local}>{local}</option>
                                        ))}
                                    </select>
                                    <button 
                                        type="button"
                                        className="btn btn-secondary"
                                        onClick={() => setShowLocaisModal(true)}
                                        title="Gerenciar locais/depósitos"
                                        style={{padding: '8px 12px'}}
                                    >
                                        <Icon name="settings" size={14} />
                                    </button>
                                </div>
                                <span className="form-help">Selecione o depósito onde o produto está sendo armazenado</span>
                            </div>

                            <CategorySelectInline
                                categories={categories}
                                value={category}
                                onChange={setCategory}
                                onAddCategory={onAddCategory}
                                onUpdateCategory={onUpdateCategory}
                                onDeleteCategory={onDeleteCategory}
                                products={products}
                            />

                            <div className="btn-group">
                                <button type="submit" className="btn btn-primary" disabled={!sku || sku === '__NEW__'}>Registrar Entrada</button>
                            </div>
                        </form>
                    </div>

                    {/* Modal Gerenciar Locais - FORA DO FORM */}
                    {showLocaisModal && (
                        <LocaisModal
                            locaisOrigem={locaisOrigem}
                            onUpdateLocais={onUpdateLocais}
                            onClose={() => setShowLocaisModal(false)}
                        />
                    )}
                    </React.Fragment>)}
                </div>
            );
        }

        // ==========================================
        // MODAL GERENCIAR LOCAIS (Componente separado)
        // ==========================================
        function LocaisModal({ locaisOrigem, onUpdateLocais, onClose }) {
            const [locais, setLocais] = useState([...(locaisOrigem || ['Loja Principal'])]);
            const [novoLocal, setNovoLocal] = useState('');
            const [salvando, setSalvando] = useState(false);
            const [mensagem, setMensagem] = useState('');

            const handleEditLocal = (idx, valor) => {
                const novosLocais = [...locais];
                novosLocais[idx] = valor;
                setLocais(novosLocais);
            };

            const handleAddLocal = () => {
                if (novoLocal.trim()) {
                    setLocais([...locais, novoLocal.trim()]);
                    setNovoLocal('');
                }
            };

            const handleRemoveLocal = (idx) => {
                if (locais.length > 1) {
                    setLocais(locais.filter((_, i) => i !== idx));
                }
            };

            const handleSalvar = async () => {
                // Filtrar locais vazios
                const locaisValidos = locais.filter(l => l.trim());
                if (locaisValidos.length === 0) {
                    setMensagem('Adicione pelo menos um depósito');
                    return;
                }
                
                setSalvando(true);
                try {
                    await onUpdateLocais(locaisValidos);
                    setMensagem('Salvo com sucesso!');
                    setTimeout(() => {
                        onClose();
                    }, 800);
                } catch (err) {
                    setMensagem('Erro ao salvar: ' + err.message);
                    setSalvando(false);
                }
            };

            return (
                <div className="modal-overlay" onClick={(e) => e.target === e.currentTarget && onClose()}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2 className="modal-title">Gerenciar Depósitos</h2>
                        <p className="modal-subtitle">Adicione, edite ou remova locais de armazenamento</p>

                        {mensagem && (
                            <div style={{
                                padding: '10px',
                                background: mensagem.includes('Salvo') ? 'var(--success-light)' : 'var(--danger-light)',
                                borderRadius: 'var(--radius)',
                                marginBottom: '16px',
                                fontSize: '13px'
                            }}>
                                {mensagem}
                            </div>
                        )}

                        <div style={{marginBottom: '16px'}}>
                            {locais.map((local, idx) => (
                                <div key={idx} style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    padding: '10px 12px',
                                    background: 'var(--bg-primary)',
                                    borderRadius: 'var(--radius)',
                                    marginBottom: '8px'
                                }}>
                                    <Icon name="stock" size={16} />
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={local}
                                        onChange={(e) => handleEditLocal(idx, e.target.value)}
                                        style={{flex: 1}}
                                        placeholder="Nome do depósito..."
                                    />
                                    {locais.length > 1 && (
                                        <button 
                                            type="button"
                                            className="btn btn-secondary btn-sm"
                                            onClick={() => handleRemoveLocal(idx)}
                                            title="Remover"
                                            style={{color: 'var(--danger)', padding: '6px 10px'}}
                                        ><Icon name="delete" size={14} /></button>
                                    )}
                                </div>
                            ))}
                        </div>

                        <div style={{
                            display: 'flex',
                            gap: '8px',
                            marginBottom: '16px',
                            padding: '12px',
                            background: 'var(--bg-secondary)',
                            borderRadius: 'var(--radius)',
                            border: '2px dashed var(--border)'
                        }}>
                            <input
                                type="text"
                                className="form-input"
                                placeholder="Nome do novo depósito..."
                                value={novoLocal}
                                onChange={(e) => setNovoLocal(e.target.value)}
                                onKeyDown={(e) => {
                                    if (e.key === 'Enter') {
                                        e.preventDefault();
                                        handleAddLocal();
                                    }
                                }}
                                style={{flex: 1}}
                            />
                            <button 
                                type="button"
                                className="btn btn-secondary" 
                                onClick={handleAddLocal}
                                disabled={!novoLocal.trim()}
                            >
                                Adicionar
                            </button>
                        </div>

                        <div className="btn-group" style={{justifyContent: 'space-between'}}>
                            <button type="button" className="btn btn-secondary" onClick={onClose}>
                                Cancelar
                            </button>
                            <button 
                                type="button" 
                                className="btn btn-primary" 
                                onClick={handleSalvar}
                                disabled={salvando}
                            >
                                {salvando ? 'Salvando...' : 'Salvar Alterações'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // ==========================================
        // EXIT FORM
        // ==========================================
        function ExitForm({ products, stock, onSubmit, entries, exits, onAddProduct, categories, locaisOrigem, onUpdateLocais, onAddCategory, onUpdateCategory, onDeleteCategory }) {
            const [exitMode, setExitMode] = useState('manual'); // 'manual', 'tiny', or 'csv'
            const [type, setType] = useState('VENDA');
            const [sku, setSku] = useState('');
            const [nfOrigem, setNfOrigem] = useState(''); // NF de onde está saindo
            const [quantity, setQuantity] = useState('');
            const [client, setClient] = useState('');
            const [nf, setNf] = useState(''); // NF de venda/saída
            const [success, setSuccess] = useState(false);
            const [error, setError] = useState('');
            const [productSearch, setProductSearch] = useState('');

            // Filtrar produtos pela busca
            const filteredProducts = [...stock]
                .filter(p => {
                    if (!productSearch) return true;
                    const search = productSearch.toLowerCase();
                    return (p.name || '').toLowerCase().includes(search) || 
                           (p.sku || '').toLowerCase().includes(search) ||
                           (p.nfOrigem || '').toLowerCase().includes(search);
                })
                .sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            const selectedProduct = stock.find(p => p.sku === sku);
            
            // Calcular estoque disponível por NF de entrada para o produto selecionado
            // CORRIGIDO: Agora considera as saídas já feitas de cada NF
            // Saídas antigas (sem nfOrigem) são distribuídas por FIFO
            // Normalizar chave de NF: null, '', 'Sem NF', 'SEM_NF' → 'SEM_NF'
            const normalizeNfKey = (nf) => {
                if (!nf || nf === 'Sem NF' || nf === 'SEM_NF') return 'SEM_NF';
                return nf;
            };

            const getEstoquePorNF = (produtoSku) => {
                if (!produtoSku || !entries || !exits) return [];

                // Pegar todas as entradas desse produto, ordenadas por data
                const entradasProduto = entries
                    .filter(e => e.sku === produtoSku)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                // Pegar todas as saídas desse produto
                const saidasProduto = exits.filter(e => e.sku === produtoSku);

                // Separar saídas COM NF real vs SEM NF (inclui 'Sem NF', null, vazio)
                const saidasComNF = saidasProduto.filter(s =>
                    s.nfOrigem && s.nfOrigem !== 'Sem NF' && s.nfOrigem !== 'SEM_NF'
                );
                const saidasSemNF = saidasProduto.filter(s =>
                    !s.nfOrigem || s.nfOrigem === 'Sem NF' || s.nfOrigem === 'SEM_NF'
                );

                // Agrupar entradas por NF normalizada
                const porNF = {};
                entradasProduto.forEach(e => {
                    const nfKey = normalizeNfKey(e.nf);
                    if (!porNF[nfKey]) {
                        porNF[nfKey] = {
                            nf: e.nf || 'Sem NF',
                            entradas: 0,
                            saidas: 0,
                            data: e.date,
                            localEntrada: e.localEntrada || '-'
                        };
                    }
                    porNF[nfKey].entradas += (e.quantity || 0);
                });

                // Subtrair saídas COM NF real de cada NF específica
                saidasComNF.forEach(s => {
                    const nfKey = normalizeNfKey(s.nfOrigem);
                    if (porNF[nfKey]) {
                        porNF[nfKey].saidas += (s.quantity || 0);
                    }
                });

                // Distribuir saídas SEM NF por FIFO (mais antigas primeiro)
                let saidasRestantes = saidasSemNF.reduce((sum, s) => sum + (s.quantity || 0), 0);
                const nfKeys = Object.keys(porNF).sort((a, b) =>
                    new Date(porNF[a].data) - new Date(porNF[b].data)
                );

                for (const nfKey of nfKeys) {
                    if (saidasRestantes <= 0) break;
                    const disponivel = porNF[nfKey].entradas - porNF[nfKey].saidas;
                    const descontar = Math.min(disponivel, saidasRestantes);
                    porNF[nfKey].saidas += descontar;
                    saidasRestantes -= descontar;
                }

                // Calcular quantidade disponível e filtrar NFs com estoque > 0
                return Object.values(porNF)
                    .map(item => ({
                        ...item,
                        quantidade: item.entradas - item.saidas
                    }))
                    .filter(item => item.quantidade > 0);
            };

            const estoquePorNF = getEstoquePorNF(sku);
            const nfSelecionada = estoquePorNF.find(e => e.nf === nfOrigem);
            const availableFromNF = nfSelecionada?.quantidade || 0;
            const totalAvailable = selectedProduct?.currentQuantity || 0;

            const handleSubmit = (e) => {
                e.preventDefault();
                
                // Se selecionou uma NF específica, validar quantidade
                if (nfOrigem && parseInt(quantity) > availableFromNF) {
                    setError(`Quantidade insuficiente na NF ${nfOrigem}! Disponível: ${availableFromNF}`);
                    return;
                }
                
                if (parseInt(quantity) > totalAvailable) {
                    setError(`Quantidade insuficiente! Disponível total: ${totalAvailable}`);
                    return;
                }
                
                onSubmit({ 
                    type, 
                    sku, 
                    quantity: parseInt(quantity), 
                    client, 
                    nf,
                    nfOrigem: (nfOrigem && nfOrigem !== 'Sem NF' && nfOrigem !== 'SEM_NF') ? nfOrigem : null
                });
                setSuccess(true);
                setError('');
                setSku('');
                setNfOrigem('');
                setQuantity('');
                setClient('');
                setNf('');
                setProductSearch('');
                setTimeout(() => setSuccess(false), 3000);
            };

            return (
                <div>
                    <div className="page-header">
                        <h1 className="page-title">Saída</h1>
                        <p className="page-subtitle">Registre saídas de produtos do estoque</p>
                    </div>

                    <div className="card" style={{marginBottom: '16px'}}>
                        <div className="filter-tabs">
                            <button className={`filter-tab ${exitMode === 'manual' ? 'active' : ''}`} onClick={() => setExitMode('manual')}>
                                Saída Manual
                            </button>
                            <button className={`filter-tab ${exitMode === 'tiny' ? 'active' : ''}`} onClick={() => setExitMode('tiny')}>
                                Importar do Tiny
                            </button>
                            <button className={`filter-tab ${exitMode === 'csv' ? 'active' : ''}`} onClick={() => setExitMode('csv')}>
                                Importar CSV
                            </button>
                        </div>
                    </div>

                    {exitMode === 'tiny' && (
                        <TinyNFeImport
                            products={products}
                            onSubmitEntry={() => {}}
                            onSubmitExit={onSubmit}
                            onAddProduct={onAddProduct}
                            categories={categories}
                            locaisOrigem={locaisOrigem || []}
                            onUpdateLocais={onUpdateLocais}
                            entries={entries || []}
                            exits={exits || []}
                            stock={stock || []}
                            mode="exit"
                            onAddCategory={onAddCategory}
                            onUpdateCategory={onUpdateCategory}
                            onDeleteCategory={onDeleteCategory}
                        />
                    )}

                    {exitMode === 'csv' && (
                        <CSVImportTab
                            type="exit"
                            products={products}
                            onImport={onSubmit}
                            locaisOrigem={locaisOrigem}
                            onUpdateLocais={onUpdateLocais}
                            onAddProduct={onAddProduct}
                            categories={categories}
                            onAddCategory={onAddCategory}
                            onUpdateCategory={onUpdateCategory}
                            onDeleteCategory={onDeleteCategory}
                        />
                    )}

                    {exitMode === 'manual' && (<React.Fragment>
                    {success && <div className="alert alert-success">Saída registrada!</div>}
                    {error && <div className="alert alert-danger">{error}</div>}

                    <div className="card">
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Tipo</label>
                                <div className="form-radio-group">
                                    <label className="form-radio-label">
                                        <input type="radio" value="VENDA" checked={type === 'VENDA'} onChange={(e) => setType(e.target.value)} />
                                        <span>Venda</span>
                                    </label>
                                    <label className="form-radio-label">
                                        <input type="radio" value="PERDA" checked={type === 'PERDA'} onChange={(e) => setType(e.target.value)} />
                                        <span>Perda</span>
                                    </label>
                                    <label className="form-radio-label">
                                        <input type="radio" value="DEVOLUCAO_FORNECEDOR" checked={type === 'DEVOLUCAO_FORNECEDOR'} onChange={(e) => setType(e.target.value)} />
                                        <span>Devolução ao Fornecedor</span>
                                    </label>
                                </div>
                            </div>

                            <div className="form-group">
                                <label className="form-label">Produto ({stock.length} em estoque)</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    placeholder="Buscar por nome, SKU ou NF..."
                                    value={productSearch}
                                    onChange={(e) => setProductSearch(e.target.value)}
                                    style={{marginBottom: '8px'}}
                                />
                                <select className="form-select" value={sku} onChange={(e) => { setSku(e.target.value); setNfOrigem(''); setProductSearch(''); }} required>
                                    <option value="">Selecione... ({filteredProducts.length} encontrados)</option>
                                    {filteredProducts.map(p => (
                                        <option key={p.id} value={p.sku}>
                                            {p.name} ({p.currentQuantity} un.)
                                        </option>
                                    ))}
                                </select>
                            </div>

                            {/* Seleção de NF de origem */}
                            {selectedProduct && estoquePorNF.length > 0 && (
                                <div className="form-group">
                                    <label className="form-label">Retirar do estoque da NF:</label>
                                    <div style={{
                                        border: '1px solid var(--border)',
                                        borderRadius: 'var(--radius)',
                                        maxHeight: '200px',
                                        overflowY: 'auto'
                                    }}>
                                        {estoquePorNF.map((item, idx) => (
                                            <label
                                                key={idx}
                                                style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    padding: '12px',
                                                    borderBottom: idx < estoquePorNF.length - 1 ? '1px solid var(--border)' : 'none',
                                                    cursor: 'pointer',
                                                    background: nfOrigem === item.nf ? 'var(--accent-bg)' : 'white',
                                                    transition: 'background 0.2s'
                                                }}
                                            >
                                                <input
                                                    type="radio"
                                                    name="nfOrigem"
                                                    value={item.nf}
                                                    checked={nfOrigem === item.nf}
                                                    onChange={(e) => setNfOrigem(e.target.value)}
                                                    style={{marginRight: '12px', width: '18px', height: '18px'}}
                                                />
                                                <div style={{flex: 1}}>
                                                    <div style={{fontWeight: '600', color: 'var(--text-primary)'}}>
                                                        NF: {item.nf}
                                                    </div>
                                                    <div style={{fontSize: '12px', color: 'var(--text-muted)'}}>
                                                        {item.quantidade} unidade(s) disponível(is)
                                                        {item.localEntrada && item.localEntrada !== '-' && <span style={{marginLeft: '8px', color: 'var(--accent)'}}>{item.localEntrada}</span>}
                                                        {item.data && ` • Entrada: ${new Date(item.data).toLocaleDateString('pt-BR')}`}
                                                    </div>
                                                </div>
                                                <div style={{
                                                    background: 'var(--success-light)',
                                                    color: 'var(--success)',
                                                    padding: '4px 12px',
                                                    borderRadius: '20px',
                                                    fontSize: '12px',
                                                    fontWeight: '600'
                                                }}>
                                                    {item.quantidade} un.
                                                </div>
                                            </label>
                                        ))}
                                    </div>
                                    {!nfOrigem && (
                                        <div style={{fontSize: '11px', color: 'var(--warning)', marginTop: '6px'}}>
                                            Selecione a NF de onde o produto será retirado
                                        </div>
                                    )}
                                </div>
                            )}

                            {selectedProduct && (
                                <div style={{marginBottom: '16px', padding: '12px', background: 'var(--bg-primary)', borderRadius: 'var(--radius)', fontSize: '13px'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                        <div>
                                            <strong>Estoque total: {totalAvailable} un.</strong>
                                        </div>
                                        {nfOrigem && (
                                            <div style={{color: 'var(--accent)', fontWeight: '500'}}>
                                                Selecionado: NF {nfOrigem} ({availableFromNF} un.)
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            <div className="form-row">
                                <div className="form-group">
                                    <label className="form-label">Quantidade *</label>
                                    <input 
                                        type="number" 
                                        className="form-input" 
                                        value={quantity} 
                                        onChange={(e) => setQuantity(e.target.value)} 
                                        min="1" 
                                        max={nfOrigem ? availableFromNF : totalAvailable} 
                                        required 
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Cliente</label>
                                    <input type="text" className="form-input" value={client} onChange={(e) => setClient(e.target.value)} />
                                </div>
                            </div>

                            <div className="form-group">
                                <label className="form-label">NF de Saída/Venda</label>
                                <input 
                                    type="text" 
                                    className="form-input" 
                                    value={nf} 
                                    onChange={(e) => setNf(e.target.value)} 
                                    placeholder="Número da nota fiscal de venda"
                                />
                            </div>

                            <div className="btn-group">
                                <button 
                                    type="submit" 
                                    className="btn btn-primary"
                                    disabled={selectedProduct && estoquePorNF.length > 0 && !nfOrigem}
                                >
                                    Registrar Saída
                                </button>
                            </div>
                        </form>
                    </div>
                    </React.Fragment>)}
                </div>
            );
        }

        // ==========================================
        // SHIPPING MANAGER (Despachos)
        // ==========================================
        function ShippingManager({ shippings, onAdd, onUpdate, onDelete, stock, products, onAddExit, onAddEntry, locaisOrigem, onUpdateLocais, onAddProduct, categories, entries, exits, isStockAdmin, onAddCategory, onUpdateCategory, onDeleteCategory }) {
            const [activeView, setActiveView] = useState('list');
            const [nfFile, setNfFile] = useState(null);
            const [nfData, setNfData] = useState(null);
            const [success, setSuccess] = useState('');
            const [error, setError] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');
            const [shipPeriodFilter, setShipPeriodFilter] = useState('30');
            const [shipCustomMonth, setShipCustomMonth] = useState(new Date().getMonth());
            const [shipCustomYear, setShipCustomYear] = useState(new Date().getFullYear());
            const [editingShipping, setEditingShipping] = useState(null);
            const [showLocaisModal, setShowLocaisModal] = useState(false);
            const [showNewProductModal, setShowNewProductModal] = useState(null); // índice do produto
            const [newProductData, setNewProductData] = useState({
                name: '', sku: '', ean: '', category: '', minStock: 1, observations: ''
            });
            const [showVincularModal, setShowVincularModal] = useState(null); // índice do produto para vincular
            const [vincularSearch, setVincularSearch] = useState('');
            
            // Estados para importação em lote
            const [importMode, setImportMode] = useState('single'); // 'single' ou 'batch'
            const [batchFiles, setBatchFiles] = useState([]); // Arquivos selecionados
            const [batchDespachos, setBatchDespachos] = useState([]); // Despachos extraídos
            const [processingBatch, setProcessingBatch] = useState(false);
            const [batchProgress, setBatchProgress] = useState({ current: 0, total: 0 });
            
            // Formulário de despacho manual
            const [form, setForm] = useState({
                nfNumero: '',
                cliente: '',
                destino: '',
                localOrigem: locaisOrigem[0] || 'Loja Principal',
                transportadora: '',
                codigoRastreio: '',
                linkRastreio: '',
                melhorEnvioId: '', // ID da etiqueta no Melhor Envio
                baixarEstoque: true,
                produtos: [],
                observacoes: ''
            });
            
            // Estado para atualização de rastreio
            const [atualizandoRastreio, setAtualizandoRastreio] = useState(false);
            
            // URL das Cloud Functions (ajustar após deploy)
            const FUNCTIONS_URL = 'https://ppslljqxsdsdmwfiayok.supabase.co/functions/v1';
            
            // Lista de transportadoras (incluindo Melhor Envio)
            const transportadoras = ['Melhor Envio', 'Correios', 'Jadlog', 'Total Express', 'Braspress', 'TNT', 'Azul Cargo', 'Loggi', 'Outro'];

            // Status possíveis
            const statusList = {
                'PENDENTE': { label: 'Pendente', color: '#f59e0b', bg: '#fef3c7' },
                'DESPACHADO': { label: 'Despachado', color: '#3b82f6', bg: '#dbeafe' },
                'EM_TRANSITO': { label: 'Em Trânsito', color: '#8b5cf6', bg: '#ede9fe' },
                'ENTREGUE': { label: 'Entregue', color: '#10b981', bg: '#d1fae5' },
                'DEVOLVIDO': { label: 'Devolvido', color: '#ef4444', bg: '#fee2e2' },
                'NAO_ENTREGUE': { label: 'Não Entregue', color: '#ef4444', bg: '#fee2e2' },
                'CANCELADO': { label: 'Cancelado', color: '#6b7280', bg: '#f3f4f6' }
            };

            // Normalizar chave de NF: null, '', 'Sem NF', 'SEM_NF' → 'SEM_NF'
            const normalizeNfKey = (nf) => {
                if (!nf || nf === 'Sem NF' || nf === 'SEM_NF') return 'SEM_NF';
                return nf;
            };

            // Função para calcular estoque disponível por NF de entrada
            // Saídas antigas (sem nfOrigem) são distribuídas por FIFO
            const getEstoquePorNF = (produtoSku) => {
                if (!produtoSku || !entries || !exits) return [];

                const entradasProduto = entries
                    .filter(e => e.sku === produtoSku)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                const saidasProduto = exits.filter(e => e.sku === produtoSku);

                // Separar saídas COM NF real vs SEM NF (inclui 'Sem NF', null, vazio)
                const saidasComNF = saidasProduto.filter(s =>
                    s.nfOrigem && s.nfOrigem !== 'Sem NF' && s.nfOrigem !== 'SEM_NF'
                );
                const saidasSemNF = saidasProduto.filter(s =>
                    !s.nfOrigem || s.nfOrigem === 'Sem NF' || s.nfOrigem === 'SEM_NF'
                );

                const porNF = {};
                entradasProduto.forEach(e => {
                    const nfKey = normalizeNfKey(e.nf);
                    if (!porNF[nfKey]) {
                        porNF[nfKey] = {
                            nf: e.nf || 'Sem NF',
                            entradas: 0,
                            saidas: 0,
                            data: e.date,
                            localEntrada: e.localEntrada || '-'
                        };
                    }
                    porNF[nfKey].entradas += (e.quantity || 0);
                });

                // Subtrair saídas COM NF real
                saidasComNF.forEach(s => {
                    const nfKey = normalizeNfKey(s.nfOrigem);
                    if (porNF[nfKey]) {
                        porNF[nfKey].saidas += (s.quantity || 0);
                    }
                });

                // Distribuir saídas SEM NF por FIFO
                let saidasRestantes = saidasSemNF.reduce((sum, s) => sum + (s.quantity || 0), 0);
                const nfKeys = Object.keys(porNF).sort((a, b) =>
                    new Date(porNF[a].data) - new Date(porNF[b].data)
                );

                for (const nfKey of nfKeys) {
                    if (saidasRestantes <= 0) break;
                    const disponivel = porNF[nfKey].entradas - porNF[nfKey].saidas;
                    const descontar = Math.min(disponivel, saidasRestantes);
                    porNF[nfKey].saidas += descontar;
                    saidasRestantes -= descontar;
                }

                return Object.values(porNF)
                    .map(item => ({
                        ...item,
                        quantidade: item.entradas - item.saidas
                    }))
                    .filter(item => item.quantidade > 0);
            };

            // Função para atualizar rastreio via Melhor Envio
            const atualizarRastreioMelhorEnvio = async (shipping) => {
                if (!shipping.melhorEnvioId && !shipping.codigoRastreio) {
                    setError('Informe o ID da etiqueta ou código de rastreio');
                    return;
                }

                setAtualizandoRastreio(true);
                setError('');

                try {
                    let response;
                    
                    if (shipping.melhorEnvioId) {
                        // Rastrear pelo ID da etiqueta
                        response = await fetch(`${FUNCTIONS_URL}/rastrear-envio`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + (await supabaseClient.auth.getSession()).data.session?.access_token
                            },
                            body: JSON.stringify({ orderIds: [shipping.melhorEnvioId] })
                        });
                    } else {
                        // Rastrear pelo código de rastreio
                        response = await fetch(`${FUNCTIONS_URL}/rastrear-envio`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + (await supabaseClient.auth.getSession()).data.session?.access_token
                            },
                            body: JSON.stringify({ codigosRastreio: [shipping.codigoRastreio] })
                        });
                    }

                    const result = await response.json();

                    if (result.success && result.data) {
                        const key = shipping.melhorEnvioId || shipping.codigoRastreio;
                        const info = result.data[key];
                        
                        if (info && info.status) {
                            // Atualizar status no Supabase
                            await onUpdate(shipping.id, {
                                status: info.status,
                                codigoRastreio: info.codigoRastreio || shipping.codigoRastreio,
                                ultimaAtualizacaoRastreio: new Date().toISOString(),
                                rastreioInfo: info
                            });
                            
                            setSuccess(`Status atualizado: ${statusList[info.status]?.label || info.status}`);
                            setTimeout(() => setSuccess(''), 3000);
                        } else if (info?.erro) {
                            setError(info.erro);
                        }
                    } else {
                        setError(result.error || 'Erro ao consultar rastreio');
                    }
                } catch (err) {
                    console.error('Erro ao atualizar rastreio:', err);
                    setError('Erro ao conectar com serviço de rastreio. Verifique se as Functions estão configuradas.');
                }

                setAtualizandoRastreio(false);
            };

            // Atualizar todos os rastreios pendentes
            const atualizarTodosRastreios = async () => {
                const pendentes = shippings.filter(s => 
                    s.status !== 'ENTREGUE' && 
                    s.status !== 'CANCELADO' && 
                    s.status !== 'DEVOLVIDO' &&
                    (s.melhorEnvioId || s.codigoRastreio)
                );

                if (pendentes.length === 0) {
                    setSuccess('Nenhum despacho pendente para atualizar');
                    setTimeout(() => setSuccess(''), 3000);
                    return;
                }

                setAtualizandoRastreio(true);
                let atualizados = 0;

                for (const shipping of pendentes) {
                    try {
                        await atualizarRastreioMelhorEnvio(shipping);
                        atualizados++;
                    } catch (err) {
                        console.error('Erro ao atualizar:', shipping.nfNumero, err);
                    }
                }

                setAtualizandoRastreio(false);
                setSuccess(`${atualizados} despacho(s) atualizado(s)`);
                setTimeout(() => setSuccess(''), 3000);
            };

            // ========== IMPORTAÇÃO EM LOTE ==========
            
            // Processar um único arquivo XML e retornar dados extraídos
            const processarXML = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const parser = new DOMParser();
                            const xml = parser.parseFromString(event.target.result, 'text/xml');
                            
                            const parseError = xml.querySelector('parsererror');
                            if (parseError) {
                                reject(new Error('Erro ao ler XML'));
                                return;
                            }

                            // Extrair dados
                            const nNF = getXmlText(xml, ['nNF', 'ide nNF', 'infNFe ide nNF']) || file.name.replace('.xml', '');
                            const xNome = getXmlText(xml, ['dest xNome', 'xNome']);
                            
                            // Endereço
                            const xLgr = getXmlText(xml, ['dest enderDest xLgr', 'enderDest xLgr', 'xLgr']);
                            const nro = getXmlText(xml, ['dest enderDest nro', 'enderDest nro', 'nro']);
                            const xBairro = getXmlText(xml, ['dest enderDest xBairro', 'enderDest xBairro', 'xBairro']);
                            const xMun = getXmlText(xml, ['dest enderDest xMun', 'enderDest xMun', 'xMun']);
                            const UF = getXmlText(xml, ['dest enderDest UF', 'enderDest UF', 'UF']);
                            const CEP = getXmlText(xml, ['dest enderDest CEP', 'enderDest CEP', 'CEP']);
                            
                            let destino = '';
                            if (xLgr) destino += xLgr;
                            if (nro) destino += `, ${nro}`;
                            if (xBairro) destino += ` - ${xBairro}`;
                            if (xMun) destino += `, ${xMun}`;
                            if (UF) destino += `/${UF}`;
                            if (CEP) destino += ` - CEP: ${CEP}`;

                            // Produtos
                            const produtos = [];
                            const dets = xml.getElementsByTagName('det');
                            
                            for (let i = 0; i < dets.length; i++) {
                                const det = dets[i];
                                const prod = det.getElementsByTagName('prod')[0];
                                if (!prod) continue;
                                
                                const cProd = prod.getElementsByTagName('cProd')[0]?.textContent || '';
                                const xProd = prod.getElementsByTagName('xProd')[0]?.textContent || '';
                                const qCom = prod.getElementsByTagName('qCom')[0]?.textContent || '1';
                                const cEAN = prod.getElementsByTagName('cEAN')[0]?.textContent || '';
                                
                                const skuNF = cProd.trim();
                                const eanNormalizado = (cEAN && cEAN !== 'SEM GTIN') ? cEAN.trim().replace(/[^0-9]/g, '') : '';
                                
                                // Vincular automaticamente
                                const produtoEncontrado = stock.find(p => {
                                    const pSku = (p.sku || '').trim().toLowerCase();
                                    return pSku === skuNF.toLowerCase();
                                });
                                
                                produtos.push({
                                    sku: cProd,
                                    nome: xProd,
                                    quantidade: parseInt(parseFloat(qCom)) || 1,
                                    ean: eanNormalizado,
                                    baixarEstoque: !!produtoEncontrado,
                                    produtoEstoque: produtoEncontrado || null,
                                    autoVinculado: !!produtoEncontrado
                                });
                            }

                            resolve({
                                fileName: file.name,
                                nfNumero: nNF,
                                cliente: xNome,
                                destino: destino,
                                produtos: produtos,
                                localOrigem: locaisOrigem[0] || 'Loja Principal',
                                transportadora: '',
                                codigoRastreio: '',
                                linkRastreio: '',
                                melhorEnvioId: '',
                                observacoes: '',
                                status: 'PENDENTE',
                                selected: true, // Para checkbox de seleção
                                vinculados: produtos.filter(p => p.autoVinculado).length,
                                total: produtos.length
                            });
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
                    reader.readAsText(file, 'UTF-8');
                });
            };

            // Processar múltiplos arquivos
            const handleBatchUpload = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                setBatchFiles(files);
                setProcessingBatch(true);
                setBatchProgress({ current: 0, total: files.length });
                setError('');

                const resultados = [];
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    setBatchProgress({ current: i + 1, total: files.length });
                    
                    try {
                        if (file.name.toLowerCase().endsWith('.xml')) {
                            const dados = await processarXML(file);
                            resultados.push(dados);
                        } else {
                            resultados.push({
                                fileName: file.name,
                                nfNumero: file.name.replace(/\.(xml|pdf)$/i, ''),
                                cliente: '',
                                destino: '',
                                produtos: [],
                                localOrigem: locaisOrigem[0] || 'Loja Principal',
                                transportadora: '',
                                error: 'PDF não suporta extração automática em lote',
                                selected: false,
                                vinculados: 0,
                                total: 0
                            });
                        }
                    } catch (err) {
                        resultados.push({
                            fileName: file.name,
                            nfNumero: file.name.replace(/\.(xml|pdf)$/i, ''),
                            error: err.message,
                            selected: false,
                            vinculados: 0,
                            total: 0
                        });
                    }
                }

                setBatchDespachos(resultados);
                setProcessingBatch(false);
                
                const sucessos = resultados.filter(r => !r.error).length;
                const erros = resultados.filter(r => r.error).length;
                setSuccess(`${sucessos} arquivo(s) processado(s) com sucesso${erros > 0 ? `, ${erros} com erro` : ''}`);
            };

            // Salvar despachos em lote
            const salvarDespachosLote = async () => {
                const selecionados = batchDespachos.filter(d => d.selected && !d.error);
                
                if (selecionados.length === 0) {
                    setError('Selecione ao menos um despacho para salvar');
                    return;
                }

                setProcessingBatch(true);
                setBatchProgress({ current: 0, total: selecionados.length });
                
                let salvos = 0;
                let erros = 0;

                for (let i = 0; i < selecionados.length; i++) {
                    const despacho = selecionados[i];
                    setBatchProgress({ current: i + 1, total: selecionados.length });
                    
                    try {
                        const savedShipping = await onAdd({
                            nfNumero: despacho.nfNumero,
                            cliente: despacho.cliente,
                            destino: despacho.destino,
                            localOrigem: despacho.localOrigem,
                            transportadora: despacho.transportadora,
                            codigoRastreio: despacho.codigoRastreio,
                            linkRastreio: despacho.linkRastreio,
                            melhorEnvioId: despacho.melhorEnvioId,
                            produtos: despacho.produtos,
                            observacoes: despacho.observacoes,
                            status: 'PENDENTE'
                        });
                        salvos++;

                        // Criar saídas de estoque para produtos vinculados
                        const shippingId = savedShipping?.id || null;
                        const produtosComExit = [...despacho.produtos];
                        let temExit = false;
                        for (let j = 0; j < despacho.produtos.length; j++) {
                            const prod = despacho.produtos[j];
                            if (prod.produtoEstoque && prod.baixarEstoque) {
                                try {
                                    const exitResult = await onAddExit({
                                        type: 'VENDA',
                                        sku: prod.produtoEstoque.sku,
                                        quantity: prod.quantidade,
                                        client: despacho.cliente || '',
                                        nf: despacho.nfNumero || '',
                                        nfOrigem: (prod.nfOrigem && prod.nfOrigem !== 'Sem NF' && prod.nfOrigem !== 'SEM_NF')
                                            ? prod.nfOrigem : null,
                                    });
                                    if (exitResult?.id) {
                                        produtosComExit[j] = {
                                            ...produtosComExit[j],
                                            exitId: exitResult.id,
                                            baixouEstoque: true,
                                        };
                                        temExit = true;
                                    }
                                } catch (exitErr) {
                                    console.error('Erro ao registrar saída de estoque:', prod.produtoEstoque.sku, exitErr);
                                }
                            }
                        }
                        // Atualizar JSONB do shipping com exitIds
                        if (temExit && shippingId) {
                            try {
                                await onUpdate(shippingId, { produtos: produtosComExit });
                            } catch (updateErr) {
                                console.error('Erro ao atualizar JSONB com exitId:', despacho.nfNumero, updateErr);
                            }
                        }
                    } catch (err) {
                        console.error('Erro ao salvar:', despacho.nfNumero, err);
                        erros++;
                    }
                }

                setProcessingBatch(false);
                setBatchDespachos([]);
                setBatchFiles([]);
                setSuccess(`${salvos} despacho(s) registrado(s)${erros > 0 ? `, ${erros} erro(s)` : ''}!`);
                setActiveView('list');
                setTimeout(() => setSuccess(''), 5000);
            };

            // Toggle seleção de despacho em lote
            const toggleBatchSelection = (index) => {
                const newBatch = [...batchDespachos];
                newBatch[index].selected = !newBatch[index].selected;
                setBatchDespachos(newBatch);
            };

            // Selecionar/deselecionar todos
            const toggleSelectAll = () => {
                const todosValidos = batchDespachos.filter(d => !d.error);
                const todosSelecionados = todosValidos.every(d => d.selected);
                
                const newBatch = batchDespachos.map(d => ({
                    ...d,
                    selected: d.error ? false : !todosSelecionados
                }));
                setBatchDespachos(newBatch);
            };

            // Editar despacho em lote
            const editarDespachoBatch = (index, campo, valor) => {
                const newBatch = [...batchDespachos];
                newBatch[index][campo] = valor;
                setBatchDespachos(newBatch);
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                const date = new Date(dateStr);
                return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
            };

            // Filtrar despachos
            const filteredShippings = useMemo(() => {
                let items = filterByPeriod(shippings, shipPeriodFilter, shipCustomMonth, shipCustomYear, 'date');
                items = items.filter(s => {
                    const search = searchTerm.toLowerCase();
                    const matchesSearch = (s.nfNumero || '').toLowerCase().includes(search) ||
                                         (s.cliente || '').toLowerCase().includes(search) ||
                                         (s.codigoRastreio || '').toLowerCase().includes(search);
                    const matchesStatus = statusFilter === 'all' || s.status === statusFilter;
                    return matchesSearch && matchesStatus;
                });
                return items.sort((a, b) => new Date(b.date) - new Date(a.date));
            }, [shippings, searchTerm, statusFilter, shipPeriodFilter, shipCustomMonth, shipCustomYear]);

            // Função auxiliar para extrair texto do XML (lida com namespaces)
            const getXmlText = (xml, selectors) => {
                for (const selector of selectors) {
                    // Tentar query direto
                    let el = xml.querySelector(selector);
                    if (el?.textContent) return el.textContent;
                    
                    // Tentar com getElementsByTagName (ignora namespace)
                    const tagName = selector.split(' > ').pop();
                    const elements = xml.getElementsByTagName(tagName);
                    if (elements.length > 0 && elements[0].textContent) {
                        return elements[0].textContent;
                    }
                }
                return '';
            };

            // Importar NF (PDF ou XML)
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setNfFile(file);
                setError('');
                const fileName = file.name.toLowerCase();

                if (fileName.endsWith('.xml')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const parser = new DOMParser();
                            const xmlText = event.target.result;
                            const xml = parser.parseFromString(xmlText, 'text/xml');
                            
                            // Verificar erro de parse
                            const parseError = xml.querySelector('parsererror');
                            if (parseError) {
                                setError('Erro ao ler XML. Verifique se o arquivo está correto.');
                                return;
                            }

                            // Extrair dados da NF-e (tenta vários seletores para compatibilidade)
                            const nNF = getXmlText(xml, ['nNF', 'ide nNF', 'infNFe ide nNF']) || 
                                       getXmlText(xml, ['infProt nProt']) || '';
                            
                            // Dados do destinatário
                            const xNome = getXmlText(xml, ['dest xNome', 'xNome']);
                            const xLgr = getXmlText(xml, ['dest enderDest xLgr', 'enderDest xLgr', 'xLgr']);
                            const nro = getXmlText(xml, ['dest enderDest nro', 'enderDest nro', 'nro']);
                            const xBairro = getXmlText(xml, ['dest enderDest xBairro', 'enderDest xBairro', 'xBairro']);
                            const xMun = getXmlText(xml, ['dest enderDest xMun', 'enderDest xMun', 'xMun']);
                            const UF = getXmlText(xml, ['dest enderDest UF', 'enderDest UF']);
                            const CEP = getXmlText(xml, ['dest enderDest CEP', 'enderDest CEP', 'CEP']);
                            
                            // Montar endereço completo
                            let destino = '';
                            if (xLgr) destino += xLgr;
                            if (nro) destino += `, ${nro}`;
                            if (xBairro) destino += ` - ${xBairro}`;
                            if (xMun) destino += ` - ${xMun}`;
                            if (UF) destino += `/${UF}`;
                            if (CEP) destino += ` - CEP: ${CEP}`;
                            
                            // Extrair produtos
                            const dets = xml.getElementsByTagName('det');
                            const produtos = [];
                            
                            for (let i = 0; i < dets.length; i++) {
                                const det = dets[i];
                                const prod = det.getElementsByTagName('prod')[0];
                                if (prod) {
                                    const cProd = prod.getElementsByTagName('cProd')[0]?.textContent || '';
                                    const xProd = prod.getElementsByTagName('xProd')[0]?.textContent || '';
                                    const qCom = prod.getElementsByTagName('qCom')[0]?.textContent || '1';
                                    const cEAN = prod.getElementsByTagName('cEAN')[0]?.textContent || '';
                                    
                                    // Tentar encontrar produto no estoque por SKU ou EAN
                                    const skuNF = cProd.trim();
                                    const skuNormalizado = skuNF.toLowerCase().replace(/[^a-z0-9]/g, '');
                                    const eanNormalizado = (cEAN && cEAN !== 'SEM GTIN') ? cEAN.trim().replace(/[^0-9]/g, '') : '';
                                    const nomeNormalizado = xProd.trim().toLowerCase();
                                    
                                    console.log('Buscando produto:', { skuNF, skuNormalizado, eanNormalizado, nomeNormalizado });
                                    console.log('Produtos no estoque:', stock.map(p => ({ sku: p.sku, name: p.name })));
                                    
                                    const produtoEncontrado = stock.find(p => {
                                        const pSku = (p.sku || '').trim();
                                        const pSkuNorm = pSku.toLowerCase().replace(/[^a-z0-9]/g, '');
                                        const pEan = (p.ean || '').trim().replace(/[^0-9]/g, '');
                                        const pNome = (p.name || '').trim().toLowerCase();
                                        
                                        // Comparação exata de SKU (case insensitive)
                                        if (pSku.toLowerCase() === skuNF.toLowerCase()) {
                                            console.log('Match exato SKU:', pSku, '=', skuNF);
                                            return true;
                                        }
                                        
                                        // Comparação normalizada de SKU
                                        if (pSkuNorm && skuNormalizado && pSkuNorm === skuNormalizado) {
                                            console.log('Match normalizado SKU:', pSkuNorm, '=', skuNormalizado);
                                            return true;
                                        }
                                        
                                        // Comparação de EAN
                                        if (pEan && eanNormalizado && pEan === eanNormalizado) {
                                            console.log('Match EAN:', pEan, '=', eanNormalizado);
                                            return true;
                                        }
                                        
                                        // SKU contém ou é contido (mínimo 5 caracteres)
                                        if (pSkuNorm.length >= 5 && skuNormalizado.length >= 5) {
                                            if (pSkuNorm.includes(skuNormalizado) || skuNormalizado.includes(pSkuNorm)) {
                                                console.log('Match parcial SKU:', pSkuNorm, 'contém/está em', skuNormalizado);
                                                return true;
                                            }
                                        }
                                        
                                        return false;
                                    });
                                    
                                    if (produtoEncontrado) {
                                        console.log('OK: Produto encontrado:', produtoEncontrado.name);
                                    } else {
                                        console.log('ERRO: Produto NÃO encontrado para SKU:', skuNF);
                                    }
                                    
                                    produtos.push({
                                        sku: cProd,
                                        nome: xProd,
                                        quantidade: parseInt(parseFloat(qCom)) || 1,
                                        ean: eanNormalizado,
                                        baixarEstoque: !!produtoEncontrado,
                                        produtoEstoque: produtoEncontrado || null,
                                        autoVinculado: !!produtoEncontrado
                                    });
                                }
                            }
                            
                            // Contar produtos vinculados automaticamente
                            const vinculados = produtos.filter(p => p.autoVinculado).length;
                            const naoVinculados = produtos.length - vinculados;

                            console.log('NF Importada:', { nNF, xNome, destino, produtos });

                            // Atualizar o formulário com os dados extraídos
                            setForm(prevForm => ({
                                ...prevForm,
                                nfNumero: nNF,
                                cliente: xNome,
                                destino: destino,
                                produtos: produtos,
                                codigoRastreio: '',
                                linkRastreio: ''
                            }));
                            
                            setNfData({
                                nfNumero: nNF,
                                cliente: xNome,
                                destino: destino,
                                produtos: produtos
                            });
                            
                            let msg = `NF ${nNF} importada! ${produtos.length} produto(s).`;
                            if (vinculados > 0) msg += ` ${vinculados} vinculado(s) automaticamente.`;
                            if (naoVinculados > 0) msg += ` ${naoVinculados} não encontrado(s) no estoque.`;
                            setSuccess(msg);
                            setActiveView('register');
                            setTimeout(() => setSuccess(''), 8000);
                            
                        } catch (err) {
                            console.error('Erro ao processar XML:', err);
                            setError('Erro ao processar XML: ' + err.message);
                        }
                    };
                    reader.readAsText(file, 'UTF-8');
                } else if (fileName.endsWith('.pdf')) {
                    // Extrair dados do PDF automaticamente
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            setSuccess('Processando PDF...');
                            
                            const typedArray = new Uint8Array(event.target.result);
                            const pdf = await pdfjsLib.getDocument(typedArray).promise;
                            
                            let fullText = '';
                            
                            // Extrair texto de todas as páginas
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                const pageText = textContent.items.map(item => item.str).join(' ');
                                fullText += pageText + '\n';
                            }
                            
                            console.log('Texto extraído do PDF:', fullText);
                            
                            // ========== NÚMERO DA NF ==========
                            let nNF = '';
                            const nfPatterns = [
                                /N[ºo°]\s*(\d{3}\.\d{3}|\d{6})/i,
                                /NF-?e?\s*N[ºo°]?\s*(\d{3}\.\d{3}|\d{6})/i,
                                /Nº\s*(\d{3}\.\d{3})/,
                                /(\d{3}\.\d{3})\s*S[ée]rie/i,
                                /FOLHA.*?(\d{3}\.\d{3})/i
                            ];
                            for (const pattern of nfPatterns) {
                                const match = fullText.match(pattern);
                                if (match) {
                                    nNF = match[1].replace(/\./g, '');
                                    break;
                                }
                            }
                            
                            // ========== NOME DO DESTINATÁRIO ==========
                            let xNome = '';
                            const nomePatterns = [
                                /NOME\s*\/?\s*RAZ[ÃA]O\s*SOCIAL\s+([A-Za-záéíóúâêôãõçÁÉÍÓÚÂÊÔÃÕÇ\s]+?)(?=\s*(?:CNP[JF]|CPF|CNPJ\/CPF|DATA|ENDERE))/i,
                                /DESTINAT[ÁA]RIO\s*\/?\s*REMETENTE\s+NOME\s*\/?\s*RAZ[ÃA]O\s*SOCIAL\s+([A-Za-záéíóúâêôãõçÁÉÍÓÚÂÊÔÃÕÇ\s]+)/i,
                                /RAZ[ÃA]O\s*SOCIAL\s+([A-Za-záéíóúâêôãõçÁÉÍÓÚÂÊÔÃÕÇ\s]{5,50})/i
                            ];
                            for (const pattern of nomePatterns) {
                                const match = fullText.match(pattern);
                                if (match) {
                                    xNome = match[1].trim().replace(/\s+/g, ' ');
                                    break;
                                }
                            }
                            
                            // ========== ENDEREÇO ==========
                            let destino = '';
                            const endMatch = fullText.match(/ENDERE[ÇC]O\s+([^]+?)(?=BAIRRO|MUNIC[ÍI]PIO|CEP|\d{2}\.\d{3}-?\d{3})/i);
                            if (endMatch) {
                                destino = endMatch[1].trim().replace(/\s+/g, ' ').substring(0, 100);
                            }
                            
                            // ========== BAIRRO ==========
                            const bairroMatch = fullText.match(/BAIRRO\s+([A-Za-záéíóúâêôãõçÁÉÍÓÚÂÊÔÃÕÇ\s]+?)(?=\s*(?:CEP|FONE|MUNIC))/i);
                            if (bairroMatch) {
                                destino += ` - ${bairroMatch[1].trim()}`;
                            }
                            
                            // ========== MUNICÍPIO ==========
                            const munMatch = fullText.match(/MUNIC[ÍI]PIO\s+([A-Za-záéíóúâêôãõçÁÉÍÓÚÂÊÔÃÕÇ\s]+?)(?=\s*(?:FONE|UF|\(|\d))/i);
                            if (munMatch) {
                                destino += ` - ${munMatch[1].trim()}`;
                            }
                            
                            // ========== UF ==========
                            const ufMatch = fullText.match(/\bUF\s+([A-Z]{2})\b/i);
                            if (ufMatch) {
                                destino += `/${ufMatch[1].toUpperCase()}`;
                            }
                            
                            // ========== CEP ==========
                            const cepMatch = fullText.match(/CEP\s*(\d{2}\.?\d{3}-?\d{3})/i) || fullText.match(/(\d{2}\.\d{3}-\d{3})/);
                            if (cepMatch) {
                                destino += ` - CEP: ${cepMatch[1]}`;
                            }
                            
                            // ========== PRODUTOS ==========
                            const produtos = [];
                            
                            console.log('Produtos no estoque para busca:', stock.map(p => ({ sku: p.sku, name: p.name })));
                            
                            // Função auxiliar para encontrar produto no estoque
                            const encontrarProdutoEstoque = (sku, nome) => {
                                const skuOriginal = (sku || '').trim();
                                const skuNorm = skuOriginal.toLowerCase().replace(/[^a-z0-9]/g, '');
                                const nomeNorm = (nome || '').trim().toLowerCase();
                                
                                console.log('Buscando no estoque:', { skuOriginal, skuNorm, nomeNorm });
                                
                                const encontrado = stock.find(p => {
                                    const pSkuOriginal = (p.sku || '').trim();
                                    const pSku = pSkuOriginal.toLowerCase().replace(/[^a-z0-9]/g, '');
                                    const pNome = (p.name || '').trim().toLowerCase();
                                    
                                    // Comparação exata (case insensitive)
                                    if (pSkuOriginal.toLowerCase() === skuOriginal.toLowerCase()) {
                                        console.log('OK: Match exato SKU:', pSkuOriginal);
                                        return true;
                                    }
                                    
                                    // Comparação normalizada
                                    if (pSku && skuNorm && pSku === skuNorm) {
                                        console.log('OK: Match normalizado:', pSku, '=', skuNorm);
                                        return true;
                                    }
                                    
                                    // SKU contém ou é contido
                                    if (pSku.length >= 5 && skuNorm.length >= 5) {
                                        if (pSku.includes(skuNorm) || skuNorm.includes(pSku)) {
                                            console.log('OK: Match parcial:', pSku, 'vs', skuNorm);
                                            return true;
                                        }
                                    }
                                    
                                    return false;
                                });
                                
                                if (!encontrado) {
                                    console.log('ERRO: Nenhum match para:', skuOriginal);
                                }
                                
                                return encontrado;
                            };
                            
                            // Padrão DANFE: CÓDIGO + DESCRIÇÃO + NCM + CST + CFOP + UN + QUANT
                            // Exemplo: MLGR5RY5G1 Luminaria Pendente Moderna Minimalista Coco - 60cm 94051990 0102 6.102 UN 1,00
                            const prodPattern = /([A-Z0-9]{6,15})\s+([A-Za-záéíóúâêôãõçÁÉÍÓÚÂÊÔÃÕÇ0-9\s\-\.]+?)\s+(\d{8})\s+(\d{4})\s+(\d\.\d{3})\s+(UN|PC|PÇ|KG|CX|PCT|M2|M|LT)\s+(\d+[,.]?\d*)/gi;
                            
                            let match;
                            while ((match = prodPattern.exec(fullText)) !== null && produtos.length < 50) {
                                const sku = match[1].trim();
                                const nome = match[2].trim().replace(/\s+/g, ' ');
                                const qtd = parseFloat(match[7].replace(',', '.')) || 1;
                                
                                const produtoEncontrado = encontrarProdutoEstoque(sku, nome);
                                
                                produtos.push({
                                    sku: sku,
                                    nome: nome,
                                    quantidade: Math.round(qtd),
                                    ean: '',
                                    baixarEstoque: !!produtoEncontrado,
                                    produtoEstoque: produtoEncontrado || null,
                                    autoVinculado: !!produtoEncontrado
                                });
                            }
                            
                            // Se não encontrou produtos, tentar padrão alternativo
                            if (produtos.length === 0) {
                                const altPattern = /C[ÓO]DIGO\s+([A-Z0-9]+)\s+.*?DESCRI[ÇC][ÃA]O[^A-Z]*([A-Za-záéíóúâêôãõç\s\-]{5,60}).*?QUANT[^\d]*(\d+)/gi;
                                while ((match = altPattern.exec(fullText)) !== null && produtos.length < 50) {
                                    const sku = match[1].trim();
                                    const nome = match[2].trim();
                                    const produtoEncontrado = encontrarProdutoEstoque(sku, nome);
                                    
                                    produtos.push({
                                        sku: sku,
                                        nome: nome,
                                        quantidade: parseInt(match[3]) || 1,
                                        ean: '',
                                        baixarEstoque: !!produtoEncontrado,
                                        produtoEstoque: produtoEncontrado || null,
                                        autoVinculado: !!produtoEncontrado
                                    });
                                }
                            }
                            
                            console.log('Dados extraídos:', { nNF, xNome, destino, produtos });
                            
                            // Atualizar formulário
                            setForm(prevForm => ({
                                ...prevForm,
                                nfNumero: nNF,
                                cliente: xNome,
                                destino: destino.trim(),
                                produtos: produtos,
                                codigoRastreio: '',
                                linkRastreio: ''
                            }));
                            
                            setNfData({
                                type: 'pdf',
                                fileName: file.name,
                                nfNumero: nNF,
                                cliente: xNome,
                                destino: destino,
                                produtos: produtos
                            });
                            
                            // Mensagem de resultado
                            const vinculados = produtos.filter(p => p.autoVinculado).length;
                            let msg = `PDF processado!`;
                            if (nNF) msg += ` NF: ${nNF}.`;
                            if (xNome) msg += ` Cliente: ${xNome.substring(0, 20)}...`;
                            if (produtos.length > 0) msg += ` ${produtos.length} produto(s).`;
                            if (vinculados > 0) msg += ` ${vinculados} vinculado(s) ao estoque.`;
                            if (!nNF && !xNome && produtos.length === 0) {
                                msg = 'Não foi possível extrair todos os dados. Complete manualmente.';
                            }
                            
                            setSuccess(msg);
                            setActiveView('register');
                            setTimeout(() => setSuccess(''), 8000);
                            
                        } catch (err) {
                            console.error('Erro ao processar PDF:', err);
                            setError('Erro ao processar PDF. Tente usar o arquivo XML ou preencha manualmente.');
                            setNfData({ type: 'pdf', fileName: file.name });
                            setActiveView('register');
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    setError('Formato não suportado. Use XML ou PDF.');
                }
            };

            // Vincular produto da NF com estoque
            const handleVincularProduto = (index, skuEstoque) => {
                const newProdutos = [...form.produtos];
                // Busca case-insensitive
                const produtoEstoque = stock.find(p => 
                    (p.sku || '').toLowerCase() === (skuEstoque || '').toLowerCase()
                );
                newProdutos[index] = {
                    ...newProdutos[index],
                    produtoEstoque: produtoEstoque || null,
                    baixarEstoque: !!produtoEstoque
                };
                setForm({...form, produtos: newProdutos});
                
                if (produtoEstoque) {
                    console.log('Produto vinculado manualmente:', produtoEstoque.name);
                }
            };

            // Abrir modal para cadastrar novo produto
            const handleOpenNewProduct = (index) => {
                const prod = form.produtos[index];
                setNewProductData({
                    name: prod.nome || '',
                    sku: prod.sku || '',
                    ean: prod.ean || '',
                    category: categories[0]?.id || '',
                    minStock: 1,
                    observations: `Cadastrado via NF ${form.nfNumero}`
                });
                setShowNewProductModal(index);
            };

            // Cadastrar novo produto e vincular
            const handleCreateAndLinkProduct = async () => {
                if (!newProductData.name || !newProductData.sku || !newProductData.category) {
                    setError('Preencha nome, SKU e categoria');
                    return;
                }

                try {
                    const newProduct = await onAddProduct({
                        ...newProductData,
                        quantity: 0,
                        createdAt: new Date().toISOString()
                    });

                    // Atualizar o produto na lista para vincular ao novo cadastro
                    const newProdutos = [...form.produtos];
                    newProdutos[showNewProductModal] = {
                        ...newProdutos[showNewProductModal],
                        produtoEstoque: { ...newProductData, id: newProduct.id, currentQuantity: 0 },
                        baixarEstoque: false // Não baixar pois acabou de cadastrar (estoque zerado)
                    };
                    setForm({...form, produtos: newProdutos});

                    setShowNewProductModal(null);
                    setNewProductData({ name: '', sku: '', ean: '', category: '', minStock: 1, observations: '' });
                    setSuccess('Produto cadastrado e vinculado!');
                    setTimeout(() => setSuccess(''), 3000);
                } catch (err) {
                    setError('Erro ao cadastrar: ' + err.message);
                }
            };

            // Registrar despacho
            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');

                if (!form.nfNumero) {
                    setError('Informe o número da NF');
                    return;
                }

                try {
                    // Criar o despacho
                    const shippingData = {
                        nfNumero: form.nfNumero,
                        cliente: form.cliente,
                        destino: form.destino,
                        localOrigem: form.localOrigem,
                        transportadora: form.transportadora,
                        codigoRastreio: form.codigoRastreio,
                        linkRastreio: form.linkRastreio,
                        melhorEnvioId: form.melhorEnvioId || '',
                        produtos: form.produtos,
                        observacoes: form.observacoes,
                        status: 'PENDENTE'
                    };

                    const savedShipping = await onAdd(shippingData);
                    const shippingId = savedShipping?.id || null;

                    // Se marcado para baixar do estoque, registrar saídas
                    if (form.baixarEstoque && shippingId) {
                        const produtosComExit = [...shippingData.produtos];
                        let temExit = false;
                        for (let i = 0; i < form.produtos.length; i++) {
                            const prod = form.produtos[i];
                            if (prod.produtoEstoque && prod.baixarEstoque) {
                                try {
                                    const exitResult = await onAddExit({
                                        type: 'VENDA',
                                        sku: prod.produtoEstoque.sku,
                                        quantity: prod.quantidade,
                                        client: form.cliente,
                                        nf: form.nfNumero,
                                        nfOrigem: prod.nfOrigem || null,
                                    });
                                    if (exitResult?.id) {
                                        produtosComExit[i] = {
                                            ...produtosComExit[i],
                                            exitId: exitResult.id,
                                            baixouEstoque: true,
                                        };
                                        temExit = true;
                                    }
                                } catch (exitErr) {
                                    console.error('Erro exit:', prod.produtoEstoque.sku, exitErr);
                                }
                            }
                        }
                        if (temExit) {
                            try {
                                await onUpdate(shippingId, { produtos: produtosComExit });
                            } catch (updateErr) {
                                console.error('Erro ao atualizar JSONB com exitId:', updateErr);
                            }
                        }
                    } else if (form.baixarEstoque) {
                        // Fallback: shipping sem ID retornado — criar exits sem linkage
                        for (const prod of form.produtos) {
                            if (prod.produtoEstoque && prod.baixarEstoque) {
                                await onAddExit({
                                    type: 'VENDA',
                                    sku: prod.produtoEstoque.sku,
                                    quantity: prod.quantidade,
                                    client: form.cliente,
                                    nf: form.nfNumero,
                                    nfOrigem: prod.nfOrigem || null,
                                });
                            }
                        }
                    }

                    setSuccess('Despacho registrado com sucesso!');
                    setForm({
                        nfNumero: '', cliente: '', destino: '', localOrigem: locaisOrigem[0] || 'Loja Principal',
                        transportadora: '', codigoRastreio: '', linkRastreio: '', melhorEnvioId: '',
                        baixarEstoque: true, produtos: [], observacoes: ''
                    });
                    setNfFile(null);
                    setNfData(null);
                    setActiveView('list');
                    setTimeout(() => setSuccess(''), 3000);
                } catch (err) {
                    setError('Erro ao registrar: ' + err.message);
                }
            };

            // Atualizar status
            const handleUpdateStatus = async (shipping, newStatus) => {
                await onUpdate(shipping.id, { 
                    status: newStatus,
                    [`status_${newStatus}_date`]: new Date().toISOString()
                });
            };

            // Atualizar rastreio
            const handleUpdateRastreio = async (shipping, codigoRastreio, linkRastreio) => {
                await onUpdate(shipping.id, { codigoRastreio, linkRastreio });
                setEditingShipping(null);
            };

            // Gerar link de rastreio baseado na transportadora
            const gerarLinkRastreio = (transportadora, codigo) => {
                if (!codigo) return '';
                const links = {
                    'Correios': `https://rastreamento.correios.com.br/app/index.php?objetos=${codigo}`,
                    'Jadlog': `https://www.jadlog.com.br/jadlog/tracking?cte=${codigo}`,
                    'Total Express': `https://totalexpress.com.br/rastreamento/?codigo=${codigo}`,
                    'TNT': `https://radar.tntbrasil.com.br/radar/${codigo}`,
                };
                return links[transportadora] || '';
            };

            return (
                <div>
                    <div className="page-header">
                        <h1 className="page-title">Despachos</h1>
                        <p className="page-subtitle">Gerencie o envio de notas fiscais</p>
                    </div>

                    {success && <div className="alert alert-success">{success}</div>}
                    {error && <div className="alert alert-danger">{error}</div>}

                    {/* Modal de Gestão de Locais */}
                    {showLocaisModal && (
                        <LocaisModal 
                            locaisOrigem={locaisOrigem}
                            onUpdateLocais={onUpdateLocais}
                            onClose={() => setShowLocaisModal(false)}
                        />
                    )}

                    {/* Tabs */}
                    <div className="card" style={{marginBottom: '16px'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '12px'}}>
                            <div className="filter-tabs">
                                <button 
                                    className={`filter-tab ${activeView === 'list' ? 'active' : ''}`}
                                    onClick={() => setActiveView('list')}
                                >
                                    Lista ({shippings.length})
                                </button>
                                {isStockAdmin && (<button
                                    className={`filter-tab ${activeView === 'register' ? 'active' : ''}`}
                                    onClick={() => setActiveView('register')}
                                >
                                    Novo
                                </button>)}
                                {isStockAdmin && (<button
                                    className={`filter-tab ${activeView === 'import' ? 'active' : ''}`}
                                    onClick={() => setActiveView('import')}
                                >
                                    Importar NF
                                </button>)}
                                {isStockAdmin && (<button
                                    className={`filter-tab ${activeView === 'import-tiny' ? 'active' : ''}`}
                                    onClick={() => setActiveView('import-tiny')}
                                >
                                    Importar Tiny
                                </button>)}
                                {isStockAdmin && (<button
                                    className={`filter-tab ${activeView === 'csv' ? 'active' : ''}`}
                                    onClick={() => setActiveView('csv')}
                                >
                                    Importar CSV
                                </button>)}
                            </div>
                            <button
                                className="btn btn-secondary"
                                onClick={() => setShowLocaisModal(true)}
                                title="Configurar locais de origem"
                                style={{display: 'flex', alignItems: 'center', gap: '6px'}}
                            >
                                <Icon name="settings" size={14} />
                                <span>Locais de Origem</span>
                            </button>
                        </div>
                    </div>

                    {/* Lista de Despachos */}
                    {activeView === 'list' && (
                        <div className="card">
                            <div style={{display: 'flex', gap: '12px', marginBottom: '16px', flexWrap: 'wrap', alignItems: 'center'}}>
                                <div className="search-box" style={{flex: 1, minWidth: '200px', marginBottom: 0}}>
                                    <span className="search-icon"><Icon name="search" size={14} /></span>
                                    <input
                                        type="text"
                                        className="search-input"
                                        placeholder="Buscar por NF, cliente ou rastreio..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>
                                <button 
                                    className="btn btn-primary"
                                    onClick={atualizarTodosRastreios}
                                    disabled={atualizandoRastreio}
                                    style={{whiteSpace: 'nowrap'}}
                                >
                                    {atualizandoRastreio ? 'Atualizando...' : 'Atualizar Rastreios'}
                                </button>
                            </div>

                            <div className="filter-tabs" style={{marginBottom: '12px'}}>
                                <button className={`filter-tab ${statusFilter === 'all' ? 'active' : ''}`} onClick={() => setStatusFilter('all')}>
                                    Todos ({shippings.length})
                                </button>
                                {Object.entries(statusList).map(([key, val]) => (
                                    <button
                                        key={key}
                                        className={`filter-tab ${statusFilter === key ? 'active' : ''}`}
                                        onClick={() => setStatusFilter(key)}
                                    >
                                        {val.label} ({shippings.filter(s => s.status === key).length})
                                    </button>
                                ))}
                            </div>

                            <PeriodFilter
                                periodFilter={shipPeriodFilter} setPeriodFilter={setShipPeriodFilter}
                                customMonth={shipCustomMonth} setCustomMonth={setShipCustomMonth}
                                customYear={shipCustomYear} setCustomYear={setShipCustomYear}
                            />

                            {filteredShippings.length === 0 ? (
                                <div className="empty-state">
                                    <div className="empty-state-icon"><Icon name="shipping" size={48} /></div>
                                    <h3>Nenhum despacho encontrado</h3>
                                    <p>Importe uma NF ou cadastre manualmente</p>
                                </div>
                            ) : (
                                <div className="table-container">
                                    <table className="table">
                                        <thead>
                                            <tr>
                                                <th>NF</th>
                                                <th>Cliente</th>
                                                <th>Origem</th>
                                                <th>Transportadora</th>
                                                <th>Rastreio</th>
                                                <th>Status</th>
                                                {isStockAdmin && <th>Ações</th>}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredShippings.map(s => (
                                                <tr key={s.id}>
                                                    <td>
                                                        <strong>{s.nfNumero}</strong>
                                                        <div style={{fontSize: '10px', color: 'var(--text-muted)'}}>{formatDate(s.date)}</div>
                                                    </td>
                                                    <td>
                                                        {s.cliente}
                                                        {s.destino && <div style={{fontSize: '10px', color: 'var(--text-muted)'}}>{s.destino.substring(0, 30)}...</div>}
                                                    </td>
                                                    <td style={{fontSize: '12px'}}>{s.localOrigem}</td>
                                                    <td style={{fontSize: '12px'}}>{s.transportadora || '-'}</td>
                                                    <td>
                                                        {s.codigoRastreio ? (
                                                            <div>
                                                                <code style={{fontSize: '11px'}}>{s.codigoRastreio}</code>
                                                                {s.linkRastreio && (
                                                                    <a href={s.linkRastreio} target="_blank" rel="noopener noreferrer" 
                                                                       style={{marginLeft: '8px', fontSize: '11px'}}>
                                                                        Rastrear
                                                                    </a>
                                                                )}
                                                            </div>
                                                        ) : (
                                                            <button 
                                                                className="btn btn-secondary btn-sm"
                                                                onClick={() => setEditingShipping({...s})}
                                                                style={{fontSize: '11px', padding: '4px 8px'}}
                                                            >
                                                                + Adicionar
                                                            </button>
                                                        )}
                                                    </td>
                                                    <td>
                                                        <select
                                                            value={s.status}
                                                            onChange={(e) => handleUpdateStatus(s, e.target.value)}
                                                            style={{
                                                                background: statusList[s.status]?.bg,
                                                                color: statusList[s.status]?.color,
                                                                border: 'none',
                                                                borderRadius: '12px',
                                                                padding: '4px 8px',
                                                                fontSize: '11px',
                                                                fontWeight: '600',
                                                                cursor: 'pointer'
                                                            }}
                                                        >
                                                            {Object.entries(statusList).map(([key, val]) => (
                                                                <option key={key} value={key}>{val.label}</option>
                                                            ))}
                                                        </select>
                                                        {s.ultimaAtualizacaoRastreio && (
                                                            <div style={{fontSize: '9px', color: 'var(--text-muted)', marginTop: '2px'}}>
                                                                Atualizado: {formatDate(s.ultimaAtualizacaoRastreio)}
                                                            </div>
                                                        )}
                                                    </td>
                                                    <td>
                                                        <div style={{display: 'flex', gap: '4px'}}>
                                                            {(s.melhorEnvioId || s.transportadora === 'Melhor Envio') && (
                                                                <button 
                                                                    className="btn btn-icon btn-primary btn-sm" 
                                                                    onClick={() => atualizarRastreioMelhorEnvio(s)}
                                                                    disabled={atualizandoRastreio}
                                                                    title="Atualizar status via Melhor Envio"
                                                                    style={{fontSize: '10px'}}
                                                                >
                                                                    {atualizandoRastreio ? '...' : ''}
                                                                </button>
                                                            )}
                                                            {isStockAdmin && (<button
                                                                className="btn btn-icon btn-secondary btn-sm"
                                                                onClick={() => setEditingShipping({...s})}
                                                                title="Editar despacho"
                                                            ><Icon name="edit" size={14} /></button>)}
                                                            {isStockAdmin && (<button
                                                                className="btn btn-icon btn-secondary btn-sm"
                                                                onClick={() => {
                                                                    if(confirm('Excluir este despacho?')) onDelete(s.id);
                                                                }}
                                                                title="Excluir"
                                                            ><Icon name="delete" size={14} /></button>)}
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Modal Editar Despacho Completo */}
                    {editingShipping && (
                        <div className="modal-overlay">
                            <div className="modal-content" style={{maxWidth: '600px'}}>
                                <h2 className="modal-title">Editar Despacho</h2>
                                <p className="modal-subtitle">Atualize as informações do despacho</p>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">Número da NF</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            value={editingShipping.nfNumero || ''}
                                            onChange={(e) => setEditingShipping({...editingShipping, nfNumero: e.target.value})}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Cliente</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            value={editingShipping.cliente || ''}
                                            onChange={(e) => setEditingShipping({...editingShipping, cliente: e.target.value})}
                                        />
                                    </div>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Endereço de Destino</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={editingShipping.destino || ''}
                                        onChange={(e) => setEditingShipping({...editingShipping, destino: e.target.value})}
                                    />
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">Local de Origem</label>
                                        <select
                                            className="form-select"
                                            value={editingShipping.localOrigem || ''}
                                            onChange={(e) => setEditingShipping({...editingShipping, localOrigem: e.target.value})}
                                        >
                                            {locaisOrigem.map(l => <option key={l} value={l}>{l}</option>)}
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Transportadora</label>
                                        <select
                                            className="form-select"
                                            value={editingShipping.transportadora || ''}
                                            onChange={(e) => setEditingShipping({...editingShipping, transportadora: e.target.value})}
                                        >
                                            <option value="">Selecione...</option>
                                            {transportadoras.map(t => <option key={t} value={t}>{t}</option>)}
                                        </select>
                                    </div>
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">Código de Rastreio</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            value={editingShipping.codigoRastreio || ''}
                                            onChange={(e) => {
                                                const codigo = e.target.value;
                                                const link = gerarLinkRastreio(editingShipping.transportadora, codigo);
                                                setEditingShipping({...editingShipping, codigoRastreio: codigo, linkRastreio: link || editingShipping.linkRastreio});
                                            }}
                                            placeholder="Ex: AA123456789BR"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">ID Melhor Envio</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            value={editingShipping.melhorEnvioId || ''}
                                            onChange={(e) => setEditingShipping({...editingShipping, melhorEnvioId: e.target.value})}
                                            placeholder="UUID da etiqueta"
                                        />
                                    </div>
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">Link de Rastreio</label>
                                        <input
                                            type="url"
                                            className="form-input"
                                            value={editingShipping.linkRastreio || ''}
                                            onChange={(e) => setEditingShipping({...editingShipping, linkRastreio: e.target.value})}
                                            placeholder="https://..."
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Status</label>
                                        <select
                                            className="form-select"
                                            value={editingShipping.status || 'PENDENTE'}
                                            onChange={(e) => setEditingShipping({...editingShipping, status: e.target.value})}
                                        >
                                            {Object.entries(statusList).map(([key, val]) => (
                                                <option key={key} value={key}>{val.label}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Link de Rastreio</label>
                                    <input
                                        type="url"
                                        className="form-input"
                                        value={editingShipping.linkRastreio || ''}
                                        onChange={(e) => setEditingShipping({...editingShipping, linkRastreio: e.target.value})}
                                        placeholder="https://..."
                                    />
                                    <span className="form-help">Gerado automaticamente para transportadoras conhecidas</span>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Observações</label>
                                    <textarea
                                        className="form-textarea"
                                        value={editingShipping.observacoes || ''}
                                        onChange={(e) => setEditingShipping({...editingShipping, observacoes: e.target.value})}
                                        placeholder="Informações adicionais..."
                                    />
                                </div>

                                <div className="btn-group">
                                    <button 
                                        className="btn btn-primary" 
                                        onClick={async () => {
                                            await onUpdate(editingShipping.id, {
                                                nfNumero: editingShipping.nfNumero,
                                                cliente: editingShipping.cliente,
                                                destino: editingShipping.destino,
                                                localOrigem: editingShipping.localOrigem,
                                                transportadora: editingShipping.transportadora,
                                                codigoRastreio: editingShipping.codigoRastreio,
                                                linkRastreio: editingShipping.linkRastreio,
                                                melhorEnvioId: editingShipping.melhorEnvioId,
                                                status: editingShipping.status,
                                                observacoes: editingShipping.observacoes,
                                                updatedAt: new Date().toISOString()
                                            });
                                            setEditingShipping(null);
                                            setSuccess('Despacho atualizado com sucesso!');
                                            setTimeout(() => setSuccess(''), 3000);
                                        }}
                                    >
                                        Salvar Alterações
                                    </button>
                                    <button className="btn btn-secondary" onClick={() => setEditingShipping(null)}>Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Importar NF */}
                    {activeView === 'import' && (
                        <div className="card">
                            <h2 className="card-title">
                                <Icon name="download" size={16} className="card-title-icon" />
                                Importar Nota Fiscal
                            </h2>
                            
                            {/* Toggle modo de importação */}
                            <div className="filter-tabs" style={{marginBottom: '20px'}}>
                                <button 
                                    className={`filter-tab ${importMode === 'single' ? 'active' : ''}`}
                                    onClick={() => { setImportMode('single'); setBatchDespachos([]); setBatchFiles([]); }}
                                >
                                    Arquivo Único
                                </button>
                                <button 
                                    className={`filter-tab ${importMode === 'batch' ? 'active' : ''}`}
                                    onClick={() => { setImportMode('batch'); setNfFile(null); setNfData(null); }}
                                >
                                    Importação em Lote
                                </button>
                            </div>

                            {/* Modo arquivo único */}
                            {importMode === 'single' && (
                                <>
                                    <p style={{color: 'var(--text-muted)', marginBottom: '20px', fontSize: '13px'}}>
                                        Importe a NF em formato XML (dados extraídos automaticamente) ou PDF
                                    </p>

                                    <div style={{
                                        border: '2px dashed var(--border)',
                                        borderRadius: 'var(--radius-lg)',
                                        padding: '40px',
                                        textAlign: 'center',
                                        background: 'var(--bg-primary)'
                                    }}>
                                        <input
                                            type="file"
                                            accept=".xml,.pdf"
                                            onChange={handleFileUpload}
                                            style={{display: 'none'}}
                                            id="nf-upload"
                                        />
                                        <label htmlFor="nf-upload" style={{cursor: 'pointer'}}>
                                            <div style={{marginBottom: '16px', color: 'var(--text-light)'}}><Icon name="file" size={48} /></div>
                                            <div style={{fontWeight: '600', marginBottom: '8px'}}>Clique para selecionar arquivo</div>
                                            <div style={{fontSize: '12px', color: 'var(--text-muted)'}}>XML ou PDF</div>
                                        </label>
                                    </div>

                                    {nfFile && (
                                        <div style={{marginTop: '16px', padding: '12px', background: 'var(--success-light)', borderRadius: 'var(--radius)', fontSize: '13px'}}>
                                            Arquivo carregado: <strong>{nfFile.name}</strong>
                                        </div>
                                    )}
                                </>
                            )}

                            {/* Modo importação em lote */}
                            {importMode === 'batch' && (
                                <>
                                    <p style={{color: 'var(--text-muted)', marginBottom: '20px', fontSize: '13px'}}>
                                        Selecione múltiplos arquivos XML para importar de uma vez. Os dados serão extraídos automaticamente.
                                    </p>

                                    {batchDespachos.length === 0 ? (
                                        <div style={{
                                            border: '2px dashed var(--border)',
                                            borderRadius: 'var(--radius-lg)',
                                            padding: '40px',
                                            textAlign: 'center',
                                            background: 'var(--bg-primary)'
                                        }}>
                                            <input
                                                type="file"
                                                accept=".xml"
                                                multiple
                                                onChange={handleBatchUpload}
                                                style={{display: 'none'}}
                                                id="nf-batch-upload"
                                            />
                                            <label htmlFor="nf-batch-upload" style={{cursor: 'pointer'}}>
                                                <div style={{marginBottom: '16px'}}><Icon name="file" size={48} /></div>
                                                <div style={{fontWeight: '600', marginBottom: '8px'}}>Clique para selecionar múltiplos arquivos</div>
                                                <div style={{fontSize: '12px', color: 'var(--text-muted)'}}>
                                                    Apenas XML • Segure Ctrl para selecionar vários
                                                </div>
                                            </label>
                                        </div>
                                    ) : (
                                        <>
                                            {/* Resumo e ações */}
                                            <div style={{
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'center',
                                                marginBottom: '16px',
                                                padding: '12px',
                                                background: 'var(--bg-primary)',
                                                borderRadius: 'var(--radius)'
                                            }}>
                                                <div>
                                                    <strong>{batchDespachos.filter(d => d.selected && !d.error).length}</strong> de {batchDespachos.filter(d => !d.error).length} selecionados
                                                    <span style={{marginLeft: '12px', fontSize: '12px', color: 'var(--text-muted)'}}>
                                                        ({batchDespachos.filter(d => d.error).length} com erro)
                                                    </span>
                                                </div>
                                                <div style={{display: 'flex', gap: '8px'}}>
                                                    <button 
                                                        className="btn btn-secondary btn-sm"
                                                        onClick={toggleSelectAll}
                                                    >
                                                        {batchDespachos.filter(d => !d.error).every(d => d.selected) ? 'Desmarcar todos' : 'Selecionar todos'}
                                                    </button>
                                                    <button 
                                                        className="btn btn-secondary btn-sm"
                                                        onClick={() => { setBatchDespachos([]); setBatchFiles([]); }}
                                                    >
                                                        <Icon name="delete" size={14} /> Limpar
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Tabela de despachos em lote */}
                                            <div className="table-container" style={{maxHeight: '400px', overflowY: 'auto'}}>
                                                <table className="table">
                                                    <thead style={{position: 'sticky', top: 0, background: 'white'}}>
                                                        <tr>
                                                            <th style={{width: '40px'}}><Icon name="check" size={14} /></th>
                                                            <th>NF / Arquivo</th>
                                                            <th>Cliente</th>
                                                            <th>Produtos</th>
                                                            <th>Transportadora</th>
                                                            <th style={{width: '80px'}}>Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {batchDespachos.map((d, idx) => (
                                                            <tr key={idx} style={{
                                                                background: d.error ? 'var(--danger-light)' : (d.selected ? 'var(--success-light)' : 'white'),
                                                                opacity: d.error ? 0.7 : 1
                                                            }}>
                                                                <td style={{textAlign: 'center'}}>
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={d.selected}
                                                                        disabled={!!d.error}
                                                                        onChange={() => toggleBatchSelection(idx)}
                                                                        style={{width: '18px', height: '18px'}}
                                                                    />
                                                                </td>
                                                                <td>
                                                                    <input
                                                                        type="text"
                                                                        className="form-input"
                                                                        value={d.nfNumero || ''}
                                                                        onChange={(e) => editarDespachoBatch(idx, 'nfNumero', e.target.value)}
                                                                        disabled={!!d.error}
                                                                        style={{fontSize: '12px', padding: '4px 8px', marginBottom: '4px'}}
                                                                    />
                                                                    <div style={{fontSize: '10px', color: 'var(--text-muted)'}}>{d.fileName}</div>
                                                                </td>
                                                                <td>
                                                                    <input
                                                                        type="text"
                                                                        className="form-input"
                                                                        value={d.cliente || ''}
                                                                        onChange={(e) => editarDespachoBatch(idx, 'cliente', e.target.value)}
                                                                        disabled={!!d.error}
                                                                        style={{fontSize: '12px', padding: '4px 8px'}}
                                                                        placeholder="Nome do cliente"
                                                                    />
                                                                </td>
                                                                <td style={{fontSize: '12px'}}>
                                                                    {d.error ? (
                                                                        <span style={{color: 'var(--danger)'}}>{d.error}</span>
                                                                    ) : (
                                                                        <span>
                                                                            {d.total} item(s)
                                                                            {d.vinculados > 0 && (
                                                                                <span style={{color: 'var(--success)', marginLeft: '4px'}}>
                                                                                    ({d.vinculados})
                                                                                </span>
                                                                            )}
                                                                        </span>
                                                                    )}
                                                                </td>
                                                                <td>
                                                                    <select
                                                                        className="form-select"
                                                                        value={d.transportadora || ''}
                                                                        onChange={(e) => editarDespachoBatch(idx, 'transportadora', e.target.value)}
                                                                        disabled={!!d.error}
                                                                        style={{fontSize: '11px', padding: '4px'}}
                                                                    >
                                                                        <option value="">Selecionar...</option>
                                                                        {transportadoras.map(t => <option key={t} value={t}>{t}</option>)}
                                                                    </select>
                                                                </td>
                                                                <td style={{textAlign: 'center'}}>
                                                                    {d.error ? (
                                                                        <span className="badge badge-danger">Erro</span>
                                                                    ) : d.selected ? (
                                                                        <span className="badge badge-success">Pronto</span>
                                                                    ) : (
                                                                        <span className="badge" style={{background: 'var(--border)'}}>—</span>
                                                                    )}
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>

                                            {/* Botão salvar em lote */}
                                            <div style={{marginTop: '20px', display: 'flex', gap: '12px', justifyContent: 'flex-end'}}>
                                                <button 
                                                    className="btn btn-secondary"
                                                    onClick={() => { setBatchDespachos([]); setBatchFiles([]); }}
                                                >
                                                    Cancelar
                                                </button>
                                                <button 
                                                    className="btn btn-primary"
                                                    onClick={salvarDespachosLote}
                                                    disabled={processingBatch || batchDespachos.filter(d => d.selected && !d.error).length === 0}
                                                >
                                                    {processingBatch ? (
                                                        `Salvando ${batchProgress.current}/${batchProgress.total}...`
                                                    ) : (
                                                        `Salvar ${batchDespachos.filter(d => d.selected && !d.error).length} Despacho(s)`
                                                    )}
                                                </button>
                                            </div>
                                        </>
                                    )}

                                    {/* Progress bar durante processamento */}
                                    {processingBatch && (
                                        <div style={{marginTop: '16px'}}>
                                            <div style={{
                                                height: '8px',
                                                background: 'var(--border)',
                                                borderRadius: '4px',
                                                overflow: 'hidden'
                                            }}>
                                                <div style={{
                                                    width: `${(batchProgress.current / batchProgress.total) * 100}%`,
                                                    height: '100%',
                                                    background: 'var(--accent)',
                                                    transition: 'width 0.3s'
                                                }} />
                                            </div>
                                            <p style={{fontSize: '12px', color: 'var(--text-muted)', marginTop: '8px', textAlign: 'center'}}>
                                                Processando {batchProgress.current} de {batchProgress.total}...
                                            </p>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    )}

                    {/* Importar do Tiny */}
                    {activeView === 'import-tiny' && (
                        <TinyNFeImport
                            products={products || []}
                            onSubmitEntry={onAddEntry}
                            onSubmitExit={onAddExit}
                            onAddProduct={onAddProduct}
                            categories={categories}
                            locaisOrigem={locaisOrigem}
                            onUpdateLocais={onUpdateLocais}
                            entries={entries || []}
                            exits={exits || []}
                            stock={stock || []}
                            mode="exit"
                            onAddCategory={onAddCategory}
                            onUpdateCategory={onUpdateCategory}
                            onDeleteCategory={onDeleteCategory}
                        />
                    )}

                    {/* Importar CSV */}
                    {activeView === 'csv' && (
                        <CSVImportTab
                            type="shipping"
                            products={products}
                            onImportShipping={onAdd}
                            locaisOrigem={locaisOrigem}
                            onUpdateLocais={onUpdateLocais}
                        />
                    )}

                    {/* Registrar Despacho */}
                    {activeView === 'register' && (
                        <div className="card">
                            <h2 className="card-title">
                                <Icon name="edit" size={16} className="card-title-icon" />
                                {nfData ? 'Confirmar Dados do Despacho' : 'Cadastrar Despacho Manual'}
                            </h2>

                            <form onSubmit={handleSubmit}>
                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">Número da NF *</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            value={form.nfNumero}
                                            onChange={(e) => setForm({...form, nfNumero: e.target.value})}
                                            required
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Cliente</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            value={form.cliente}
                                            onChange={(e) => setForm({...form, cliente: e.target.value})}
                                        />
                                    </div>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Endereço de Destino</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={form.destino}
                                        onChange={(e) => setForm({...form, destino: e.target.value})}
                                        placeholder="Rua, número - Cidade/UF"
                                    />
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">Local de Origem</label>
                                        <select
                                            className="form-select"
                                            value={form.localOrigem}
                                            onChange={(e) => setForm({...form, localOrigem: e.target.value})}
                                        >
                                            {locaisOrigem.map(l => <option key={l} value={l}>{l}</option>)}
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Transportadora</label>
                                        <select
                                            className="form-select"
                                            value={form.transportadora}
                                            onChange={(e) => setForm({...form, transportadora: e.target.value})}
                                        >
                                            <option value="">Selecione...</option>
                                            {transportadoras.map(t => <option key={t} value={t}>{t}</option>)}
                                        </select>
                                    </div>
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">Código de Rastreio</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            value={form.codigoRastreio}
                                            onChange={(e) => {
                                                const codigo = e.target.value;
                                                const link = gerarLinkRastreio(form.transportadora, codigo);
                                                setForm({...form, codigoRastreio: codigo, linkRastreio: link || form.linkRastreio});
                                            }}
                                            placeholder="Ex: AA123456789BR"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Link de Rastreio</label>
                                        <input
                                            type="url"
                                            className="form-input"
                                            value={form.linkRastreio}
                                            onChange={(e) => setForm({...form, linkRastreio: e.target.value})}
                                            placeholder="https://..."
                                        />
                                    </div>
                                </div>

                                {/* Campo ID Melhor Envio */}
                                {form.transportadora === 'Melhor Envio' && (
                                    <div className="form-group" style={{
                                        background: 'var(--info-light)',
                                        padding: '16px',
                                        borderRadius: 'var(--radius)',
                                        marginBottom: '16px'
                                    }}>
                                        <label className="form-label" style={{color: 'var(--info)'}}>
                                            ID da Etiqueta (Melhor Envio)
                                        </label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            value={form.melhorEnvioId || ''}
                                            onChange={(e) => setForm({...form, melhorEnvioId: e.target.value})}
                                            placeholder="Ex: 9b3e8f7a-1234-5678-90ab-cdef12345678"
                                        />
                                        <p style={{fontSize: '11px', color: 'var(--text-muted)', marginTop: '6px'}}>
                                            Encontre o ID no painel do Melhor Envio → Envios → Copiar ID da etiqueta. 
                                            Com o ID, o sistema atualiza o status automaticamente!
                                        </p>
                                    </div>
                                )}

                                {/* Opção de baixar do estoque */}
                                <div style={{
                                    background: 'var(--bg-primary)',
                                    padding: '16px',
                                    borderRadius: 'var(--radius)',
                                    marginBottom: '16px'
                                }}>
                                    <label style={{display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer'}}>
                                        <input
                                            type="checkbox"
                                            checked={form.baixarEstoque}
                                            onChange={(e) => setForm({...form, baixarEstoque: e.target.checked})}
                                            style={{width: '18px', height: '18px'}}
                                        />
                                        <span style={{fontWeight: '500'}}>Baixar produtos do estoque</span>
                                    </label>
                                    <p style={{fontSize: '11px', color: 'var(--text-muted)', marginTop: '6px', marginLeft: '28px'}}>
                                        Se marcado, os produtos vinculados serão descontados do estoque automaticamente
                                    </p>
                                </div>

                                {/* Produtos (se importados do XML) */}
                                {form.produtos.length > 0 && (
                                    <div style={{marginBottom: '16px'}}>
                                        <h3 style={{fontSize: '14px', fontWeight: '600', marginBottom: '12px'}}>
                                            Produtos da NF ({form.produtos.length})
                                            <span style={{fontWeight: '400', fontSize: '12px', marginLeft: '12px', color: 'var(--text-muted)'}}>
                                                {form.produtos.filter(p => p.produtoEstoque).length} vinculados |
                                                {form.produtos.filter(p => !p.produtoEstoque).length} não encontrados
                                            </span>
                                        </h3>
                                        <div className="table-container">
                                            <table className="table">
                                                <thead>
                                                    <tr>
                                                        <th style={{width: '50px'}}>Status</th>
                                                        <th>Produto NF</th>
                                                        <th style={{width: '60px'}}>Qtd</th>
                                                        <th>Produto Vinculado</th>
                                                        <th style={{width: '140px'}}>NF Origem</th>
                                                        <th style={{width: '80px'}}>Ações</th>
                                                        <th style={{width: '60px'}}>Baixar</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {form.produtos.map((prod, idx) => (
                                                        <tr key={idx} style={{
                                                            background: prod.produtoEstoque ? 'var(--success-light)' : 'var(--warning-light)'
                                                        }}>
                                                            <td style={{textAlign: 'center', fontSize: '18px'}}>
                                                                {prod.produtoEstoque ? (
                                                                    <span title="Vinculado ao estoque" style={{color: 'var(--success)'}}><Icon name="success" size={14} /></span>
                                                                ) : (
                                                                    <span title="Não encontrado no estoque" style={{color: 'var(--warning)'}}><Icon name="warning" size={14} /></span>
                                                                )}
                                                            </td>
                                                            <td>
                                                                <div style={{fontWeight: '500', fontSize: '12px'}}>{prod.nome}</div>
                                                                <div style={{fontSize: '10px', color: 'var(--text-muted)', marginTop: '2px'}}>
                                                                    SKU: <strong>{prod.sku}</strong> {prod.ean && `| EAN: ${prod.ean}`}
                                                                </div>
                                                            </td>
                                                            <td style={{fontWeight: '600', textAlign: 'center'}}>{prod.quantidade}</td>
                                                            <td>
                                                                {prod.produtoEstoque ? (
                                                                    <div style={{fontSize: '12px'}}>
                                                                        <div style={{fontWeight: '500', color: 'var(--success)'}}>{prod.produtoEstoque.name}</div>
                                                                        <div style={{fontSize: '10px', color: 'var(--text-muted)'}}>
                                                                            SKU: {prod.produtoEstoque.sku} | Estoque: {prod.produtoEstoque.currentQuantity || 0} un.
                                                                        </div>
                                                                    </div>
                                                                ) : (
                                                                    <span style={{fontSize: '11px', color: 'var(--text-muted)', fontStyle: 'italic'}}>
                                                                        Nenhum produto vinculado
                                                                    </span>
                                                                )}
                                                            </td>
                                                            {/* Coluna NF Origem */}
                                                            <td>
                                                                {prod.produtoEstoque && (() => {
                                                                    const nfsDisponiveis = getEstoquePorNF(prod.produtoEstoque.sku);
                                                                    return nfsDisponiveis.length > 0 ? (
                                                                        <select
                                                                            className="form-select"
                                                                            value={prod.nfOrigem || ''}
                                                                            onChange={(e) => {
                                                                                const newProdutos = [...form.produtos];
                                                                                newProdutos[idx].nfOrigem = e.target.value;
                                                                                setForm({...form, produtos: newProdutos});
                                                                            }}
                                                                            style={{
                                                                                fontSize: '10px',
                                                                                padding: '4px 6px',
                                                                                minWidth: '100px',
                                                                                background: prod.nfOrigem ? 'var(--accent-bg)' : 'white'
                                                                            }}
                                                                        >
                                                                            <option value="">Selecionar...</option>
                                                                            {nfsDisponiveis.map((nf, nfIdx) => (
                                                                                <option 
                                                                                    key={nfIdx} 
                                                                                    value={nf.nf} 
                                                                                    disabled={nf.quantidade < prod.quantidade}
                                                                                >
                                                                                    {nf.nf} ({nf.quantidade}un)
                                                                                </option>
                                                                            ))}
                                                                        </select>
                                                                    ) : (
                                                                        <span style={{fontSize: '10px', color: 'var(--danger)'}}>Sem estoque</span>
                                                                    );
                                                                })()}
                                                            </td>
                                                            <td style={{textAlign: 'center'}}>
                                                                <div style={{display: 'flex', gap: '4px', justifyContent: 'center'}}>
                                                                    <button
                                                                        type="button"
                                                                        className="btn btn-secondary btn-sm"
                                                                        style={{fontSize: '10px', padding: '4px 6px'}}
                                                                        onClick={() => {
                                                                            setShowVincularModal(idx);
                                                                            setVincularSearch(prod.sku || prod.nome?.substring(0, 20) || '');
                                                                        }}
                                                                        title="Buscar e vincular produto"
                                                                    >
                                                                        <Icon name="search" size={12} />
                                                                    </button>
                                                                    {!prod.produtoEstoque && (
                                                                        <button
                                                                            type="button"
                                                                            className="btn btn-primary btn-sm"
                                                                            style={{fontSize: '10px', padding: '4px 6px'}}
                                                                            onClick={() => handleOpenNewProduct(idx)}
                                                                            title="Cadastrar novo produto"
                                                                        >
                                                                            <Icon name="add" size={12} />
                                                                        </button>
                                                                    )}
                                                                    {prod.produtoEstoque && (
                                                                        <button
                                                                            type="button"
                                                                            className="btn btn-secondary btn-sm"
                                                                            style={{fontSize: '10px', padding: '4px 6px'}}
                                                                            onClick={() => handleVincularProduto(idx, '')}
                                                                            title="Desvincular"
                                                                        >
                                                                            <Icon name="close" size={12} />
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            </td>
                                                            <td style={{textAlign: 'center'}}>
                                                                {prod.produtoEstoque && (
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={prod.baixarEstoque}
                                                                        onChange={(e) => {
                                                                            const newProdutos = [...form.produtos];
                                                                            newProdutos[idx].baixarEstoque = e.target.checked;
                                                                            setForm({...form, produtos: newProdutos});
                                                                        }}
                                                                        title={prod.produtoEstoque.currentQuantity >= prod.quantidade ? 
                                                                            'Baixar do estoque' : 
                                                                            'Estoque insuficiente!'}
                                                                        style={{
                                                                            width: '18px', 
                                                                            height: '18px',
                                                                            accentColor: prod.produtoEstoque.currentQuantity >= prod.quantidade ? 'var(--accent)' : 'var(--danger)'
                                                                        }}
                                                                    />
                                                                )}
                                                                {prod.produtoEstoque && prod.produtoEstoque.currentQuantity < prod.quantidade && (
                                                                    <div style={{fontSize: '9px', color: 'var(--danger)'}}>
                                                                        Insuficiente!
                                                                    </div>
                                                                )}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                {/* Modal Buscar e Vincular Produto */}
                                {showVincularModal !== null && (
                                    <div className="modal-overlay">
                                        <div className="modal-content" style={{maxWidth: '600px'}}>
                                            <h2 className="modal-title">Vincular Produto do Estoque</h2>
                                            <p className="modal-subtitle">
                                                Produto da NF: <strong>{form.produtos[showVincularModal]?.nome}</strong>
                                            </p>
                                            <div style={{fontSize: '11px', color: 'var(--text-muted)', marginBottom: '16px'}}>
                                                SKU da NF: <code>{form.produtos[showVincularModal]?.sku}</code>
                                            </div>

                                            <div className="form-group">
                                                <label className="form-label">Buscar no estoque</label>
                                                <input
                                                    type="text"
                                                    className="form-input"
                                                    placeholder="Digite nome, SKU ou EAN..."
                                                    value={vincularSearch}
                                                    onChange={(e) => setVincularSearch(e.target.value)}
                                                    autoFocus
                                                />
                                            </div>

                                            <div style={{
                                                maxHeight: '300px',
                                                overflowY: 'auto',
                                                border: '1px solid var(--border)',
                                                borderRadius: 'var(--radius)',
                                                marginBottom: '16px'
                                            }}>
                                                {stock
                                                    .filter(s => {
                                                        if (!vincularSearch) return true;
                                                        const search = vincularSearch.toLowerCase();
                                                        return (s.name || '').toLowerCase().includes(search) ||
                                                               (s.sku || '').toLowerCase().includes(search) ||
                                                               (s.ean || '').toLowerCase().includes(search);
                                                    })
                                                    .map(s => (
                                                        <div
                                                            key={s.id}
                                                            onClick={() => {
                                                                handleVincularProduto(showVincularModal, s.sku);
                                                                setShowVincularModal(null);
                                                                setVincularSearch('');
                                                            }}
                                                            style={{
                                                                padding: '12px',
                                                                borderBottom: '1px solid var(--border)',
                                                                cursor: 'pointer',
                                                                transition: 'background 0.2s'
                                                            }}
                                                            onMouseEnter={(e) => e.target.style.background = 'var(--bg-primary)'}
                                                            onMouseLeave={(e) => e.target.style.background = 'white'}
                                                        >
                                                            <div style={{fontWeight: '500', marginBottom: '4px'}}>{s.name}</div>
                                                            <div style={{fontSize: '11px', color: 'var(--text-muted)'}}>
                                                                SKU: <strong>{s.sku}</strong>
                                                                {s.ean && ` | EAN: ${s.ean}`}
                                                                {' | '}
                                                                <span style={{
                                                                    color: s.currentQuantity > 0 ? 'var(--success)' : 'var(--danger)'
                                                                }}>
                                                                    Estoque: {s.currentQuantity || 0} un.
                                                                </span>
                                                            </div>
                                                        </div>
                                                    ))
                                                }
                                                {stock.filter(s => {
                                                    if (!vincularSearch) return true;
                                                    const search = vincularSearch.toLowerCase();
                                                    return (s.name || '').toLowerCase().includes(search) ||
                                                           (s.sku || '').toLowerCase().includes(search);
                                                }).length === 0 && (
                                                    <div style={{padding: '20px', textAlign: 'center', color: 'var(--text-muted)'}}>
                                                        Nenhum produto encontrado
                                                    </div>
                                                )}
                                            </div>

                                            <div className="btn-group">
                                                <button 
                                                    type="button"
                                                    className="btn btn-secondary" 
                                                    onClick={() => {
                                                        setShowVincularModal(null);
                                                        setVincularSearch('');
                                                    }}
                                                >
                                                    Cancelar
                                                </button>
                                                <button 
                                                    type="button"
                                                    className="btn btn-primary" 
                                                    onClick={() => {
                                                        handleOpenNewProduct(showVincularModal);
                                                        setShowVincularModal(null);
                                                        setVincularSearch('');
                                                    }}
                                                >
                                                    Cadastrar Novo Produto
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Modal Cadastrar Novo Produto */}
                                {showNewProductModal !== null && (
                                    <div className="modal-overlay">
                                        <div className="modal-content">
                                            <h2 className="modal-title">Cadastrar Novo Produto</h2>
                                            <p className="modal-subtitle">
                                                Produto da NF: {form.produtos[showNewProductModal]?.nome?.substring(0, 50)}
                                            </p>

                                            <div className="form-group">
                                                <label className="form-label">Nome do Produto *</label>
                                                <input
                                                    type="text"
                                                    className="form-input"
                                                    value={newProductData.name}
                                                    onChange={(e) => setNewProductData({...newProductData, name: e.target.value})}
                                                />
                                            </div>

                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label className="form-label">SKU *</label>
                                                    <input
                                                        type="text"
                                                        className="form-input"
                                                        value={newProductData.sku}
                                                        onChange={(e) => setNewProductData({...newProductData, sku: e.target.value})}
                                                    />
                                                </div>
                                                <div className="form-group">
                                                    <label className="form-label">EAN</label>
                                                    <input
                                                        type="text"
                                                        className="form-input"
                                                        value={newProductData.ean}
                                                        onChange={(e) => setNewProductData({...newProductData, ean: e.target.value})}
                                                    />
                                                </div>
                                            </div>

                                            <div className="form-row">
                                                <CategorySelectInline
                                                    categories={categories}
                                                    value={newProductData.category}
                                                    onChange={(val) => setNewProductData({...newProductData, category: val})}
                                                    onAddCategory={onAddCategory}
                                                    onUpdateCategory={onUpdateCategory}
                                                    onDeleteCategory={onDeleteCategory}
                                                    products={stock}
                                                />
                                                <div className="form-group">
                                                    <label className="form-label">Estoque Mínimo</label>
                                                    <input
                                                        type="number"
                                                        className="form-input"
                                                        value={newProductData.minStock}
                                                        onChange={(e) => setNewProductData({...newProductData, minStock: parseInt(e.target.value) || 1})}
                                                        min="0"
                                                    />
                                                </div>
                                            </div>

                                            <div className="form-group">
                                                <label className="form-label">Observações</label>
                                                <textarea
                                                    className="form-textarea"
                                                    value={newProductData.observations}
                                                    onChange={(e) => setNewProductData({...newProductData, observations: e.target.value})}
                                                />
                                            </div>

                                            <div style={{
                                                background: 'var(--warning-light)',
                                                padding: '12px',
                                                borderRadius: 'var(--radius)',
                                                marginBottom: '16px',
                                                fontSize: '12px'
                                            }}>
                                                O produto será cadastrado com <strong>estoque zerado</strong>.
                                                Para dar entrada, use a aba "Entrada" após o cadastro.
                                            </div>

                                            <div className="btn-group">
                                                <button 
                                                    type="button"
                                                    className="btn btn-primary" 
                                                    onClick={handleCreateAndLinkProduct}
                                                >
                                                    Cadastrar e Vincular
                                                </button>
                                                <button 
                                                    type="button"
                                                    className="btn btn-secondary" 
                                                    onClick={() => setShowNewProductModal(null)}
                                                >
                                                    Cancelar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <div className="form-group">
                                    <label className="form-label">Observações</label>
                                    <textarea
                                        className="form-textarea"
                                        value={form.observacoes}
                                        onChange={(e) => setForm({...form, observacoes: e.target.value})}
                                        placeholder="Informações adicionais..."
                                    />
                                </div>

                                <div className="btn-group">
                                    <button type="submit" className="btn btn-primary">Registrar Despacho</button>
                                    <button type="button" className="btn btn-secondary" onClick={() => {
                                        setActiveView('list');
                                        setNfFile(null);
                                        setNfData(null);
                                    }}>Cancelar</button>
                                </div>
                            </form>
                        </div>
                    )}
                </div>
            );
        }

        // ==========================================
        // IMPORT HUB (Com importação em lote e local de entrada)
        // ==========================================
        function ImportHub({ products, onImport, onAddProduct, categories, locaisOrigem, onUpdateLocais, entries, exits, stock, onAddEntry, onAddExit }) {
            const [activeImport, setActiveImport] = useState('nfe');

            return (
                <div>
                    <div className="page-header">
                        <h1 className="page-title">Importar</h1>
                        <p className="page-subtitle">Importe dados de NF-e, Excel ou CSV</p>
                    </div>

                    <div className="card">
                        <div className="filter-tabs">
                            <button className={`filter-tab ${activeImport === 'tiny' ? 'active' : ''}`} onClick={() => setActiveImport('tiny')}>
                                Tiny ERP
                            </button>
                            <button className={`filter-tab ${activeImport === 'nfe' ? 'active' : ''}`} onClick={() => setActiveImport('nfe')}>
                                NF-e XML
                            </button>
                            <button className={`filter-tab ${activeImport === 'nfe-batch' ? 'active' : ''}`} onClick={() => setActiveImport('nfe-batch')}>
                                NF-e em Lote
                            </button>
                            <button className={`filter-tab ${activeImport === 'excel' ? 'active' : ''}`} onClick={() => setActiveImport('excel')}>
                                Excel/CSV
                            </button>
                        </div>
                    </div>

                    {activeImport === 'tiny' && (
                        <TinyNFeImport
                            products={products}
                            onSubmitEntry={onAddEntry}
                            onSubmitExit={onAddExit}
                            onAddProduct={onAddProduct}
                            categories={categories}
                            locaisOrigem={locaisOrigem}
                            onUpdateLocais={onUpdateLocais}
                            entries={entries || []}
                            exits={exits || []}
                            stock={stock || []}
                            mode="entry"
                        />
                    )}
                    {activeImport === 'nfe' && <ImportNFe products={products} onImport={onImport} onAddProduct={onAddProduct} categories={categories} locaisOrigem={locaisOrigem} onUpdateLocais={onUpdateLocais} />}
                    {activeImport === 'nfe-batch' && <ImportNFeBatch products={products} onImport={onImport} onAddProduct={onAddProduct} categories={categories} locaisOrigem={locaisOrigem} onUpdateLocais={onUpdateLocais} />}
                    {activeImport === 'excel' && <ImportExcel products={products} onImport={onImport} locaisOrigem={locaisOrigem} onUpdateLocais={onUpdateLocais} />}
                </div>
            );
        }

        // ==========================================
        // IMPORT NFE BATCH (Importação em Lote)
        // ==========================================
        function ImportNFeBatch({ products, onImport, onAddProduct, categories, locaisOrigem, onUpdateLocais }) {
            const [batchFiles, setBatchFiles] = useState([]);
            const [batchData, setBatchData] = useState([]);
            const [processing, setProcessing] = useState(false);
            const [progress, setProgress] = useState({ current: 0, total: 0 });
            const [localEntrada, setLocalEntrada] = useState(locaisOrigem?.[0] || 'Loja Principal');
            const [success, setSuccess] = useState('');
            const [error, setError] = useState('');
            const [showLocaisModal, setShowLocaisModal] = useState(false);

            // Processar arquivo XML
            const processarXML = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const parser = new DOMParser();
                            const xml = parser.parseFromString(event.target.result, 'text/xml');
                            const ns = 'http://www.portalfiscal.inf.br/nfe';

                            const getNsValue = (parent, tag) => {
                                const el = parent?.getElementsByTagNameNS(ns, tag)[0] || parent?.getElementsByTagName(tag)[0];
                                return el?.textContent || '';
                            };

                            const ide = xml.getElementsByTagNameNS(ns, 'ide')[0] || xml.getElementsByTagName('ide')[0];
                            const emit = xml.getElementsByTagNameNS(ns, 'emit')[0] || xml.getElementsByTagName('emit')[0];
                            const dets = xml.getElementsByTagNameNS(ns, 'det').length > 0 
                                ? xml.getElementsByTagNameNS(ns, 'det') 
                                : xml.getElementsByTagName('det');

                            const nfNumero = getNsValue(ide, 'nNF');
                            const fornecedor = getNsValue(emit, 'xNome');

                            const items = [];
                            for (let det of dets) {
                                const prod = det.getElementsByTagNameNS(ns, 'prod')[0] || det.getElementsByTagName('prod')[0];
                                const codigo = getNsValue(prod, 'cProd');
                                const ean = getNsValue(prod, 'cEAN');
                                const descricao = getNsValue(prod, 'xProd');
                                const quantidade = parseFloat(getNsValue(prod, 'qCom')) || 1;

                                // Tentar vincular automaticamente
                                const produtoEstoque = products.find(p => 
                                    p.sku?.toLowerCase() === codigo?.toLowerCase() ||
                                    (ean && p.ean === ean)
                                );

                                items.push({
                                    codigo,
                                    ean: (ean && ean !== 'SEM GTIN') ? ean : '',
                                    descricao,
                                    quantidade: Math.round(quantidade),
                                    vinculado: produtoEstoque?.sku || '',
                                    produtoEstoque,
                                    autoVinculado: !!produtoEstoque
                                });
                            }

                            resolve({
                                fileName: file.name,
                                nfNumero,
                                fornecedor,
                                items,
                                selected: true,
                                vinculados: items.filter(i => i.autoVinculado).length,
                                total: items.length
                            });
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
                    reader.readAsText(file, 'UTF-8');
                });
            };

            // Upload de múltiplos arquivos
            const handleBatchUpload = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                setBatchFiles(files);
                setProcessing(true);
                setProgress({ current: 0, total: files.length });
                setError('');
                setSuccess('');

                const resultados = [];

                for (let i = 0; i < files.length; i++) {
                    setProgress({ current: i + 1, total: files.length });

                    try {
                        if (files[i].name.toLowerCase().endsWith('.xml')) {
                            const dados = await processarXML(files[i]);
                            resultados.push(dados);
                        } else {
                            resultados.push({
                                fileName: files[i].name,
                                error: 'Formato não suportado (use XML)',
                                selected: false
                            });
                        }
                    } catch (err) {
                        resultados.push({
                            fileName: files[i].name,
                            error: err.message,
                            selected: false
                        });
                    }
                }

                setBatchData(resultados);
                setProcessing(false);

                const sucessos = resultados.filter(r => !r.error).length;
                const erros = resultados.filter(r => r.error).length;
                setSuccess(`${sucessos} arquivo(s) processado(s)${erros > 0 ? `, ${erros} com erro` : ''}`);
            };

            // Toggle seleção
            const toggleSelection = (idx) => {
                const newData = [...batchData];
                newData[idx].selected = !newData[idx].selected;
                setBatchData(newData);
            };

            // Selecionar todos
            const toggleSelectAll = () => {
                const allSelected = batchData.filter(d => !d.error).every(d => d.selected);
                setBatchData(batchData.map(d => d.error ? d : { ...d, selected: !allSelected }));
            };

            // Atualizar vinculação
            const updateVinculo = (nfIdx, itemIdx, sku) => {
                const newData = [...batchData];
                const produtoEstoque = products.find(p => p.sku === sku);
                newData[nfIdx].items[itemIdx].vinculado = sku;
                newData[nfIdx].items[itemIdx].produtoEstoque = produtoEstoque;
                newData[nfIdx].vinculados = newData[nfIdx].items.filter(i => i.vinculado).length;
                setBatchData(newData);
            };

            // Importar todas selecionadas
            const handleImportAll = async () => {
                const selecionadas = batchData.filter(d => d.selected && !d.error);
                if (selecionadas.length === 0) {
                    setError('Selecione ao menos uma NF para importar');
                    return;
                }

                setProcessing(true);
                setProgress({ current: 0, total: selecionadas.length });
                
                let importados = 0;
                let erros = 0;

                for (let i = 0; i < selecionadas.length; i++) {
                    const nf = selecionadas[i];
                    setProgress({ current: i + 1, total: selecionadas.length });

                    for (const item of nf.items) {
                        if (!item.vinculado) continue;

                        try {
                            await onImport({
                                type: 'COMPRA',
                                sku: item.vinculado,
                                quantity: item.quantidade,
                                supplier: nf.fornecedor,
                                nf: nf.nfNumero,
                                localEntrada: localEntrada
                            });
                            importados++;
                        } catch (err) {
                            erros++;
                        }
                    }
                }

                setProcessing(false);
                setSuccess(`Importação concluída! ${importados} entrada(s) registrada(s)${erros > 0 ? `, ${erros} erro(s)` : ''}`);
                setBatchData([]);
                setBatchFiles([]);
            };

            return (
                <div className="card">
                    <h2 className="card-title">
                        <Icon name="clipboard" size={16} className="card-title-icon" />
                        Importar NF-e em Lote
                    </h2>

                    {success && <div className="alert alert-success">{success}</div>}
                    {error && <div className="alert alert-danger">{error}</div>}

                    {/* Seleção de local */}
                    <div className="form-group" style={{marginBottom: '20px'}}>
                        <label className="form-label">Local de Entrada *</label>
                        <div style={{display: 'flex', gap: '8px'}}>
                            <select 
                                className="form-select" 
                                value={localEntrada} 
                                onChange={(e) => setLocalEntrada(e.target.value)}
                                style={{flex: 1}}
                            >
                                {(locaisOrigem || ['Loja Principal']).map((local, idx) => (
                                    <option key={idx} value={local}>{local}</option>
                                ))}
                            </select>
                            <button 
                                type="button"
                                className="btn btn-secondary"
                                onClick={() => setShowLocaisModal(true)}
                                title="Gerenciar depósitos"
                                style={{padding: '8px 12px'}}
                            >
                                <Icon name="settings" size={14} />
                            </button>
                        </div>
                        <span className="form-help">Todos os produtos importados serão registrados neste local</span>
                    </div>

                    {/* Modal Gerenciar Locais */}
                    {showLocaisModal && (
                        <LocaisModal 
                            locaisOrigem={locaisOrigem}
                            onUpdateLocais={onUpdateLocais}
                            onClose={() => setShowLocaisModal(false)}
                        />
                    )}

                    {batchData.length === 0 ? (
                        <div style={{
                            border: '2px dashed var(--border)',
                            borderRadius: 'var(--radius-lg)',
                            padding: '40px',
                            textAlign: 'center',
                            background: 'var(--bg-primary)'
                        }}>
                            <input
                                type="file"
                                accept=".xml"
                                multiple
                                onChange={handleBatchUpload}
                                style={{display: 'none'}}
                                id="nf-batch-import"
                            />
                            <label htmlFor="nf-batch-import" style={{cursor: 'pointer'}}>
                                <div style={{marginBottom: '16px'}}><Icon name="file" size={48} /></div>
                                <div style={{fontWeight: '600', marginBottom: '8px'}}>Clique para selecionar múltiplos arquivos XML</div>
                                <div style={{fontSize: '12px', color: 'var(--text-muted)'}}>
                                    Segure Ctrl para selecionar vários arquivos
                                </div>
                            </label>
                        </div>
                    ) : (
                        <>
                            {/* Barra de progresso */}
                            {processing && (
                                <div style={{marginBottom: '16px'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '8px'}}>
                                        <span>Processando...</span>
                                        <span>{progress.current} de {progress.total}</span>
                                    </div>
                                    <div style={{background: 'var(--border)', borderRadius: '10px', height: '8px'}}>
                                        <div style={{
                                            background: 'var(--accent)',
                                            borderRadius: '10px',
                                            height: '100%',
                                            width: `${(progress.current / progress.total) * 100}%`,
                                            transition: 'width 0.3s'
                                        }}></div>
                                    </div>
                                </div>
                            )}

                            {/* Resumo */}
                            <div style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                marginBottom: '16px',
                                padding: '12px',
                                background: 'var(--bg-primary)',
                                borderRadius: 'var(--radius)'
                            }}>
                                <div>
                                    <strong>{batchData.filter(d => d.selected && !d.error).length}</strong> de {batchData.filter(d => !d.error).length} selecionadas
                                </div>
                                <div style={{display: 'flex', gap: '8px'}}>
                                    <button className="btn btn-secondary btn-sm" onClick={toggleSelectAll}>
                                        {batchData.filter(d => !d.error).every(d => d.selected) ? 'Desmarcar' : 'Selecionar'} todas
                                    </button>
                                    <button className="btn btn-secondary btn-sm" onClick={() => { setBatchData([]); setBatchFiles([]); }}>
                                        <Icon name="delete" size={14} /> Limpar
                                    </button>
                                </div>
                            </div>

                            {/* Lista de NFs */}
                            <div style={{maxHeight: '500px', overflowY: 'auto', marginBottom: '16px'}}>
                                {batchData.map((nf, nfIdx) => (
                                    <div key={nfIdx} style={{
                                        border: '1px solid var(--border)',
                                        borderRadius: 'var(--radius)',
                                        marginBottom: '12px',
                                        background: nf.error ? 'var(--danger-light)' : nf.selected ? 'var(--success-light)' : 'white',
                                        opacity: nf.error ? 0.7 : 1
                                    }}>
                                        {/* Header da NF */}
                                        <div style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            padding: '12px',
                                            borderBottom: nf.error ? 'none' : '1px solid var(--border)',
                                            gap: '12px'
                                        }}>
                                            <input
                                                type="checkbox"
                                                checked={nf.selected}
                                                disabled={!!nf.error}
                                                onChange={() => toggleSelection(nfIdx)}
                                                style={{width: '18px', height: '18px'}}
                                            />
                                            <div style={{flex: 1}}>
                                                <div style={{fontWeight: '600'}}>
                                                    {nf.error ? 'Erro -' : ''} NF: {nf.nfNumero || nf.fileName}
                                                </div>
                                                <div style={{fontSize: '12px', color: 'var(--text-muted)'}}>
                                                    {nf.error ? nf.error : `${nf.fornecedor} • ${nf.vinculados}/${nf.total} vinculados`}
                                                </div>
                                            </div>
                                            {!nf.error && (
                                                <span style={{
                                                    background: nf.vinculados === nf.total ? 'var(--success-light)' : 'var(--warning-light)',
                                                    color: nf.vinculados === nf.total ? 'var(--success)' : 'var(--warning)',
                                                    padding: '4px 10px',
                                                    borderRadius: '12px',
                                                    fontSize: '11px',
                                                    fontWeight: '600'
                                                }}>
                                                    {nf.vinculados}/{nf.total}
                                                </span>
                                            )}
                                        </div>

                                        {/* Items da NF */}
                                        {!nf.error && nf.selected && (
                                            <div style={{padding: '12px'}}>
                                                <table className="table" style={{marginBottom: 0}}>
                                                    <thead>
                                                        <tr>
                                                            <th>Produto NF</th>
                                                            <th style={{width: '60px'}}>Qtd</th>
                                                            <th style={{width: '250px'}}>Vincular a</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {nf.items.map((item, itemIdx) => (
                                                            <tr key={itemIdx}>
                                                                <td>
                                                                    <div style={{fontWeight: '500'}}>{item.descricao?.substring(0, 40)}</div>
                                                                    <div style={{fontSize: '10px', color: 'var(--text-muted)'}}>Cód: {item.codigo}</div>
                                                                </td>
                                                                <td>{item.quantidade}</td>
                                                                <td>
                                                                    <select
                                                                        className="form-select"
                                                                        value={item.vinculado}
                                                                        onChange={(e) => updateVinculo(nfIdx, itemIdx, e.target.value)}
                                                                        style={{
                                                                            fontSize: '12px',
                                                                            background: item.vinculado ? 'var(--success-light)' : 'white'
                                                                        }}
                                                                    >
                                                                        <option value="">Selecionar...</option>
                                                                        {products.map(p => (
                                                                            <option key={p.id} value={p.sku}>{p.name}</option>
                                                                        ))}
                                                                    </select>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>

                            {/* Botão de importar */}
                            <div className="btn-group">
                                <button 
                                    className="btn btn-success" 
                                    onClick={handleImportAll}
                                    disabled={processing || batchData.filter(d => d.selected && !d.error).length === 0}
                                >
                                    {processing ? 'Importando...' : 'Importar Selecionadas'}
                                </button>
                            </div>
                        </>
                    )}
                </div>
            );
        }

        function ImportNFe({ products, onImport, onAddProduct, categories, locaisOrigem, onUpdateLocais }) {
            const [nfeData, setNfeData] = useState(null);
            const [productMapping, setProductMapping] = useState({});
            const [showNewProductModal, setShowNewProductModal] = useState(false);
            const [newProductIndex, setNewProductIndex] = useState(null);
            const [newProductData, setNewProductData] = useState({ name: '', sku: '', ean: '', category: '' });
            const [localEntrada, setLocalEntrada] = useState(locaisOrigem?.[0] || 'Loja Principal');
            const [showLocaisModal, setShowLocaisModal] = useState(false);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const parser = new DOMParser();
                        const xml = parser.parseFromString(event.target.result, 'text/xml');
                        const ns = 'http://www.portalfiscal.inf.br/nfe';

                        const getNsValue = (parent, tag) => {
                            const el = parent.getElementsByTagNameNS(ns, tag)[0] || parent.getElementsByTagName(tag)[0];
                            return el?.textContent || '';
                        };

                        const ide = xml.getElementsByTagNameNS(ns, 'ide')[0] || xml.getElementsByTagName('ide')[0];
                        const emit = xml.getElementsByTagNameNS(ns, 'emit')[0] || xml.getElementsByTagName('emit')[0];
                        const dets = xml.getElementsByTagNameNS(ns, 'det').length > 0 
                            ? xml.getElementsByTagNameNS(ns, 'det') 
                            : xml.getElementsByTagName('det');

                        const items = [];
                        for (let det of dets) {
                            const prod = det.getElementsByTagNameNS(ns, 'prod')[0] || det.getElementsByTagName('prod')[0];
                            items.push({
                                codigo: getNsValue(prod, 'cProd'),
                                ean: getNsValue(prod, 'cEAN'),
                                descricao: getNsValue(prod, 'xProd'),
                                quantidade: parseFloat(getNsValue(prod, 'qCom')) || 1
                            });
                        }

                        setNfeData({
                            numero: getNsValue(ide, 'nNF'),
                            fornecedor: getNsValue(emit, 'xNome'),
                            items
                        });

                        const mapping = {};
                        items.forEach((item, idx) => {
                            const found = products.find(p => p.ean === item.ean || p.sku === item.codigo);
                            mapping[idx] = found?.sku || '';
                        });
                        setProductMapping(mapping);

                    } catch (err) {
                        alert('Erro ao ler XML: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };

            const updateProductMapping = (index, value) => {
                if (value === '__NEW__') {
                    setNewProductIndex(index);
                    setNewProductData({
                        name: nfeData.items[index].descricao,
                        sku: nfeData.items[index].codigo,
                        ean: nfeData.items[index].ean,
                        category: ''
                    });
                    setShowNewProductModal(true);
                } else {
                    setProductMapping({...productMapping, [index]: value});
                }
            };

            const handleCreateNewProduct = async () => {
                if (!newProductData.name || !newProductData.sku || !newProductData.category) return;

                await onAddProduct({
                    name: newProductData.name,
                    sku: newProductData.sku,
                    ean: newProductData.ean || '',
                    category: newProductData.category,
                    quantity: 0
                });

                setProductMapping({...productMapping, [newProductIndex]: newProductData.sku});
                setShowNewProductModal(false);
                setNewProductIndex(null);
            };

            const handleImport = async () => {
                for (let i = 0; i < nfeData.items.length; i++) {
                    const item = nfeData.items[i];
                    const sku = productMapping[i];
                    if (!sku) continue;

                    await onImport({
                        type: 'COMPRA',
                        sku,
                        quantity: Math.round(item.quantidade),
                        supplier: nfeData.fornecedor,
                        nf: nfeData.numero,
                        localEntrada: localEntrada
                    });
                }
                alert('Importação concluída!');
                setNfeData(null);
            };

            return (
                <div className="card">
                    {/* Modal Novo Produto */}
                    {showNewProductModal && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h2 className="modal-title">Cadastrar Novo Produto</h2>
                                <p className="modal-subtitle">Dados extraídos da NF-e</p>

                                <div className="form-group">
                                    <label className="form-label">Nome</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={newProductData.name}
                                        onChange={(e) => setNewProductData({...newProductData, name: e.target.value})}
                                    />
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">SKU</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            value={newProductData.sku}
                                            onChange={(e) => setNewProductData({...newProductData, sku: e.target.value})}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">EAN</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            value={newProductData.ean}
                                            onChange={(e) => setNewProductData({...newProductData, ean: e.target.value})}
                                        />
                                    </div>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Categoria *</label>
                                    <select
                                        className="form-select"
                                        value={newProductData.category}
                                        onChange={(e) => setNewProductData({...newProductData, category: e.target.value})}
                                    >
                                        <option value="">Selecione...</option>
                                        {categories.map(cat => (
                                            <option key={cat.id} value={cat.id}>{cat.name}</option>
                                        ))}
                                    </select>
                                </div>

                                <div className="btn-group">
                                    <button className="btn btn-success" onClick={handleCreateNewProduct}>Cadastrar</button>
                                    <button className="btn btn-secondary" onClick={() => setShowNewProductModal(false)}>Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <h2 className="card-title">
                        <Icon name="file" size={16} className="card-title-icon" />
                        Importar NF-e (XML)
                    </h2>

                    <div className="form-group">
                        <label className="form-label">Local de Entrada *</label>
                        <div style={{display: 'flex', gap: '8px'}}>
                            <select 
                                className="form-select" 
                                value={localEntrada} 
                                onChange={(e) => setLocalEntrada(e.target.value)}
                                style={{flex: 1}}
                            >
                                {(locaisOrigem || ['Loja Principal']).map((local, idx) => (
                                    <option key={idx} value={local}>{local}</option>
                                ))}
                            </select>
                            <button 
                                type="button"
                                className="btn btn-secondary"
                                onClick={() => setShowLocaisModal(true)}
                                title="Gerenciar depósitos"
                                style={{padding: '8px 12px'}}
                            >
                                <Icon name="settings" size={14} />
                            </button>
                        </div>
                        <span className="form-help">Selecione o depósito onde os produtos serão armazenados</span>
                    </div>

                    {/* Modal Gerenciar Locais */}
                    {showLocaisModal && (
                        <LocaisModal 
                            locaisOrigem={locaisOrigem}
                            onUpdateLocais={onUpdateLocais}
                            onClose={() => setShowLocaisModal(false)}
                        />
                    )}

                    <div className="form-group">
                        <label className="form-label">Arquivo XML da NF-e</label>
                        <input type="file" className="form-input" accept=".xml" onChange={handleFileUpload} />
                    </div>

                    {nfeData && (
                        <div>
                            <div style={{background: 'var(--bg-primary)', padding: '12px', borderRadius: 'var(--radius)', marginBottom: '16px'}}>
                                <strong>NF:</strong> {nfeData.numero} | <strong>Fornecedor:</strong> {nfeData.fornecedor}
                            </div>

                            <div className="table-container">
                                <table className="table">
                                    <thead>
                                        <tr>
                                            <th>Produto NF-e</th>
                                            <th>Qtd</th>
                                            <th>Vincular a</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {nfeData.items.map((item, idx) => (
                                            <tr key={idx}>
                                                <td>
                                                    <div style={{fontWeight: '500'}}>{item.descricao.substring(0, 40)}...</div>
                                                    <div style={{fontSize: '11px', color: 'var(--text-muted)'}}>Código: {item.codigo}</div>
                                                </td>
                                                <td>{item.quantidade}</td>
                                                <td>
                                                    <select
                                                        className="form-select"
                                                        value={productMapping[idx] || ''}
                                                        onChange={(e) => updateProductMapping(idx, e.target.value)}
                                                        style={{minWidth: '200px'}}
                                                    >
                                                        <option value="">Selecionar...</option>
                                                        <option value="__NEW__" style={{fontWeight: '600'}}>+ Criar novo produto</option>
                                                        <optgroup label="Produtos">
                                                            {products.map(p => <option key={p.id} value={p.sku}>{p.name}</option>)}
                                                        </optgroup>
                                                    </select>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            <div className="btn-group">
                                <button className="btn btn-success" onClick={handleImport}>Importar Entrada</button>
                                <button className="btn btn-secondary" onClick={() => setNfeData(null)}>Cancelar</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function ImportExcel({ products, onImport, locaisOrigem, onUpdateLocais }) {
            const [data, setData] = useState(null);
            const [localEntrada, setLocalEntrada] = useState(locaisOrigem?.[0] || 'Loja Principal');
            const [showLocaisModal, setShowLocaisModal] = useState(false);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.name.endsWith('.csv')) {
                    Papa.parse(file, {
                        header: true,
                        complete: (results) => setData(results.data.filter(r => r.sku))
                    });
                } else {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const wb = XLSX.read(event.target.result, {type: 'binary'});
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(ws);
                        setData(json.filter(r => r.sku));
                    };
                    reader.readAsBinaryString(file);
                }
            };

            const handleImport = async () => {
                for (let row of data) {
                    if (!row.sku || !row.quantidade) continue;
                    if (!products.find(p => p.sku === row.sku)) continue;

                    await onImport({
                        type: 'COMPRA',
                        sku: row.sku,
                        quantity: parseInt(row.quantidade),
                        supplier: row.fornecedor || '',
                        nf: row.nf || '',
                        localEntrada: row.local || localEntrada
                    });
                }
                alert('Importação concluída!');
                setData(null);
            };

            return (
                <div className="card">
                    <h2 className="card-title">
                        <Icon name="chart" size={16} className="card-title-icon" />
                        Importar Excel/CSV
                    </h2>

                    <div style={{background: 'var(--bg-primary)', padding: '12px', borderRadius: 'var(--radius)', marginBottom: '16px', fontSize: '12px'}}>
                        <strong>Colunas obrigatórias:</strong> sku, quantidade<br/>
                        <strong>Colunas opcionais:</strong> fornecedor, nf, local
                    </div>

                    <div className="form-group">
                        <label className="form-label">Local de Entrada Padrão *</label>
                        <div style={{display: 'flex', gap: '8px'}}>
                            <select 
                                className="form-select" 
                                value={localEntrada} 
                                onChange={(e) => setLocalEntrada(e.target.value)}
                                style={{flex: 1}}
                            >
                                {(locaisOrigem || ['Loja Principal']).map((local, idx) => (
                                    <option key={idx} value={local}>{local}</option>
                                ))}
                            </select>
                            <button 
                                type="button"
                                className="btn btn-secondary"
                                onClick={() => setShowLocaisModal(true)}
                                title="Gerenciar depósitos"
                                style={{padding: '8px 12px'}}
                            >
                                <Icon name="settings" size={14} />
                            </button>
                        </div>
                        <span className="form-help">Usado quando a planilha não tiver coluna "local"</span>
                    </div>

                    {/* Modal Gerenciar Locais */}
                    {showLocaisModal && (
                        <LocaisModal 
                            locaisOrigem={locaisOrigem}
                            onUpdateLocais={onUpdateLocais}
                            onClose={() => setShowLocaisModal(false)}
                        />
                    )}

                    <div className="form-group">
                        <label className="form-label">Arquivo Excel ou CSV</label>
                        <input type="file" className="form-input" accept=".xlsx,.xls,.csv" onChange={handleFileUpload} />
                    </div>

                    {data && data.length > 0 && (
                        <div>
                            <p style={{marginBottom: '12px', fontSize: '13px'}}>{data.length} linha(s) encontrada(s)</p>
                            <div className="btn-group">
                                <button className="btn btn-success" onClick={handleImport}>Importar</button>
                                <button className="btn btn-secondary" onClick={() => setData(null)}>Cancelar</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ==========================================
        // TINY NF-e IMPORT (Buscar → Revisar → Confirmar)
        // ==========================================
        function TinyNFeImport({ products, onSubmitEntry, onSubmitExit, onAddProduct, categories, locaisOrigem, onUpdateLocais, entries, exits, stock, mode, onAddCategory, onUpdateCategory, onDeleteCategory }) {
            const [nfNumber, setNfNumber] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [nfeData, setNfeData] = useState(null); // { numero, tipo, cliente, dataEmissao, itens }
            const [itemStates, setItemStates] = useState([]); // per-item edit state
            const [showVincularModal, setShowVincularModal] = useState(null);
            const [vincularSearch, setVincularSearch] = useState('');
            const [showNewProductModal, setShowNewProductModal] = useState(null);
            const [newProductData, setNewProductData] = useState({ name: '', sku: '', ean: '', category: '', observations: '' });
            const [saving, setSaving] = useState(false);
            const [showInlineCatForm, setShowInlineCatForm] = useState(false);
            const [newCatName, setNewCatName] = useState('');
            const [newCatColor, setNewCatColor] = useState('#7A7585');

            const isEntry = mode === 'entry' || (mode === 'both' && nfeData?.tipo === 'E');
            const isExit = mode === 'exit' || (mode === 'both' && nfeData?.tipo === 'S');

            // Normalizar chave de NF: null, '', 'Sem NF', 'SEM_NF' → 'SEM_NF'
            const normalizeNfKey = (nf) => {
                if (!nf || nf === 'Sem NF' || nf === 'SEM_NF') return 'SEM_NF';
                return nf;
            };

            // Calcular estoque disponível por NF de entrada (FIFO)
            const getEstoquePorNF = (produtoSku) => {
                if (!produtoSku || !entries || !exits) return [];

                const entradasProduto = entries
                    .filter(e => e.sku === produtoSku)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                const saidasProduto = exits.filter(e => e.sku === produtoSku);

                const saidasComNF = saidasProduto.filter(s =>
                    s.nfOrigem && s.nfOrigem !== 'Sem NF' && s.nfOrigem !== 'SEM_NF'
                );
                const saidasSemNF = saidasProduto.filter(s =>
                    !s.nfOrigem || s.nfOrigem === 'Sem NF' || s.nfOrigem === 'SEM_NF'
                );

                const porNF = {};
                entradasProduto.forEach(e => {
                    const nfKey = normalizeNfKey(e.nf);
                    if (!porNF[nfKey]) {
                        porNF[nfKey] = {
                            nf: e.nf || 'Sem NF',
                            entradas: 0,
                            saidas: 0,
                            data: e.date,
                            localEntrada: e.localEntrada || '-'
                        };
                    }
                    porNF[nfKey].entradas += (e.quantity || 0);
                });

                saidasComNF.forEach(s => {
                    const nfKey = normalizeNfKey(s.nfOrigem);
                    if (porNF[nfKey]) {
                        porNF[nfKey].saidas += (s.quantity || 0);
                    }
                });

                let saidasRestantes = saidasSemNF.reduce((sum, s) => sum + (s.quantity || 0), 0);
                const nfKeys = Object.keys(porNF).sort((a, b) =>
                    new Date(porNF[a].data) - new Date(porNF[b].data)
                );

                for (const nfKey of nfKeys) {
                    if (saidasRestantes <= 0) break;
                    const disponivel = porNF[nfKey].entradas - porNF[nfKey].saidas;
                    const descontar = Math.min(disponivel, saidasRestantes);
                    porNF[nfKey].saidas += descontar;
                    saidasRestantes -= descontar;
                }

                return Object.values(porNF)
                    .map(item => ({
                        ...item,
                        quantidade: item.entradas - item.saidas
                    }))
                    .filter(item => item.quantidade > 0);
            };

            const fetchNFe = async () => {
                if (!nfNumber.trim()) { setError('Informe o número da NF.'); return; }
                setLoading(true);
                setError('');
                setSuccess('');
                setNfeData(null);
                try {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (!session) throw new Error('Sessão expirada. Faça login novamente.');
                    const resp = await fetch(`${SUPABASE_URL}/functions/v1/tiny-sync-nfe`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${session.access_token}`,
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                        },
                        body: JSON.stringify({ action: 'fetch', nf_number: nfNumber.trim() }),
                    });
                    if (!resp.ok) {
                        const err = await resp.json().catch(() => ({}));
                        throw new Error(err.error || `Erro ${resp.status}`);
                    }
                    const data = await resp.json();
                    if (!data.notas || data.notas.length === 0) {
                        setError(`Nenhuma NF-e encontrada com número ${nfNumber}.`);
                        return;
                    }
                    const nfe = data.notas[0];
                    setNfeData(nfe);

                    // Build per-item states with auto-linking
                    const states = (nfe.itens || []).map(item => {
                        const matched = products.find(p =>
                            (p.sku || '').toLowerCase() === (item.codigo || '').toLowerCase() ||
                            (p.ean && p.ean === item.codigo)
                        );
                        const nfStr = String(nfe.numero);
                        const alreadyInEntries = entries.some(e => e.nf === nfStr && (e.sku === item.codigo || (matched && e.sku === matched.sku)));
                        const alreadyInExits = exits.some(e => e.nf === nfStr && (e.sku === item.codigo || (matched && e.sku === matched.sku)));
                        const alreadyRegistered = alreadyInEntries || alreadyInExits;

                        const isExitNfe = mode === 'exit' || (mode === 'both' && nfe.tipo === 'S');
                        return {
                            selected: !alreadyRegistered,
                            linkedSku: matched?.sku || '',
                            linkedProduct: matched || null,
                            quantity: Math.round(item.quantidade) || 1,
                            localEntrada: locaisOrigem?.[0] || 'Loja Principal',
                            observations: '',
                            category: matched?.category || '',
                            alreadyRegistered,
                            baixarEstoque: !!matched && isExitNfe,
                            nfOrigem: '',
                        };
                    });
                    setItemStates(states);
                } catch (e) {
                    setError(e.message);
                } finally {
                    setLoading(false);
                }
            };

            const updateItemState = (idx, updates) => {
                setItemStates(prev => prev.map((s, i) => i === idx ? { ...s, ...updates } : s));
            };

            const handleVincular = (idx, sku) => {
                const prod = products.find(p => (p.sku || '').toLowerCase() === (sku || '').toLowerCase());
                updateItemState(idx, {
                    linkedSku: sku,
                    linkedProduct: prod || null,
                    baixarEstoque: !!prod && isExit,
                    nfOrigem: '',
                });
                setShowVincularModal(null);
                setVincularSearch('');
            };

            const handleCreateProduct = async () => {
                if (!newProductData.name || !newProductData.sku || !newProductData.category) {
                    setError('Preencha nome, SKU e categoria do novo produto.');
                    return;
                }
                try {
                    await onAddProduct({
                        name: newProductData.name.trim(),
                        sku: newProductData.sku.trim(),
                        ean: newProductData.ean?.trim() || '',
                        category: newProductData.category,
                        observations: newProductData.observations?.trim() || '',
                        quantity: 0,
                        createdAt: new Date().toISOString(),
                    });
                    const idx = showNewProductModal;
                    updateItemState(idx, {
                        linkedSku: newProductData.sku.trim(),
                        linkedProduct: { name: newProductData.name.trim(), sku: newProductData.sku.trim() },
                        baixarEstoque: isExit,
                        nfOrigem: '',
                    });
                    setShowNewProductModal(null);
                    setNewProductData({ name: '', sku: '', ean: '', category: '', observations: '' });
                } catch (e) {
                    setError('Erro ao cadastrar produto: ' + e.message);
                }
            };

            const handleInlineCreateCategory = async () => {
                if (!newCatName.trim() || !onAddCategory) return;
                const id = newCatName.trim().toLowerCase().replace(/[^a-z0-9]+/g, '_');
                await onAddCategory({ id, name: newCatName.trim(), icon: 'catSquare', color: newCatColor });
                setNewCatName('');
                setShowInlineCatForm(false);
            };

            const handleConfirm = async () => {
                const selectedItems = itemStates
                    .map((s, i) => ({ ...s, item: nfeData.itens[i], index: i }))
                    .filter(s => s.selected && s.linkedSku);

                if (selectedItems.length === 0) {
                    setError('Selecione ao menos um item com produto vinculado.');
                    return;
                }

                // Validar quantidades vs estoque disponível por NF de origem
                if (isExit) {
                    for (const s of selectedItems) {
                        if (s.baixarEstoque && s.nfOrigem) {
                            const nfsDisponiveis = getEstoquePorNF(s.linkedSku);
                            const nfSel = nfsDisponiveis.find(n => n.nf === s.nfOrigem);
                            if (nfSel && s.quantity > nfSel.quantidade) {
                                setError(`Produto ${s.linkedSku}: quantidade (${s.quantity}) excede disponível na NF ${s.nfOrigem} (${nfSel.quantidade}un)`);
                                return;
                            }
                        }
                    }
                }

                setSaving(true);
                setError('');
                let count = 0;
                try {
                    for (const s of selectedItems) {
                        if (isEntry || (mode === 'both' && nfeData.tipo === 'E')) {
                            await onSubmitEntry({
                                type: 'COMPRA',
                                sku: s.linkedSku,
                                quantity: s.quantity,
                                supplier: nfeData.cliente?.nome || '',
                                nf: String(nfeData.numero),
                                localEntrada: s.localEntrada || '',
                                observations: s.observations || '',
                                category: s.category || '',
                            });
                        } else {
                            const nfOrigemValue = (s.baixarEstoque && s.nfOrigem && s.nfOrigem !== 'Sem NF' && s.nfOrigem !== 'SEM_NF')
                                ? s.nfOrigem : null;
                            await onSubmitExit({
                                type: 'VENDA',
                                sku: s.linkedSku,
                                quantity: s.quantity,
                                client: nfeData.cliente?.nome || '',
                                nf: String(nfeData.numero),
                                nfOrigem: nfOrigemValue,
                            });
                        }
                        count++;
                    }
                    setSuccess(`${count} item(ns) registrado(s) com sucesso!`);
                    setNfeData(null);
                    setItemStates([]);
                    setNfNumber('');
                    setTimeout(() => setSuccess(''), 5000);
                } catch (e) {
                    setError('Erro ao registrar: ' + e.message);
                } finally {
                    setSaving(false);
                }
            };

            const sortedProducts = [...products].sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            return (
                <div style={{marginBottom: '24px'}}>
                    {/* Search bar */}
                    <div style={{display: 'flex', gap: '8px', alignItems: 'end', marginBottom: '16px'}}>
                        <div style={{flex: 1}}>
                            <label className="form-label">Número da NF (Tiny ERP)</label>
                            <input
                                type="text"
                                className="form-input"
                                placeholder="Ex: 2305"
                                value={nfNumber}
                                onChange={e => setNfNumber(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && fetchNFe()}
                            />
                        </div>
                        <button className="btn btn-primary" onClick={fetchNFe} disabled={loading} style={{whiteSpace: 'nowrap'}}>
                            {loading ? 'Buscando...' : 'Buscar no Tiny'}
                        </button>
                    </div>

                    {error && <div className="alert alert-danger" style={{marginBottom: '12px'}}>{error}</div>}
                    {success && <div className="alert alert-success" style={{marginBottom: '12px'}}>{success}</div>}

                    {/* NF-e Preview */}
                    {nfeData && (
                        <div style={{border: '1px solid var(--border)', borderRadius: 'var(--radius-md)', overflow: 'hidden'}}>
                            {/* Header */}
                            <div style={{background: 'var(--bg-secondary)', padding: '16px', borderBottom: '1px solid var(--border)'}}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '8px'}}>
                                    <div>
                                        <h3 style={{fontSize: '16px', fontWeight: '600', margin: 0}}>
                                            NF-e {nfeData.numero}
                                        </h3>
                                        <div style={{fontSize: '13px', color: 'var(--text-secondary)', marginTop: '4px'}}>
                                            {nfeData.cliente?.nome || 'Sem nome'} | {nfeData.dataEmissao || '-'}
                                        </div>
                                    </div>
                                    <span className={`badge ${nfeData.tipo === 'E' ? 'badge-success' : 'badge-danger'}`} style={{fontSize: '12px'}}>
                                        {nfeData.tipo === 'E' ? 'Entrada' : 'Saída'}
                                    </span>
                                </div>
                            </div>

                            {/* Items table */}
                            <div style={{overflowX: 'auto'}}>
                                <table className="table" style={{marginBottom: 0}}>
                                    <thead>
                                        <tr>
                                            <th style={{width: '40px'}}></th>
                                            <th>Produto NF</th>
                                            <th>Produto Estoque</th>
                                            <th style={{width: '80px'}}>Qtd</th>
                                            {isExit && <th style={{minWidth: '140px'}}>Estoque</th>}
                                            {(isEntry || (mode === 'both' && nfeData.tipo === 'E')) && <th>Local</th>}
                                            {(isEntry || (mode === 'both' && nfeData.tipo === 'E')) && <th>Categoria</th>}
                                            <th>Obs.</th>
                                            <th style={{width: '100px'}}>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {(nfeData.itens || []).map((item, idx) => {
                                            const st = itemStates[idx] || {};
                                            return (
                                                <tr key={idx} style={{opacity: st.alreadyRegistered && !st.selected ? 0.5 : 1}}>
                                                    <td>
                                                        <input type="checkbox" checked={!!st.selected}
                                                            onChange={e => updateItemState(idx, { selected: e.target.checked })} />
                                                    </td>
                                                    <td>
                                                        <div style={{fontWeight: '500', fontSize: '13px'}}>{item.descricao}</div>
                                                        <div style={{fontSize: '11px', color: 'var(--text-muted)'}}>
                                                            Cód: {item.codigo} | Qtd NF: {item.quantidade}
                                                        </div>
                                                    </td>
                                                    <td>
                                                        {st.linkedProduct ? (
                                                            <div>
                                                                <div style={{fontWeight: '500', fontSize: '13px'}}>{st.linkedProduct.name}</div>
                                                                <div style={{fontSize: '11px', color: 'var(--text-muted)'}}>SKU: {st.linkedSku}</div>
                                                                <button
                                                                    onClick={() => setShowVincularModal(idx)}
                                                                    style={{fontSize: '11px', color: 'var(--accent)', background: 'none', border: 'none', cursor: 'pointer', padding: 0, marginTop: '2px'}}>
                                                                    trocar
                                                                </button>
                                                            </div>
                                                        ) : (
                                                            <div style={{display: 'flex', gap: '4px'}}>
                                                                <button className="btn btn-secondary" style={{fontSize: '11px', padding: '2px 8px'}}
                                                                    onClick={() => setShowVincularModal(idx)}>
                                                                    Vincular
                                                                </button>
                                                                <button className="btn btn-secondary" style={{fontSize: '11px', padding: '2px 8px'}}
                                                                    onClick={() => {
                                                                        setNewProductData({
                                                                            name: item.descricao || '',
                                                                            sku: item.codigo || '',
                                                                            ean: '',
                                                                            category: '',
                                                                            observations: '',
                                                                        });
                                                                        setShowNewProductModal(idx);
                                                                    }}>
                                                                    Novo
                                                                </button>
                                                            </div>
                                                        )}
                                                    </td>
                                                    <td>
                                                        <input type="number" className="form-input" min="1"
                                                            value={st.quantity || ''}
                                                            onChange={e => updateItemState(idx, { quantity: parseInt(e.target.value) || 0 })}
                                                            style={{width: '70px', padding: '4px 8px', fontSize: '13px'}} />
                                                    </td>
                                                    {isExit && (
                                                        <td>
                                                            {st.linkedProduct ? (
                                                                <div>
                                                                    <label style={{display: 'flex', alignItems: 'center', gap: '4px', fontSize: '11px', cursor: 'pointer', marginBottom: '4px'}}>
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={!!st.baixarEstoque}
                                                                            onChange={e => updateItemState(idx, {
                                                                                baixarEstoque: e.target.checked,
                                                                                nfOrigem: e.target.checked ? st.nfOrigem : ''
                                                                            })}
                                                                        />
                                                                        Baixar estoque
                                                                    </label>
                                                                    {st.baixarEstoque && (() => {
                                                                        const nfsDisponiveis = getEstoquePorNF(st.linkedSku);
                                                                        return nfsDisponiveis.length > 0 ? (
                                                                            <div>
                                                                                <select
                                                                                    className="form-select"
                                                                                    value={st.nfOrigem || ''}
                                                                                    onChange={e => updateItemState(idx, { nfOrigem: e.target.value })}
                                                                                    style={{
                                                                                        fontSize: '10px',
                                                                                        padding: '4px 6px',
                                                                                        minWidth: '100px',
                                                                                        background: st.nfOrigem ? 'var(--accent-bg)' : 'white'
                                                                                    }}
                                                                                >
                                                                                    <option value="">Selecionar NF...</option>
                                                                                    {nfsDisponiveis.map((nf, nfIdx) => (
                                                                                        <option
                                                                                            key={nfIdx}
                                                                                            value={nf.nf}
                                                                                            disabled={nf.quantidade < st.quantity}
                                                                                        >
                                                                                            NF {nf.nf} ({nf.quantidade}un)
                                                                                        </option>
                                                                                    ))}
                                                                                </select>
                                                                                {st.nfOrigem && (() => {
                                                                                    const nfSel = nfsDisponiveis.find(n => n.nf === st.nfOrigem);
                                                                                    if (nfSel && st.quantity > nfSel.quantidade) {
                                                                                        return (
                                                                                            <div style={{fontSize: '10px', color: 'var(--danger)', marginTop: '2px'}}>
                                                                                                Qtd excede disponível ({nfSel.quantidade}un)
                                                                                            </div>
                                                                                        );
                                                                                    }
                                                                                    return null;
                                                                                })()}
                                                                            </div>
                                                                        ) : (
                                                                            <span style={{fontSize: '10px', color: 'var(--danger)'}}>
                                                                                Sem estoque registrado
                                                                            </span>
                                                                        );
                                                                    })()}
                                                                </div>
                                                            ) : (
                                                                <span style={{fontSize: '10px', color: 'var(--text-muted)', fontStyle: 'italic'}}>-</span>
                                                            )}
                                                        </td>
                                                    )}
                                                    {(isEntry || (mode === 'both' && nfeData.tipo === 'E')) && (
                                                        <td>
                                                            <select className="form-select"
                                                                value={st.localEntrada || ''}
                                                                onChange={e => updateItemState(idx, { localEntrada: e.target.value })}
                                                                style={{padding: '4px 8px', fontSize: '12px', minWidth: '120px'}}>
                                                                {(locaisOrigem || []).map(l => <option key={l} value={l}>{l}</option>)}
                                                            </select>
                                                        </td>
                                                    )}
                                                    {(isEntry || (mode === 'both' && nfeData.tipo === 'E')) && (
                                                        <td>
                                                            <div style={{display: 'flex', alignItems: 'center', gap: '4px'}}>
                                                                <select className="form-select"
                                                                    value={st.category || ''}
                                                                    onChange={e => updateItemState(idx, { category: e.target.value })}
                                                                    style={{padding: '4px 8px', fontSize: '12px', minWidth: '100px'}}>
                                                                    <option value="">Sem cat.</option>
                                                                    {(categories || []).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                                                </select>
                                                                {onAddCategory && (
                                                                    <button type="button"
                                                                        onClick={() => setShowInlineCatForm(true)}
                                                                        style={{padding: '4px 8px', fontSize: '13px', border: '1px solid var(--border)', borderRadius: 'var(--radius)', cursor: 'pointer', background: 'var(--bg-primary)', minWidth: 'auto'}}
                                                                        title="Criar nova categoria">+</button>
                                                                )}
                                                            </div>
                                                        </td>
                                                    )}
                                                    <td>
                                                        <input type="text" className="form-input" placeholder="Observações..."
                                                            value={st.observations || ''}
                                                            onChange={e => updateItemState(idx, { observations: e.target.value })}
                                                            style={{padding: '4px 8px', fontSize: '12px', minWidth: '100px'}} />
                                                    </td>
                                                    <td>
                                                        {st.alreadyRegistered ? (
                                                            <span className="badge badge-warning" style={{fontSize: '10px'}}>Já registrado</span>
                                                        ) : st.linkedProduct ? (
                                                            <span className="badge badge-success" style={{fontSize: '10px'}}>Vinculado</span>
                                                        ) : (
                                                            <span className="badge badge-danger" style={{fontSize: '10px'}}>Sem vínculo</span>
                                                        )}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>

                            {/* Action bar */}
                            <div style={{padding: '16px', borderTop: '1px solid var(--border)', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                <div style={{fontSize: '13px', color: 'var(--text-secondary)'}}>
                                    {itemStates.filter(s => s.selected && s.linkedSku).length} de {nfeData.itens?.length || 0} item(ns) selecionado(s)
                                </div>
                                <div style={{display: 'flex', gap: '8px'}}>
                                    <button className="btn btn-secondary" onClick={() => { setNfeData(null); setItemStates([]); }}>
                                        Cancelar
                                    </button>
                                    <button className="btn btn-primary" onClick={handleConfirm} disabled={saving}>
                                        {saving ? 'Registrando...' : (
                                            (isEntry || (mode === 'both' && nfeData.tipo === 'E'))
                                                ? 'Registrar Entrada'
                                                : 'Registrar Saída'
                                        )}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Mini-form criar categoria inline */}
                    {showInlineCatForm && onAddCategory && (
                        <div className="modal-overlay" onClick={() => setShowInlineCatForm(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()} style={{maxWidth: '360px'}}>
                                <h3 style={{margin: '0 0 16px'}}>Nova Categoria</h3>
                                <div className="form-group">
                                    <label className="form-label">Nome *</label>
                                    <input className="form-input" value={newCatName} onChange={e => setNewCatName(e.target.value)} placeholder="Ex: Abajur, Pendentes..." />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Cor</label>
                                    <input type="color" value={newCatColor} onChange={e => setNewCatColor(e.target.value)} style={{width: '100%', height: '36px', border: '1px solid var(--border)', borderRadius: 'var(--radius)', cursor: 'pointer'}} />
                                </div>
                                <div className="btn-group" style={{marginTop: '16px'}}>
                                    <button className="btn btn-primary" onClick={handleInlineCreateCategory} disabled={!newCatName.trim()}>Criar</button>
                                    <button className="btn btn-secondary" onClick={() => { setShowInlineCatForm(false); setNewCatName(''); }}>Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Vincular Produto */}
                    {showVincularModal !== null && (
                        <div className="modal-overlay">
                            <div className="modal-content" style={{maxWidth: '600px'}}>
                                <h2 className="modal-title">Vincular Produto do Estoque</h2>
                                <p className="modal-subtitle">
                                    Produto da NF: <strong>{nfeData?.itens?.[showVincularModal]?.descricao}</strong>
                                </p>
                                <div style={{fontSize: '11px', color: 'var(--text-muted)', marginBottom: '16px'}}>
                                    Código NF: <code>{nfeData?.itens?.[showVincularModal]?.codigo}</code>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Buscar no estoque</label>
                                    <input type="text" className="form-input" placeholder="Digite nome, SKU ou EAN..."
                                        value={vincularSearch} onChange={e => setVincularSearch(e.target.value)} autoFocus />
                                </div>

                                <div style={{maxHeight: '300px', overflowY: 'auto', border: '1px solid var(--border)', borderRadius: 'var(--radius)', marginBottom: '16px'}}>
                                    {(stock || sortedProducts).filter(s => {
                                        if (!vincularSearch) return true;
                                        const search = vincularSearch.toLowerCase();
                                        return (s.name || '').toLowerCase().includes(search) ||
                                               (s.sku || '').toLowerCase().includes(search) ||
                                               (s.ean || '').toLowerCase().includes(search);
                                    }).map(s => (
                                        <div key={s.sku || s.id}
                                            onClick={() => handleVincular(showVincularModal, s.sku)}
                                            style={{padding: '12px', borderBottom: '1px solid var(--border)', cursor: 'pointer'}}
                                            onMouseEnter={e => e.currentTarget.style.background = 'var(--bg-primary)'}
                                            onMouseLeave={e => e.currentTarget.style.background = ''}>
                                            <div style={{fontWeight: '500', marginBottom: '4px'}}>{s.name}</div>
                                            <div style={{fontSize: '11px', color: 'var(--text-muted)'}}>
                                                SKU: <strong>{s.sku}</strong>
                                                {s.ean && ` | EAN: ${s.ean}`}
                                                {s.currentQuantity !== undefined && (
                                                    <span> | Estoque: <span style={{color: s.currentQuantity > 0 ? 'var(--success)' : 'var(--danger)'}}>{s.currentQuantity} un.</span></span>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="btn-group">
                                    <button className="btn btn-secondary" onClick={() => { setShowVincularModal(null); setVincularSearch(''); }}>
                                        Cancelar
                                    </button>
                                    <button className="btn btn-primary" onClick={() => {
                                        setNewProductData({
                                            name: nfeData?.itens?.[showVincularModal]?.descricao || '',
                                            sku: nfeData?.itens?.[showVincularModal]?.codigo || '',
                                            ean: '', category: '', observations: '',
                                        });
                                        setShowNewProductModal(showVincularModal);
                                        setShowVincularModal(null);
                                        setVincularSearch('');
                                    }}>
                                        Cadastrar Novo Produto
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Novo Produto */}
                    {showNewProductModal !== null && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h2 className="modal-title">Cadastrar Novo Produto</h2>
                                <div className="form-group">
                                    <label className="form-label">Nome *</label>
                                    <input type="text" className="form-input" value={newProductData.name}
                                        onChange={e => setNewProductData({...newProductData, name: e.target.value})} />
                                </div>
                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">SKU *</label>
                                        <input type="text" className="form-input" value={newProductData.sku}
                                            onChange={e => setNewProductData({...newProductData, sku: e.target.value})} />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">EAN</label>
                                        <input type="text" className="form-input" value={newProductData.ean}
                                            onChange={e => setNewProductData({...newProductData, ean: e.target.value})} />
                                    </div>
                                </div>
                                {onAddCategory ? (
                                    <CategorySelectInline
                                        categories={categories}
                                        value={newProductData.category}
                                        onChange={(val) => setNewProductData({...newProductData, category: val})}
                                        onAddCategory={onAddCategory}
                                        onUpdateCategory={onUpdateCategory}
                                        onDeleteCategory={onDeleteCategory}
                                        products={stock}
                                    />
                                ) : (
                                    <div className="form-group">
                                        <label className="form-label">Categoria *</label>
                                        <select className="form-select" value={newProductData.category}
                                            onChange={e => setNewProductData({...newProductData, category: e.target.value})}>
                                            <option value="">Selecione...</option>
                                            {(categories || []).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                        </select>
                                    </div>
                                )}
                                <div className="form-group">
                                    <label className="form-label">Observações</label>
                                    <input type="text" className="form-input" value={newProductData.observations}
                                        onChange={e => setNewProductData({...newProductData, observations: e.target.value})} />
                                </div>
                                <div className="btn-group" style={{marginTop: '16px'}}>
                                    <button className="btn btn-primary" onClick={handleCreateProduct}>Cadastrar e Vincular</button>
                                    <button className="btn btn-secondary" onClick={() => setShowNewProductModal(null)}>Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ==========================================
        // PERIOD FILTER (componente reutilizável)
        // ==========================================
        function PeriodFilter({ periodFilter, setPeriodFilter, customMonth, setCustomMonth, customYear, setCustomYear }) {
            return (
                <div style={{
                    display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '16px',
                    flexWrap: 'wrap', padding: '10px 14px', background: '#f9f9f9', borderRadius: '8px'
                }}>
                    <span style={{ fontSize: '13px', color: '#555', fontWeight: 500 }}>Período:</span>
                    {[
                        { value: '30', label: '30 dias' },
                        { value: '60', label: '60 dias' },
                        { value: '90', label: '90 dias' },
                        { value: 'all', label: 'Todos' },
                    ].map(opt => (
                        <button
                            key={opt.value}
                            onClick={() => setPeriodFilter(opt.value)}
                            style={{
                                padding: '5px 12px', fontSize: '12px', borderRadius: '6px', cursor: 'pointer',
                                border: periodFilter === opt.value ? '1px solid var(--accent-primary)' : '1px solid #ddd',
                                background: periodFilter === opt.value ? 'var(--accent-primary)' : 'white',
                                color: periodFilter === opt.value ? 'white' : '#333',
                                fontWeight: periodFilter === opt.value ? 600 : 400,
                            }}
                        >
                            {opt.label}
                        </button>
                    ))}
                    <span style={{ color: '#ddd' }}>|</span>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                        <select
                            value={customMonth}
                            onChange={e => { setCustomMonth(parseInt(e.target.value)); setPeriodFilter('custom'); }}
                            className="form-select"
                            style={{ fontSize: '12px', padding: '5px 8px', minWidth: 'auto', width: 'auto' }}
                        >
                            {['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro']
                                .map((m, i) => <option key={i} value={i}>{m}</option>)}
                        </select>
                        <select
                            value={customYear}
                            onChange={e => { setCustomYear(parseInt(e.target.value)); setPeriodFilter('custom'); }}
                            className="form-select"
                            style={{ fontSize: '12px', padding: '5px 8px', minWidth: 'auto', width: 'auto' }}
                        >
                            {[2024, 2025, 2026].map(y => <option key={y} value={y}>{y}</option>)}
                        </select>
                    </div>
                </div>
            );
        }

        // Função auxiliar: filtrar itens por período
        function filterByPeriod(items, periodFilter, customMonth, customYear, dateField) {
            if (periodFilter === 'all') return items;
            if (periodFilter === 'custom') {
                const startDate = new Date(customYear, customMonth, 1);
                const endDate = new Date(customYear, customMonth + 1, 0, 23, 59, 59);
                return items.filter(item => {
                    const d = new Date(item[dateField]);
                    return d >= startDate && d <= endDate;
                });
            }
            const days = parseInt(periodFilter);
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days);
            return items.filter(item => new Date(item[dateField]) >= startDate);
        }

        // Função auxiliar: formatar email de usuário
        function formatUserEmail(email) {
            if (!email) return '\u2014';
            return email.split('@')[0];
        }

        // ==========================================
        // HISTORY
        // ==========================================
        function History({ entries, exits, products, onUpdateEntry, onDeleteEntry, onUpdateExit, onDeleteExit, isStockAdmin }) {
            const [filter, setFilter] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');
            const [editingItem, setEditingItem] = useState(null);
            const [deleteConfirm, setDeleteConfirm] = useState(null);
            const [editForm, setEditForm] = useState({});
            const [saving, setSaving] = useState(false);
            const [periodFilter, setPeriodFilter] = useState('30');
            const [customMonth, setCustomMonth] = useState(new Date().getMonth());
            const [customYear, setCustomYear] = useState(new Date().getFullYear());

            const getProductName = (sku) => products.find(p => p.sku === sku)?.name || sku;

            const filtered = useMemo(() => {
                let items = [
                    ...entries.map(e => ({...e, movType: 'entry'})),
                    ...exits.map(e => ({...e, movType: 'exit'}))
                ];

                // Filtro por período
                items = filterByPeriod(items, periodFilter, customMonth, customYear, 'date');

                // Filtro por tipo
                if (filter !== 'all') {
                    items = items.filter(m => m.movType === filter);
                }

                // Filtro por busca
                if (searchTerm) {
                    const search = searchTerm.toLowerCase();
                    items = items.filter(m => {
                        const productName = getProductName(m.sku).toLowerCase();
                        return productName.includes(search) ||
                            (m.sku || '').toLowerCase().includes(search) ||
                            (m.nf || '').toLowerCase().includes(search) ||
                            (m.nfOrigem || '').toLowerCase().includes(search) ||
                            (m.supplier || '').toLowerCase().includes(search) ||
                            (m.client || '').toLowerCase().includes(search) ||
                            (m.localEntrada || '').toLowerCase().includes(search) ||
                            (m.userId || '').toLowerCase().includes(search);
                    });
                }

                items.sort((a, b) => new Date(b.date) - new Date(a.date));
                return items;
            }, [entries, exits, filter, searchTerm, periodFilter, customMonth, customYear]);

            const handleEdit = (m) => {
                setEditForm({
                    sku: m.sku || '',
                    quantity: m.quantity || 0,
                    supplier: m.supplier || '',
                    client: m.client || '',
                    nf: m.nf || '',
                    nfOrigem: m.nf_origem || m.nfOrigem || '',
                    localEntrada: m.local_entrada || m.localEntrada || '',
                    type: m.type || '',
                    date: m.date ? new Date(m.date).toISOString().slice(0, 16) : '',
                });
                setEditingItem(m);
            };

            const handleSave = async () => {
                if (!editingItem) return;
                setSaving(true);
                try {
                    if (editingItem.movType === 'entry') {
                        await onUpdateEntry(editingItem.id, {
                            sku: editForm.sku,
                            quantity: parseInt(editForm.quantity),
                            supplier: editForm.supplier,
                            nf: editForm.nf,
                            localEntrada: editForm.localEntrada,
                            type: editForm.type,
                            date: editForm.date ? new Date(editForm.date).toISOString() : undefined,
                        });
                    } else {
                        await onUpdateExit(editingItem.id, {
                            sku: editForm.sku,
                            quantity: parseInt(editForm.quantity),
                            client: editForm.client,
                            nf: editForm.nf,
                            nfOrigem: editForm.nfOrigem,
                            type: editForm.type,
                            date: editForm.date ? new Date(editForm.date).toISOString() : undefined,
                        });
                    }
                    setEditingItem(null);
                } catch (e) {
                    alert('Erro ao salvar: ' + e.message);
                }
                setSaving(false);
            };

            const handleDelete = async (m) => {
                try {
                    if (m.movType === 'entry') {
                        await onDeleteEntry(m.id);
                    } else {
                        await onDeleteExit(m.id);
                    }
                    setDeleteConfirm(null);
                } catch (e) {
                    alert('Erro ao excluir: ' + e.message);
                }
            };

            const sortedProducts = [...products].sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            return (
                <div>
                    <div className="page-header">
                        <h1 className="page-title">Histórico</h1>
                        <p className="page-subtitle">Movimentações de estoque</p>
                    </div>

                    {/* Modal de Edição */}
                    {editingItem && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h2 className="modal-title">Editar {editingItem.movType === 'entry' ? 'Entrada' : 'Saída'}</h2>
                                <p className="modal-subtitle">{getProductName(editingItem.sku)}</p>

                                <div className="form-group">
                                    <label className="form-label">Produto (SKU)</label>
                                    <select className="form-select" value={editForm.sku} onChange={e => setEditForm({...editForm, sku: e.target.value})}>
                                        <option value="">Selecione...</option>
                                        {sortedProducts.map(p => (
                                            <option key={p.sku} value={p.sku}>{p.name} ({p.sku})</option>
                                        ))}
                                    </select>
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">Quantidade</label>
                                        <input type="number" className="form-input" min="1" value={editForm.quantity} onChange={e => setEditForm({...editForm, quantity: e.target.value})} />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Tipo</label>
                                        <input type="text" className="form-input" value={editForm.type} onChange={e => setEditForm({...editForm, type: e.target.value})} />
                                    </div>
                                </div>

                                <div className="form-row">
                                    {editingItem.movType === 'entry' ? (
                                        <div className="form-group">
                                            <label className="form-label">Fornecedor</label>
                                            <input type="text" className="form-input" value={editForm.supplier} onChange={e => setEditForm({...editForm, supplier: e.target.value})} />
                                        </div>
                                    ) : (
                                        <div className="form-group">
                                            <label className="form-label">Cliente</label>
                                            <input type="text" className="form-input" value={editForm.client} onChange={e => setEditForm({...editForm, client: e.target.value})} />
                                        </div>
                                    )}
                                    <div className="form-group">
                                        <label className="form-label">NF</label>
                                        <input type="text" className="form-input" value={editForm.nf} onChange={e => setEditForm({...editForm, nf: e.target.value})} />
                                    </div>
                                </div>

                                {editingItem.movType === 'entry' && (
                                    <div className="form-group">
                                        <label className="form-label">Local de Entrada</label>
                                        <input type="text" className="form-input" value={editForm.localEntrada} onChange={e => setEditForm({...editForm, localEntrada: e.target.value})} />
                                    </div>
                                )}

                                {editingItem.movType === 'exit' && (
                                    <div className="form-group">
                                        <label className="form-label">NF Origem</label>
                                        <input type="text" className="form-input" value={editForm.nfOrigem} onChange={e => setEditForm({...editForm, nfOrigem: e.target.value})} />
                                    </div>
                                )}

                                <div className="form-group">
                                    <label className="form-label">Data</label>
                                    <input type="datetime-local" className="form-input" value={editForm.date} onChange={e => setEditForm({...editForm, date: e.target.value})} />
                                </div>

                                <div className="btn-group" style={{marginTop: '20px'}}>
                                    <button className="btn btn-primary" onClick={handleSave} disabled={saving}>
                                        {saving ? 'Salvando...' : 'Salvar'}
                                    </button>
                                    <button className="btn btn-secondary" onClick={() => setEditingItem(null)}>Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal de Confirmação de Exclusão */}
                    {deleteConfirm && (
                        <div className="modal-overlay">
                            <div className="modal-content" style={{maxWidth: '400px'}}>
                                <h2 className="modal-title">Confirmar Exclusão</h2>
                                <p style={{margin: '16px 0', fontSize: '14px'}}>
                                    Excluir esta {deleteConfirm.movType === 'entry' ? 'entrada' : 'saída'}?
                                </p>
                                <div style={{padding: '12px', background: 'var(--bg-secondary)', borderRadius: 'var(--radius)', marginBottom: '16px', fontSize: '13px'}}>
                                    <div><strong>{getProductName(deleteConfirm.sku)}</strong></div>
                                    <div>Qtd: {deleteConfirm.quantity} | NF: {deleteConfirm.nf || '-'}</div>
                                    <div>{new Date(deleteConfirm.date).toLocaleDateString('pt-BR')}</div>
                                </div>
                                <div className="btn-group">
                                    <button className="btn" style={{background: 'var(--danger)', color: '#fff'}} onClick={() => handleDelete(deleteConfirm)}>Excluir</button>
                                    <button className="btn btn-secondary" onClick={() => setDeleteConfirm(null)}>Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="card">
                        <div className="search-box" style={{marginBottom: '16px'}}>
                            <span className="search-icon"><Icon name="search" size={14} /></span>
                            <input
                                type="text"
                                className="search-input"
                                placeholder="Buscar por produto, SKU, NF, cliente, fornecedor ou local..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                            {searchTerm && (
                                <button
                                    onClick={() => setSearchTerm('')}
                                    style={{
                                        position: 'absolute',
                                        right: '12px',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        background: 'none',
                                        border: 'none',
                                        cursor: 'pointer',
                                        fontSize: '16px',
                                        color: 'var(--text-muted)'
                                    }}
                                ><Icon name="close" size={12} /></button>
                            )}
                        </div>

                        <div className="filter-tabs" style={{marginBottom: '12px'}}>
                            <button className={`filter-tab ${filter === 'all' ? 'active' : ''}`} onClick={() => setFilter('all')}>
                                Todas
                            </button>
                            <button className={`filter-tab ${filter === 'entry' ? 'active' : ''}`} onClick={() => setFilter('entry')}>
                                Entradas
                            </button>
                            <button className={`filter-tab ${filter === 'exit' ? 'active' : ''}`} onClick={() => setFilter('exit')}>
                                Saídas
                            </button>
                        </div>

                        <PeriodFilter
                            periodFilter={periodFilter} setPeriodFilter={setPeriodFilter}
                            customMonth={customMonth} setCustomMonth={setCustomMonth}
                            customYear={customYear} setCustomYear={setCustomYear}
                        />

                        {(searchTerm || periodFilter !== 'all') && (
                            <div style={{
                                padding: '8px 12px',
                                background: 'var(--accent-bg)',
                                borderRadius: 'var(--radius)',
                                marginBottom: '16px',
                                fontSize: '13px',
                                color: 'var(--accent)'
                            }}>
                                {filtered.length} resultado(s){searchTerm ? ` para "${searchTerm}"` : ''}
                            </div>
                        )}

                        {filtered.length === 0 ? (
                            <div className="empty-state">
                                <div className="empty-state-icon"><Icon name="clipboard" size={48} /></div>
                                <h3>{searchTerm ? 'Nenhuma movimentação encontrada' : 'Nenhuma movimentação'}</h3>
                                {searchTerm && <p>Tente buscar por outro termo</p>}
                            </div>
                        ) : (
                            <div className="table-container">
                                <table className="table">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Tipo</th>
                                            <th>Produto</th>
                                            <th>Qtd</th>
                                            <th>Local</th>
                                            <th>Info</th>
                                            <th>Usuário</th>
                                            {isStockAdmin && <th style={{width: '80px'}}></th>}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filtered.slice(0, 100).map((m, i) => (
                                            <tr key={m.id || i}>
                                                <td style={{whiteSpace: 'nowrap'}}>
                                                    {new Date(m.date).toLocaleDateString('pt-BR')}
                                                    <div style={{fontSize: '11px', color: 'var(--text-muted)'}}>
                                                        {new Date(m.date).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                                                    </div>
                                                </td>
                                                <td>
                                                    <span className={`badge ${m.movType === 'entry' ? 'badge-success' : 'badge-danger'}`}>
                                                        {m.movType === 'entry' ? '↓ Entrada' : '↑ Saída'}
                                                    </span>
                                                </td>
                                                <td style={{maxWidth: '300px'}}>
                                                    <div style={{fontWeight: '500'}}>{getProductName(m.sku)}</div>
                                                    <div style={{fontSize: '10px', color: 'var(--text-muted)'}}>SKU: {m.sku}</div>
                                                </td>
                                                <td style={{fontWeight: '600'}}>{m.quantity}</td>
                                                <td style={{fontSize: '12px'}}>
                                                    {m.localEntrada && (
                                                        <span style={{
                                                            background: 'var(--accent-bg)',
                                                            color: 'var(--accent)',
                                                            padding: '2px 8px',
                                                            borderRadius: '12px',
                                                            fontSize: '11px'
                                                        }}>
                                                            {m.localEntrada}
                                                        </span>
                                                    )}
                                                </td>
                                                <td style={{fontSize: '12px', color: 'var(--text-muted)'}}>
                                                    {m.supplier || m.client || '-'}
                                                    {m.nf && <div style={{marginTop: '2px'}}><strong>NF: {m.nf}</strong></div>}
                                                    {m.nfOrigem && <div style={{marginTop: '2px', color: 'var(--warning)'}}>Saída da NF: {m.nfOrigem}</div>}
                                                </td>
                                                <td style={{fontSize: '12px', color: 'var(--text-secondary)', whiteSpace: 'nowrap'}}>
                                                    {formatUserEmail(m.userId)}
                                                </td>
                                                {isStockAdmin && (<td>
                                                    <div style={{display: 'flex', gap: '4px'}}>
                                                        <button className="btn btn-icon btn-secondary" onClick={() => handleEdit(m)} title="Editar" style={{padding: '4px 6px'}}>
                                                            <Icon name="edit" size={13} />
                                                        </button>
                                                        <button className="btn btn-icon btn-secondary" onClick={() => setDeleteConfirm(m)} title="Excluir" style={{padding: '4px 6px'}}>
                                                            <Icon name="delete" size={13} />
                                                        </button>
                                                    </div>
                                                </td>)}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ==========================================
        // TINY ERP INTEGRATION PAGE
        // ==========================================
        function TinyERPPage({ user, onDataChanged, products, entries, exits, stock, onAddEntry, onAddExit, onAddProduct, categories, locaisOrigem, onUpdateLocais, onAddCategory, onUpdateCategory, onDeleteCategory }) {
            const [activeSection, setActiveSectionRaw] = useState(() => {
                try { const s = sessionStorage.getItem('tiny_activeSection'); return (s && s !== 'nfe') ? s : 'config'; } catch(e) { return 'config'; }
            });
            const setActiveSection = (section) => {
                setActiveSectionRaw(section);
                try { sessionStorage.setItem('tiny_activeSection', section); } catch(e) {}
            };
            const [clientId, setClientId] = useState('');
            const [clientSecret, setClientSecret] = useState('');
            const [status, setStatus] = useState(() => {
                try { const c = sessionStorage.getItem('tiny_status'); return c ? JSON.parse(c) : null; } catch(e) { return null; }
            });
            const [statusLoading, setStatusLoading] = useState(() => {
                try { return !sessionStorage.getItem('tiny_status'); } catch(e) { return true; }
            });
            const [loading, setLoading] = useState(false);
            const [testResult, setTestResult] = useState(null);
            const [syncLogs, setSyncLogs] = useState(() => {
                try { const c = sessionStorage.getItem('tiny_syncLogs'); return c ? JSON.parse(c) : []; } catch(e) { return []; }
            });
            const [syncProgress, setSyncProgress] = useState(null);
            const [syncLock, setSyncLock] = useState(false);
            const [histPeriodFilter, setHistPeriodFilter] = useState('30');
            const [histCustomMonth, setHistCustomMonth] = useState(new Date().getMonth());
            const [histCustomYear, setHistCustomYear] = useState(new Date().getFullYear());
            const [nfeDateFrom, setNfeDateFrom] = useState('');
            const [nfeDateTo, setNfeDateTo] = useState('');
            const [nfeNumber, setNfeNumber] = useState('');

            const FUNC_BASE = `${SUPABASE_URL}/functions/v1`;

            const getAuthHeaders = async () => {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) throw new Error('Sessão expirada. Faça login novamente.');
                return {
                    'Authorization': `Bearer ${session.access_token}`,
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_ANON_KEY,
                };
            };

            const callFunction = async (name, body) => {
                const headers = await getAuthHeaders();
                const res = await fetch(`${FUNC_BASE}/${name}`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body),
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.error || `Erro ${res.status}`);
                }
                return await res.json();
            };

            // Load status on mount + retomar polling se sync estava running + cleanup stuck syncs
            useEffect(() => {
                loadStatus();
                loadSyncLogs();

                // Auto-cleanup: limpar syncs stuck (>5 min com status running)
                supabaseClient.from('sync_log')
                    .update({ status: 'error', message: 'Timeout — limpeza automática', finished_at: new Date().toISOString() })
                    .eq('status', 'running')
                    .lt('started_at', new Date(Date.now() - 5 * 60 * 1000).toISOString())
                    .then(() => loadSyncLogs());

                // Verificar se há um sync em andamento (backend pode estar rodando)
                (async () => {
                    const { data: runningLog } = await supabaseClient
                        .from('sync_log')
                        .select('id, status, message, items_synced, items_total, next_offset')
                        .eq('type', 'products')
                        .eq('status', 'running')
                        .order('started_at', { ascending: false })
                        .limit(1)
                        .maybeSingle();
                    if (runningLog) {
                        setSyncLock(true);
                        setSyncProgress({ type: 'products', status: 'running', message: runningLog.message || 'Sincronização em andamento...' });
                        // Iniciar polling
                        const pollInterval = setInterval(async () => {
                            const { data: log } = await supabaseClient
                                .from('sync_log')
                                .select('status, message')
                                .eq('id', runningLog.id)
                                .single();
                            if (!log || log.status === 'success') {
                                clearInterval(pollInterval);
                                setSyncLock(false);
                                setSyncProgress(log ? { type: 'products', status: 'success', message: log.message } : null);
                                await loadSyncLogs();
                                if (onDataChanged) await onDataChanged();
                            } else if (log.status === 'error') {
                                clearInterval(pollInterval);
                                setSyncLock(false);
                                setSyncProgress({ type: 'products', status: 'error', message: log.message });
                            } else {
                                setSyncProgress({ type: 'products', status: 'running', message: log.message || 'Sincronizando...' });
                            }
                        }, 3000);
                    }
                })();
            }, []);

            const loadStatus = async () => {
                try {
                    // Se já tem cache, não mostra loading (refresh silencioso)
                    if (!status) setStatusLoading(true);
                    const data = await callFunction('tiny-auth', { action: 'status' });
                    setStatus(data);
                    // Pré-preencher credenciais do config compartilhado
                    if (data.client_id && !clientId) setClientId(data.client_id);
                    if (data.client_secret && !clientSecret) setClientSecret(data.client_secret);
                    try { sessionStorage.setItem('tiny_status', JSON.stringify(data)); } catch(e) {}
                } catch (e) {
                    console.error('Failed to load Tiny status:', e);
                } finally {
                    setStatusLoading(false);
                }
            };

            const loadSyncLogs = async () => {
                try {
                    const { data, error } = await supabaseClient
                        .from('sync_log')
                        .select('*')
                        .order('started_at', { ascending: false })
                        .limit(50);
                    if (!error && data) {
                        setSyncLogs(data);
                        try { sessionStorage.setItem('tiny_syncLogs', JSON.stringify(data)); } catch(e) {}
                    }
                } catch (e) {
                    console.error('Failed to load sync logs:', e);
                }
            };

            const deleteSyncLog = async (logId) => {
                if (!confirm('Excluir este registro de sincronização?')) return;
                const { error } = await supabaseClient.from('sync_log').delete().eq('id', logId);
                if (error) { console.error('Erro ao excluir log:', error); alert('Erro ao excluir registro: ' + error.message); return; }
                await loadSyncLogs();
            };

            const handleConnect = async () => {
                if (!clientId || !clientSecret) return;
                setLoading(true);
                try {
                    // Redirect URI fixo: sempre produção (registrado no app Tiny)
                    const redirectUri = 'https://orne-estoque.vercel.app/tiny-callback';

                    const data = await callFunction('tiny-auth', {
                        action: 'get_auth_url',
                        client_id: clientId,
                        client_secret: clientSecret,
                        redirect_uri: redirectUri,
                    });

                    if (data.url) {
                        // Store redirect_uri for the callback
                        localStorage.setItem('tiny_redirect_uri', redirectUri);
                        // Open Tiny authorization page
                        window.open(data.url, 'tiny_auth', 'width=600,height=700');
                    } else {
                        alert(data.error || 'Erro ao gerar URL de autorização');
                    }
                } catch (e) {
                    alert('Erro: ' + e.message);
                } finally {
                    setLoading(false);
                }
            };

            // Listen for OAuth callback
            useEffect(() => {
                const handleMessage = async (event) => {
                    if (event.data?.type === 'tiny_oauth_callback' && event.data?.code) {
                        const redirectUri = localStorage.getItem('tiny_redirect_uri');
                        setLoading(true);
                        try {
                            const data = await callFunction('tiny-auth', {
                                action: 'exchange_code',
                                code: event.data.code,
                                redirect_uri: redirectUri,
                            });
                            if (data.success) {
                                await loadStatus();
                                setTestResult({ success: true, message: 'Conectado com sucesso!' });
                            } else {
                                setTestResult({ success: false, message: data.error || 'Falha na autorização' });
                            }
                        } catch (e) {
                            setTestResult({ success: false, message: e.message });
                        } finally {
                            setLoading(false);
                        }
                    }
                };

                window.addEventListener('message', handleMessage);

                // Also check URL params (in case callback came to this window)
                const params = new URLSearchParams(window.location.search);
                const code = params.get('code');
                if (code && window.location.pathname === '/tiny-callback') {
                    window.opener?.postMessage({ type: 'tiny_oauth_callback', code }, '*');
                    window.close();
                }

                return () => window.removeEventListener('message', handleMessage);
            }, []);

            const handleSaveConfig = async () => {
                if (!clientId || !clientSecret) return;
                setLoading(true);
                try {
                    const data = await callFunction('tiny-auth', {
                        action: 'save_config',
                        client_id: clientId,
                        client_secret: clientSecret,
                    });
                    if (data.success) {
                        await loadStatus();
                        setTestResult({ success: true, message: 'Credenciais salvas!' });
                    } else {
                        setTestResult({ success: false, message: data.error });
                    }
                } catch (e) {
                    setTestResult({ success: false, message: e.message });
                } finally {
                    setLoading(false);
                }
            };

            const handleTestConnection = async () => {
                setLoading(true);
                setTestResult(null);
                try {
                    const data = await callFunction('tiny-auth', { action: 'test' });
                    setTestResult({
                        success: data.connected,
                        message: data.connected ? 'Conexão OK! API respondendo.' : (data.error || 'Falha na conexão'),
                    });
                } catch (e) {
                    setTestResult({ success: false, message: e.message });
                } finally {
                    setLoading(false);
                }
            };

            const handleDisconnect = async () => {
                if (!confirm('Desconectar do Tiny ERP?')) return;
                setLoading(true);
                try {
                    await callFunction('tiny-auth', { action: 'disconnect' });
                    await loadStatus();
                    setTestResult(null);
                } catch (e) {
                    alert('Erro: ' + e.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleSync = async (type) => {
                if (syncLock) return; // Já tem sync rodando — impede race condition
                setSyncLock(true);
                setSyncProgress({ type, status: 'running' });
                try {
                    if (type === 'products') {
                        // UMA chamada inicia o sync — o backend continua sozinho
                        setSyncProgress({ type, status: 'running', message: 'Iniciando sincronização...' });
                        const data = await callFunction('tiny-sync-products', {});
                        if (!data.success) throw new Error(data.error || 'Erro na sincronização');

                        const logId = data.log_id;
                        if (!logId) {
                            // Fallback se não retornou log_id
                            setSyncProgress({ type, status: 'success', message: `${data.synced} produtos sincronizados.` });
                        } else {
                            // Polling do sync_log — backend continua independentemente
                            let finished = data.finished;
                            while (!finished) {
                                await new Promise(r => setTimeout(r, 3000));
                                const { data: log } = await supabaseClient
                                    .from('sync_log')
                                    .select('status, message, items_synced, items_total, next_offset')
                                    .eq('id', logId)
                                    .single();
                                if (!log) break;
                                setSyncProgress({ type, status: 'running', message: log.message || 'Sincronizando...' });
                                if (log.status === 'success') {
                                    finished = true;
                                    setSyncProgress({ type, status: 'success', message: log.message });
                                } else if (log.status === 'error') {
                                    throw new Error(log.message || 'Erro na sincronização');
                                }
                                // status === 'running' → continua polling
                            }
                        }
                    } else if (type === 'stock') {
                        const data = await callFunction('tiny-sync-stock', {});
                        setSyncProgress({ type, status: data.success ? 'success' : 'error',
                            message: data.success ? `${data.adjustments || 0} ajustes realizados` : (data.error || 'Erro') });
                    } else if (type === 'nfe') {
                        const data = await callFunction('tiny-sync-nfe', {
                            date_from: nfeDateFrom || undefined,
                            date_to: nfeDateTo || undefined,
                            nf_number: nfeNumber || undefined,
                        });
                        setSyncProgress({ type, status: data.success ? 'success' : 'error',
                            message: data.success ? `${data.imported || 0} itens processados` : (data.error || 'Erro') });
                    }
                    await loadSyncLogs();
                    if (onDataChanged) await onDataChanged();
                } catch (e) {
                    let msg = e.message || 'Erro desconhecido';
                    if (msg.match(/401|não autorizado/i) || msg.match(/token.*expir/i) || msg.match(/reconecte/i)) {
                        msg = 'Sessão Tiny expirada. Vá na aba Conexão e clique "Autorizar via OAuth2" para reconectar.';
                    } else if (msg.match(/429/i)) {
                        msg = 'Limite de requisições atingido. Aguarde alguns minutos e tente novamente.';
                    } else if (msg.match(/5\d{2}/i)) {
                        msg = 'Erro no servidor Tiny. Tente novamente em alguns minutos.';
                    } else if (msg.match(/failed to fetch|network|rede/i)) {
                        msg = 'Erro de conexão. Verifique sua internet e tente novamente.';
                    }
                    setSyncProgress({ type, status: 'error', message: msg });
                } finally {
                    setSyncLock(false);
                }
            };

            const formatDate = (d) => {
                if (!d) return '-';
                return new Date(d).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            };

            const tabStyle = (tab) => ({
                padding: '8px 16px',
                fontSize: '13px',
                fontWeight: activeSection === tab ? '600' : '400',
                color: activeSection === tab ? 'var(--accent)' : 'var(--text-secondary)',
                borderBottom: activeSection === tab ? '2px solid var(--accent)' : '2px solid transparent',
                cursor: 'pointer',
                background: 'none',
                border: 'none',
                borderBottomWidth: '2px',
                borderBottomStyle: 'solid',
                borderBottomColor: activeSection === tab ? 'var(--accent)' : 'transparent',
            });

            const cardStyle = {
                background: 'var(--bg-secondary)',
                border: '1px solid var(--border)',
                borderRadius: 'var(--radius-md)',
                padding: '24px',
                marginBottom: '16px',
            };

            return (
                <div>
                    <div className="page-header" style={{marginBottom: '24px'}}>
                        <div className="page-header-flex">
                            <div>
                                <h1 className="page-title">Tiny ERP</h1>
                                <p className="page-subtitle">Integração e sincronização com Tiny ERP (Olist)</p>
                            </div>
                            {statusLoading ? (
                                <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                    <span className="spinner" style={{width: '14px', height: '14px'}}></span>
                                    <span style={{fontSize: '13px', color: 'var(--text-muted)', fontWeight: '500'}}>Verificando...</span>
                                </div>
                            ) : status?.connected && (
                                <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                    <span style={{width: '8px', height: '8px', borderRadius: '50%', background: 'var(--success)', display: 'inline-block'}}></span>
                                    <span style={{fontSize: '13px', color: 'var(--success)', fontWeight: '500'}}>Conectado</span>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Tabs */}
                    <div style={{display: 'flex', gap: '0', borderBottom: '1px solid var(--border)', marginBottom: '24px'}}>
                        <button style={tabStyle('config')} onClick={() => setActiveSection('config')}>Configuração</button>
                        <button style={tabStyle('sync')} onClick={() => setActiveSection('sync')}>Sincronização</button>
                        <button style={tabStyle('history')} onClick={() => setActiveSection('history')}>Histórico</button>
                    </div>

                    {/* === CONFIG TAB === */}
                    {activeSection === 'config' && (
                        <div>
                            {/* Status card */}
                            <div style={cardStyle}>
                                <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px'}}>
                                    <div style={{width: '40px', height: '40px', borderRadius: 'var(--radius-sm)', background: statusLoading ? 'var(--bg-tertiary)' : status?.connected ? 'var(--success-light)' : 'var(--bg-tertiary)', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                                        {statusLoading
                                            ? <span className="spinner" style={{width: '20px', height: '20px'}}></span>
                                            : <Icon name={status?.connected ? 'check' : 'plug'} size={20} style={{color: status?.connected ? 'var(--success)' : 'var(--text-muted)'}} />
                                        }
                                    </div>
                                    <div>
                                        <div style={{fontWeight: '600', fontSize: '14px'}}>
                                            {statusLoading ? 'Verificando conexão...' : status?.connected ? 'Conectado ao Tiny ERP' : status?.token_expired ? 'Token expirado — reconecte' : status?.has_credentials ? 'Credenciais salvas, autorização pendente' : 'Não configurado'}
                                        </div>
                                        <div style={{fontSize: '12px', color: 'var(--text-muted)'}}>
                                            {statusLoading ? 'Carregando status da integração' : status?.connected ? `Token válido até ${formatDate(status.expires_at)}` : status?.token_expired ? 'Clique em "Autorizar via OAuth2" para reconectar' : 'Configure suas credenciais OAuth2 abaixo'}
                                        </div>
                                    </div>
                                </div>

                                {/* Info box */}
                                <div style={{background: 'var(--info-light)', border: '1px solid var(--accent-light)', borderRadius: 'var(--radius-sm)', padding: '12px 16px', marginBottom: '20px', fontSize: '12px', color: 'var(--text-secondary)'}}>
                                    <div style={{fontWeight: '600', marginBottom: '4px', color: 'var(--text-primary)'}}>
                                        <Icon name="info" size={14} style={{marginRight: '6px', verticalAlign: 'middle'}} />
                                        Como configurar
                                    </div>
                                    1. Acesse o Tiny ERP → Configurações → Geral → Aplicativos<br/>
                                    2. Crie um novo aplicativo com permissões de leitura para Produtos, Estoque e NF-e<br/>
                                    3. Copie o Client ID e Client Secret gerados e cole abaixo
                                </div>

                                {/* Credentials form */}
                                <div style={{display: 'grid', gap: '16px'}}>
                                    <div>
                                        <label className="form-label">Client ID</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            placeholder="Cole o Client ID do aplicativo Tiny"
                                            value={clientId}
                                            onChange={e => setClientId(e.target.value)}
                                        />
                                    </div>
                                    <div>
                                        <label className="form-label">Client Secret</label>
                                        <input
                                            type="password"
                                            className="form-input"
                                            placeholder="Cole o Client Secret"
                                            value={clientSecret}
                                            onChange={e => setClientSecret(e.target.value)}
                                        />
                                    </div>
                                </div>

                                {/* Actions */}
                                <div style={{display: 'flex', gap: '12px', marginTop: '20px', flexWrap: 'wrap'}}>
                                    <button className="btn btn-primary" onClick={handleConnect} disabled={loading || !clientId || !clientSecret}>
                                        {loading ? <Icon name="spinner" size={14} style={{animation: 'spin 1s linear infinite'}} /> : <Icon name="tiny" size={14} />}
                                        <span style={{marginLeft: '6px'}}>{loading ? 'Conectando...' : 'Autorizar via OAuth2'}</span>
                                    </button>
                                    <button className="btn btn-secondary" onClick={handleSaveConfig} disabled={loading || !clientId || !clientSecret}>
                                        <Icon name="check" size={14} />
                                        <span style={{marginLeft: '6px'}}>Salvar Credenciais</span>
                                    </button>
                                    {status?.connected && (
                                        <button className="btn btn-secondary" onClick={handleTestConnection} disabled={loading}>
                                            <Icon name="sync" size={14} />
                                            <span style={{marginLeft: '6px'}}>Testar Conexão</span>
                                        </button>
                                    )}
                                    {status?.has_token && (
                                        <button className="btn" style={{color: 'var(--danger)', border: '1px solid var(--danger)', background: 'transparent'}} onClick={handleDisconnect} disabled={loading}>
                                            <Icon name="close" size={14} />
                                            <span style={{marginLeft: '6px'}}>Desconectar</span>
                                        </button>
                                    )}
                                </div>

                                {/* Test result */}
                                {testResult && (
                                    <div style={{
                                        marginTop: '16px',
                                        padding: '12px 16px',
                                        borderRadius: 'var(--radius-sm)',
                                        background: testResult.success ? 'var(--success-light)' : 'var(--danger-light)',
                                        color: testResult.success ? 'var(--success-dark)' : 'var(--danger-dark)',
                                        fontSize: '13px',
                                        fontWeight: '500',
                                    }}>
                                        <Icon name={testResult.success ? 'success' : 'error'} size={14} style={{marginRight: '8px', verticalAlign: 'middle'}} />
                                        {testResult.message}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* === SYNC TAB === */}
                    {activeSection === 'sync' && (
                        <div>
                            {!status?.connected && (
                                <div style={{...cardStyle, textAlign: 'center', padding: '48px 24px'}}>
                                    <Icon name="plug" size={32} style={{color: 'var(--text-muted)', marginBottom: '12px'}} />
                                    <div style={{fontWeight: '600', fontSize: '14px', marginBottom: '4px'}}>Não conectado</div>
                                    <div style={{fontSize: '13px', color: 'var(--text-muted)', marginBottom: '16px'}}>Configure suas credenciais na aba Configuração primeiro.</div>
                                    <button className="btn btn-primary" onClick={() => setActiveSection('config')}>
                                        Ir para Configuração
                                    </button>
                                </div>
                            )}

                            {status?.connected && (
                                <div style={{display: 'grid', gap: '16px', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))'}}>
                                    {/* Products sync card */}
                                    <div style={cardStyle}>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '16px'}}>
                                            <div style={{width: '36px', height: '36px', borderRadius: 'var(--radius-sm)', background: 'var(--accent-bg)', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                                                <Icon name="stock" size={18} style={{color: 'var(--accent)'}} />
                                            </div>
                                            <div>
                                                <div style={{fontWeight: '600', fontSize: '14px'}}>Produtos</div>
                                                <div style={{fontSize: '12px', color: 'var(--text-muted)'}}>Importar catálogo do Tiny</div>
                                            </div>
                                        </div>
                                        <p style={{fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '16px'}}>
                                            Sincroniza produtos do Tiny ERP para o Orne Estoque. Produtos existentes são atualizados pelo SKU.
                                        </p>
                                        <button
                                            className="btn btn-primary"
                                            style={{width: '100%'}}
                                            onClick={() => handleSync('products')}
                                            disabled={syncLock}
                                        >
                                            {syncProgress?.type === 'products' && syncProgress?.status === 'running'
                                                ? <><Icon name="spinner" size={14} style={{animation: 'spin 1s linear infinite'}} /> <span style={{marginLeft: '6px'}}>Sincronizando...</span></>
                                                : <><Icon name="sync" size={14} /> <span style={{marginLeft: '6px'}}>Sincronizar Produtos</span></>
                                            }
                                        </button>
                                        {syncProgress?.type === 'products' && syncProgress?.status === 'running' && syncProgress?.message && (
                                            <div style={{
                                                marginTop: '8px',
                                                padding: '6px 10px',
                                                borderRadius: 'var(--radius-xs)',
                                                background: 'var(--accent-bg)',
                                                fontSize: '11px',
                                                color: 'var(--accent)',
                                                fontWeight: '500',
                                            }}>
                                                {syncProgress.message}
                                            </div>
                                        )}
                                        {syncProgress?.type === 'products' && syncProgress?.status !== 'running' && (
                                            <div style={{
                                                marginTop: '12px',
                                                padding: '8px 12px',
                                                borderRadius: 'var(--radius-xs)',
                                                background: syncProgress.status === 'success' ? 'var(--success-light)' : 'var(--danger-light)',
                                                fontSize: '12px',
                                                color: syncProgress.status === 'success' ? 'var(--success-dark)' : 'var(--danger-dark)',
                                            }}>
                                                {syncProgress.message}
                                            </div>
                                        )}
                                    </div>

                                    {/* Stock sync card */}
                                    <div style={cardStyle}>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '16px'}}>
                                            <div style={{width: '36px', height: '36px', borderRadius: 'var(--radius-sm)', background: 'var(--success-light)', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                                                <Icon name="chart" size={18} style={{color: 'var(--success)'}} />
                                            </div>
                                            <div>
                                                <div style={{fontWeight: '600', fontSize: '14px'}}>Estoque</div>
                                                <div style={{fontSize: '12px', color: 'var(--text-muted)'}}>Ajustar quantidades</div>
                                            </div>
                                        </div>
                                        <p style={{fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '16px'}}>
                                            Compara estoque do Tiny com o Orne e cria ajustes automáticos (entradas/saídas) para igualar.
                                        </p>
                                        <button
                                            className="btn btn-primary"
                                            style={{width: '100%'}}
                                            onClick={() => handleSync('stock')}
                                            disabled={syncLock}
                                        >
                                            {syncProgress?.type === 'stock' && syncProgress?.status === 'running'
                                                ? <><Icon name="spinner" size={14} style={{animation: 'spin 1s linear infinite'}} /> <span style={{marginLeft: '6px'}}>Sincronizando...</span></>
                                                : <><Icon name="sync" size={14} /> <span style={{marginLeft: '6px'}}>Sincronizar Estoque</span></>
                                            }
                                        </button>
                                        {syncProgress?.type === 'stock' && syncProgress?.status !== 'running' && (
                                            <div style={{
                                                marginTop: '12px',
                                                padding: '8px 12px',
                                                borderRadius: 'var(--radius-xs)',
                                                background: syncProgress.status === 'success' ? 'var(--success-light)' : 'var(--danger-light)',
                                                fontSize: '12px',
                                                color: syncProgress.status === 'success' ? 'var(--success-dark)' : 'var(--danger-dark)',
                                            }}>
                                                {syncProgress.message}
                                            </div>
                                        )}
                                    </div>

                                    {/* NF-e import removido — funcionalidade integrada em Entrada/Saída */}
                                </div>
                            )}
                        </div>
                    )}

                    {/* NF-e TAB removida — funcionalidade integrada em Entrada/Saída */}

                    {/* === HISTORY TAB === */}
                    {activeSection === 'history' && (() => {
                        const filteredLogs = filterByPeriod(syncLogs, histPeriodFilter, histCustomMonth, histCustomYear, 'started_at')
                            .sort((a, b) => new Date(b.started_at) - new Date(a.started_at));
                        return (
                        <div>
                            <div style={{display: 'flex', justifyContent: 'flex-end', marginBottom: '16px'}}>
                                <button className="btn btn-secondary" onClick={loadSyncLogs}>
                                    <Icon name="refresh" size={14} />
                                    <span style={{marginLeft: '6px'}}>Atualizar</span>
                                </button>
                            </div>

                            <PeriodFilter
                                periodFilter={histPeriodFilter} setPeriodFilter={setHistPeriodFilter}
                                customMonth={histCustomMonth} setCustomMonth={setHistCustomMonth}
                                customYear={histCustomYear} setCustomYear={setHistCustomYear}
                            />

                            {filteredLogs.length === 0 ? (
                                <div style={{...cardStyle, textAlign: 'center', padding: '48px 24px'}}>
                                    <Icon name="empty" size={32} style={{color: 'var(--text-muted)', marginBottom: '12px'}} />
                                    <div style={{fontWeight: '600', fontSize: '14px', marginBottom: '4px'}}>Nenhum registro</div>
                                    <div style={{fontSize: '13px', color: 'var(--text-muted)'}}>Os registros de sincronização aparecerão aqui.</div>
                                </div>
                            ) : (
                                <div className="table-container" style={{border: '1px solid var(--border)', borderRadius: 'var(--radius-md)', overflow: 'hidden'}}>
                                    <table className="table">
                                        <thead>
                                            <tr>
                                                <th>Tipo</th>
                                                <th>Status</th>
                                                <th>Itens</th>
                                                <th>Mensagem</th>
                                                <th>Início</th>
                                                <th>Fim</th>
                                                <th style={{width: '50px'}}></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredLogs.map(log => (
                                                <tr key={log.id}>
                                                    <td>
                                                        <span className={`badge ${log.type === 'products' ? 'badge-info' : log.type === 'stock' ? 'badge-success' : 'badge-purple'}`} style={log.type === 'nfe' ? {background: 'var(--purple-bg)', color: 'var(--purple)'} : {}}>
                                                            {log.type === 'products' ? 'Produtos' : log.type === 'stock' ? 'Estoque' : 'NF-e'}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span style={{
                                                            display: 'inline-flex',
                                                            alignItems: 'center',
                                                            gap: '4px',
                                                            fontSize: '12px',
                                                            fontWeight: '500',
                                                            color: log.status === 'success' ? 'var(--success)' : log.status === 'error' ? 'var(--danger)' : 'var(--warning)',
                                                        }}>
                                                            <Icon name={log.status === 'success' ? 'check' : log.status === 'error' ? 'error' : 'spinner'} size={12} />
                                                            {log.status === 'success' ? 'Sucesso' : log.status === 'error' ? 'Erro' : 'Em andamento'}
                                                        </span>
                                                    </td>
                                                    <td style={{fontSize: '13px', fontWeight: '500'}}>
                                                        {log.items_synced}/{log.items_total}
                                                    </td>
                                                    <td style={{fontSize: '12px', color: 'var(--text-secondary)', maxWidth: '300px'}}>
                                                        {log.message || '-'}
                                                    </td>
                                                    <td style={{fontSize: '12px', color: 'var(--text-muted)', whiteSpace: 'nowrap'}}>
                                                        {formatDate(log.started_at)}
                                                    </td>
                                                    <td style={{fontSize: '12px', color: 'var(--text-muted)', whiteSpace: 'nowrap'}}>
                                                        {formatDate(log.finished_at)}
                                                    </td>
                                                    <td>
                                                        <button className="btn btn-icon btn-secondary" onClick={() => deleteSyncLog(log.id)} title="Excluir" style={{padding: '4px 6px'}}>
                                                            <Icon name="delete" size={13} />
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                        );
                    })()}
                </div>
            );
        }

        // ==========================================
        // RENDER
        // ==========================================
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
